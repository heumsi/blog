<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-rh="true" property="keywords" content="Kubernetes,GPU"/><meta data-rh="true" property="og:image" content="/blog/static/0bdc53467872792b9bce63436a37572b/abd46/thumbnail.png"/><meta data-rh="true" property="og:description" content="GPU Operator부터 Binpack 스케줄러, OPA를 통한 검증, 모니터링까지"/><meta data-rh="true" property="og:title" content="Kubernetes에서 GPU 환경 셋업하기"/><meta data-rh="true" property="og:url" content="https://heumsi.github.io/blog/posts/setup-gpu-env-in-k8s/"/><meta data-rh="true" name="description" content="GPU Operator부터 Binpack 스케줄러, OPA를 통한 검증, 모니터링까지"/><meta data-rh="true" name="googlebot" content="index,follow"/><meta data-rh="true" name="robots" content="index,follow"/><meta data-rh="true" property="og:site_name" content="하나씩. 점을. 찍어나가며."/><meta data-rh="true" property="og:type" content="website"/><meta data-rh="true" name="twitter:creator" content="@handle"/><meta data-rh="true" name="twitter:site" content="@site"/><meta data-rh="true" name="twitter:card" content="summary_large_image"/><meta name="generator" content="Gatsby 4.17.2"/><style data-href="/blog/styles.202b843a3255cda52de9.css" data-identity="gatsby-global-css">/*! minireset.css v0.0.7 | MIT License | github.com/jgthms/minireset.css */blockquote,body,dd,dl,dt,fieldset,figure,h1,h2,h3,h4,h5,h6,hr,html,iframe,legend,li,ol,p,pre,textarea,ul{margin:0;padding:0}h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:400}ul{list-style:none}button,input,select{margin:0}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}img,video{height:auto;max-width:100%}iframe{border:0}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}code[class*=language-],pre[class*=language-]{background:#fafafa;color:#383a42;direction:ltr;font-family:Fira Code,Fira Mono,Menlo,Consolas,DejaVu Sans Mono,monospace;font-size:.95em;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#e5e5e6;color:inherit}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#e5e5e6;color:inherit}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.2em .3em;white-space:normal}.token.cdata,.token.comment,.token.prolog{color:#a0a1a7}.token.doctype,.token.entity,.token.punctuation{color:#383a42}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#b76b01}.token.keyword{color:#a626a4}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#e45649}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#50a14f}.token.function,.token.operator,.token.variable{color:#4078f2}.token.url{color:#0184bc}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#383a42}.language-css .token.selector{color:#e45649}.language-css .token.property{color:#383a42}.language-css .token.function,.language-css .token.url>.token.function{color:#0184bc}.language-css .token.url>.token.string.url{color:#50a14f}.language-css .token.atrule .token.rule,.language-css .token.important,.language-javascript .token.operator{color:#a626a4}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#ca1243}.language-json .token.operator{color:#383a42}.language-json .token.null.keyword{color:#b76b01}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#383a42}.language-markdown .token.url>.token.content{color:#4078f2}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#0184bc}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#a0a1a7;font-style:italic}.language-markdown .token.code-snippet{color:#50a14f}.language-markdown .token.bold .token.content{color:#b76b01}.language-markdown .token.italic .token.content{color:#a626a4}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e45649}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:rgba(56,58,66,.2)}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#e5e5e6;border-radius:.3em;color:#696c77;padding:.1em .4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#c6c7c7;color:#383a42}.line-highlight.line-highlight{background:rgba(56,58,66,.05)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#e5e5e6;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2);color:#383a42;padding:.1em .6em}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(56,58,66,.05)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:rgba(56,58,66,.2)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#9d9d9f}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e45649}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#50a14f}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#4078f2}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#a626a4}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:rgba(255,82,102,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:rgba(25,255,91,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(56,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:rgba(56,224,98,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:hsl(0,0,95%)}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:hsl(0,0,95%)}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:hsl(0,0,95%)}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#fff}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#383a42;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:#383a42}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}.gatsby-highlight-code-line{background-color:#eee;display:block;margin-left:-1em;margin-right:-1em;padding-left:1em;padding-right:1em}.gatsby-highlight{background:#fafafa;margin:0 0 1em;overflow:auto;padding:1em}.gatsby-highlight pre[class*=language-]{background-color:transparent;float:left;margin:0;min-width:100%;overflow:initial;padding:0}.toc{overflow-y:auto}.toc>.toc-list{overflow:hidden;position:relative}.toc>.toc-list li{list-style:none}.toc-list{margin:0;padding-left:10px}a.toc-link{color:currentColor;height:100%}.is-collapsible{max-height:1000px;overflow:hidden;transition:all .3s ease-in-out}.is-collapsed{max-height:0}.is-position-fixed{position:fixed!important;top:0}.is-active-link{font-weight:700}.toc-link:before{background-color:#eee;content:" ";display:inline-block;height:inherit;left:0;margin-top:-1px;position:absolute;width:2px}.is-active-link:before{background-color:#54bc4b}.toc{color:#333;font-size:.8em;left:0;line-height:1.8em;max-width:20rem;padding-left:1rem;position:fixed;top:50vh;transform:translateY(-50%);transition:all .4s cubic-bezier(.25,.8,.4,.95);visibility:visible;width:100%}.toc-list-item{font-weight:300}.is-active-link{font-weight:400}.toc-hidden{transform:translate(-100%,-50%);visibility:hidden}.toc-link:before{background-color:inherit}@media only screen and (max-width:85rem){.toc{visibility:hidden}}*{color:inherit;text-decoration:none}body{-ms-text-size-adjust:100%;-moz-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#333;font-size:1rem;word-break:break-all}h1{font-size:2.441em}h1,h2{font-weight:700}h2{font-size:1.953em}h3{font-size:1.563em}h3,h4{font-weight:700}h4{font-size:1.25em}li,p{font-size:1em;font-weight:400;line-height:1.8em}a{cursor:pointer}.container{font-family:sans-serif;margin:auto;max-width:45rem;width:100%}header{align-items:center;display:flex;justify-content:space-between;margin:1.5rem 0 1rem}header .site-title{font-weight:700;margin:0;transition:.33s}header .site-title:hover{color:#344cb7}header nav{display:flex;font-weight:400}header nav .nav-item a{padding-right:1.5rem;transition:.33s}header nav .nav-item a:hover{color:#344cb7}header nav .nav-item a:last-child{padding-right:0}.content .page-title{font-weight:500}.content .post-item{align-items:center;list-style:none;margin:2rem 0;transition:.33s}.content .post-item:hover{color:#344cb7}.content .post-item a{text-decoration:none}.content .post-item article{display:flex}.content .post-item-thumbnail{height:7rem;width:7rem}.content .post-item-desc{display:flex;flex-direction:column;height:7rem;margin-left:1.5rem}.content .post-item-title{font-weight:400;margin-top:0}.content .post-item-sub-title{line-height:1.4em;margin-top:.5rem}.content .post-item-meta{color:#666;font-size:.9em;line-height:1em;margin:auto 0 0}.content .post-cover-image{height:400px;left:50%;margin-bottom:2rem;margin-left:-50vw;margin-right:-50vw;max-width:100vw;position:relative;right:50%;width:100vw}.content .post-sub-title{color:#666;font-weight:400;margin-top:1rem}.content .post-meta{color:#666;display:block;margin-top:.5rem}.content .post-content{margin:3rem 0 5rem}.content .log-content{margin-top:1rem}.content .post-content h2,h3,h4{margin-top:2em}.content .post-content p{margin:1em 0}.content .post-content hr{background-color:#eee;border:0;height:1px;margin:2em}.content .post-content table{overflow-x:auto;width:100%}.content .post-content table th{background-color:#fafafa}.content .post-content table th,td{border:1px solid #ccc;padding:.5em}.content .log-content a,.content .post-content a{text-decoration:underline}.content .post-content>ul{margin:1em 0}.content .log-content ul li,.content .post-content ul li{list-style:outside;margin-left:1em}.content .log-content ul li p,.content .post-content ul li p{margin:0}.content .log-content ol li,.content .post-content ol li{margin-left:1em}.content .post-content .gatsby-resp-image-wrapper{margin:2em 0}.content .log-content .gatsby-resp-image-wrapper{margin:1em 0;margin-left:0!important;margin-right:0!important;max-width:100%!important}.content .log-content .gatsby-resp-image-wrapper+em,.content .post-content .gatsby-resp-image-wrapper+em{color:#999;display:block;font-size:.9em;font-style:normal;line-height:1.5em;margin:-1.5em auto 2em;max-width:90%;text-align:center}.content .log-content blockquote,.content .post-content blockquote{background:#f6f6f6;border-left:4px solid #e6e6e6;color:#666;margin:1rem 0;padding:1rem}.content .log-content blockquote code,.content .post-content blockquote code{color:#666}.content .log-content blockquote ol,.content .log-content blockquote p,.content .log-content blockquote ul,.content .post-content blockquote ol,.content .post-content blockquote p,.content .post-content blockquote ul{margin:1em 0}.content .log-content blockquote p:first-child,.content .log-content blockquote p:last-child,.content .post-content blockquote p:first-child,.content .post-content blockquote p:last-child{margin:0}.content .post-content .mermaid{margin:0 auto;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content}.content .log-item{line-height:1.8em;margin:2rem 0}.content .log-title span{cursor:pointer;font-size:.6em;margin-left:.6em;opacity:.6;transition:.33s}.content .log-title span:hover{opacity:1}.content .log-content a{text-decoration:underline}.content .log-datetime{color:#666;font-size:.9em}footer{align-items:center;color:#666;display:flex;justify-content:space-between;margin:3rem 0}footer .external-links li{display:inline-block;margin:0 .5rem;transition:.33s}footer .external-links li:hover{color:#344cb7}footer .copy-right{font-size:.9rem;text-align:right}@media screen and (max-width:800px){html{font-size:1rem}h1{font-size:1.749em}h1,h2{font-weight:700}h2{font-size:1.521em}h3{font-size:1.322em}h3,h4{font-weight:700}h4{font-size:1.15em}.container{padding:0 1rem}header .site-title{font-size:1rem}header nav .nav-item a{padding-right:1rem}.content .post-list .post-item{border-bottom:1px solid #ccc;margin:0 -1rem;padding:1rem}.content .post-list .post-item:last-child{border-bottom:none}.content .post-list .post-item a{text-decoration:none}.content .post-cover-image{margin-bottom:1.5rem}.content .page-title{font-size:1rem}.content .post-item-title{font-size:1.2rem}.content .post-item-thumbnail{display:none!important}.content .post-item-desc{height:-webkit-fit-content;height:-moz-fit-content;height:fit-content;margin-left:0}.content .post-item-meta{line-height:1.4em}footer{margin:1rem 0}}</style><link rel="preconnect" href="https://plausible.io"/><script async="" defer="" data-domain="heumsi.github.io/blog" src="https://plausible.io/js/plausible.js"></script><script>
          window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) };
          
          </script><title data-rh="true">Kubernetes에서 GPU 환경 셋업하기</title><link data-rh="true" rel="canonical" href="https://heumsi.github.io/blog/posts/setup-gpu-env-in-k8s/"/><script data-rh="true" defer="" src="https://cloud.umami.is/script.js" data-website-id="c247e343-b8cb-4751-8e13-8e8557a94875"></script><link rel="sitemap" type="application/xml" href="/blog/sitemap/sitemap-index.xml"/><link rel="alternate" type="application/rss+xml" title="하나씩 점을 찍어나가며 - Heumsi의 블로그 RSS" href="/blog/rss.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZRH97WV1XY"></script><script>
    window.GATSBY_GTAG_PLUGIN_GA_TRACKING_ID = (
      'G-ZRH97WV1XY'
    );
    window.GATSBY_GTAG_PLUGIN_ANONYMIZE = false;

    var options = {
      send_page_view: false
    };
    if (false) {
      options.anonymize_ip = true;
    }

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', 'G-ZRH97WV1XY', options);
  </script><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="container"><header><h3 class="site-title"><a href="/blog/">하나씩. 점을. 찍어나가며.</a></h3><nav><ul><li class="nav-item"><a class="nav-link-text" href="/blog/posts">글</a><a class="nav-link-text" href="/blog/logs">로그</a></li></ul></nav></header><main class="content"><section class="post-cover-image gbi-1021818738-dUx2BQtGLYRWpdVgH1QbGd" style="background-position:center;background-repeat:no-repeat;background-size:cover;position:relative"><style>
          .post-cover-image.gbi-1021818738-dUx2BQtGLYRWpdVgH1QbGd:before,
          .post-cover-image.gbi-1021818738-dUx2BQtGLYRWpdVgH1QbGd:after {
            content: '';
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            
            transition: opacity 0.5s ease 250ms;
            background-position: center;
background-repeat: no-repeat;
background-size: cover;

          }
          .post-cover-image.gbi-1021818738-dUx2BQtGLYRWpdVgH1QbGd:before {
            z-index: -100;
            
            
            opacity: 1; 
          }
          .post-cover-image.gbi-1021818738-dUx2BQtGLYRWpdVgH1QbGd:after {
            z-index: -101;
            
            
            
          }
        </style><noscript><style>
    .post-cover-image.gbi-1021818738-dUx2BQtGLYRWpdVgH1QbGd:before {
      opacity: 1;
      background-image: url('/blog/static/0bdc53467872792b9bce63436a37572b/abd46/thumbnail.png');
    }</style></noscript></section><h1 class="post-title">Kubernetes에서 GPU 환경 셋업하기</h1><h3 class="post-sub-title">GPU Operator부터 Binpack 스케줄러, OPA를 통한 검증, 모니터링까지</h3><p class="post-meta"><span>2022년 10월 9일</span> — <span>Kubernetes<!-- -->, <!-- -->GPU</span></p><div class="toc toc-hidden"></div><div class="post-content"><h2 id="들어가며" style="position:relative"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0" aria-label="들어가며 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>들어가며</h2><h3 id="배경" style="position:relative"><a href="#%EB%B0%B0%EA%B2%BD" aria-label="배경 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>배경</h3><p>지난 몇 달간 팀에서의 첫 정식 작업으로, 팀에서 운영하는 쿠버네티스에 GPU 환경 셋업하는 일을 담당했다.
팀에 합류하기 이전에는 그저 클라우드만 사용해봤었고, 쿠버네티스에서의 GPU 역시 클라우드에서 제공해주는 대로만 사용했던 터라, GPU 셋업에 대해 별로 생각해본적은 없었다.
그런데 이번에 온-프레미스 환경의 쿠버네티스를 처음 접해보며, GPU 셋업에 이런 컴포넌트들이 필요하구나 라는걸 처음 알게 되었다.</p><p>내가 작업해온 것들을 다시 하나씩 정리하며, 이번 글에서는 쿠버네티스에 GPU 노드를 추가한 이후에 GPU 환경을 셋업하는 방법과 과정에 대해 적어본다.
기본적으로 나를 위한 정리이긴 하지만, 나처럼 GPU 노드를 쿠버네티스 클러스터에서 사용하고자 하는 분들에게도 도움이 되면 좋겠다.</p><h3 id="작업-전-상황" style="position:relative"><a href="#%EC%9E%91%EC%97%85-%EC%A0%84-%EC%83%81%ED%99%A9" aria-label="작업 전 상황 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>작업 전 상황</h3><p>먼저 쿠버네티스 클러스터는 다음과 같은 상황이었다.</p><ul><li>이미 GPU 노드가 클러스터에 워커 노드로 추가가 되어있다.<ul><li><p>구체적으로 다음과 같았다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get nodes

node1   Ready    control-plane   46d   v1.24.4
node2   Ready    control-plane   46d   v1.24.4
node3   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          46d   v1.24.4
node4   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          46d   v1.24.4
node5   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          46d   v1.24.4
node6   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          46d   v1.24.4
node7   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          30d   v1.24.4</code></pre></div></li><li><p><code class="language-text">node5</code>, <code class="language-text">node6</code>, <code class="language-text">node7</code> 이 GPU 노드다.</p></li></ul></li><li>GPU 벤더는 Nvidia고, Nvidia GPU 드라이버가 노드에 이미 설치되어있다.</li><li>쿠버네티스 버전은 <code class="language-text">1.24.4</code> 이다.</li></ul><h3 id="요구사항" style="position:relative"><a href="#%EC%9A%94%EA%B5%AC%EC%82%AC%ED%95%AD" aria-label="요구사항 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>요구사항</h3><p>&quot;GPU 환경을 셋업&quot;을 좀 더 구체적인 요구사항으로 정리하면 다음과 같다.</p><ul><li>클러스터 사용자는 GPU를 사용할 수 있어야 한다.<ul><li>클러스터에 GPU 노드를 추가한다고 해서 사용자가 바로 GPU를 사용할 수 있는 건 아니다. 별도의 작업이 필요하다.</li></ul></li><li>GPU를 사용하는 파드는 Resource Binpack 알고리즘으로 스케줄링 되어야 한다.<ul><li>GPU는 비교적 비싼 자원이기 때문에, 클러스터 내 리소스 사용 효율을 높여야 한다.</li></ul></li><li>GPU 리소스 사용에 대한 모니터링이 가능해야 한다.<ul><li>어떤 네임스페이스에서, 어떤 파드가 얼마나 GPU 리소스를 사용하고 있는지,</li><li>어떤 GPU 노드들이 현재 가용한지 등의 내용을 쉽게 알 수 있어야 한다.</li></ul></li></ul><p>특히 우리 팀은 멀티 테넌트 환경의 클러스터이기 때문에, 사용자는 사용이 쉬워야하고, 관리자는 리소스 효율과 관리가 복잡해지지 않도록 특히 신경을 써야했다.</p><h2 id="gpu-operator로-gpu를-사용할-수-있게-하기" style="position:relative"><a href="#gpu-operator%EB%A1%9C-gpu%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%A0-%EC%88%98-%EC%9E%88%EA%B2%8C-%ED%95%98%EA%B8%B0" aria-label="gpu operator로 gpu를 사용할 수 있게 하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>GPU Operator로 GPU를 사용할 수 있게 하기</h2><h3 id="chart-다운-받기" style="position:relative"><a href="#chart-%EB%8B%A4%EC%9A%B4-%EB%B0%9B%EA%B8%B0" aria-label="chart 다운 받기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Chart 다운 받기</h3><p>위에서도 이야기했지만, 클러스터에 GPU 노드를 추가한다고 해서 사용자가 바로 GPU를 사용할 수 있는 건 아니다.
GPU를 노드에서 인식할 수 있도록 드라이버를 (없다면) 설치해야하고,
컨테이너 환경에서 GPU를 사용할 수 있게 무언가의 일들을 해야하며,
쿠버네티스 클러스터의 파드에서 GPU 리소스를 사용할 수 있도록 Device Plugin을 배포해야한다.</p><p>쿠버네티스에서는 이런 일련의 설치 및 배포 작업을 <a href="https://github.com/NVIDIA/gpu-operator">GPU Operator</a>를 통해 손쉽게 해결할 수 있다.
GPU Operator는 NVIDIA에서 제공하는 Operator로, 관련 CR을 배포하면 GPU 환경 셋업과 관련된 일련의 쿠버네티스 오브젝트들이 순차적으로 배포된다.
여기에 사용하는 CRD와 Operator는 사실상 Helm Chart를 통해서 제공된다.</p><p>GPU Operator Helm Chart를 다운 받아보자.
먼저 다음처럼 GPU Operator Helm Chart를 Local로 받아온다.</p><blockquote><p>여기서는 Helm 버전으로 <code class="language-text">v3.9.4</code> 를 사용하고 있다.</p></blockquote><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Add and update helm repo</span>
$ helm repo <span class="token function">add</span> nvidia https://helm.ngc.nvidia.com/nvidia
$ helm repo update

<span class="token comment"># Download helm chart</span>
$ helm pull nvidia/gpu-operator --untar

<span class="token comment"># Move to helm chart directory</span>
$ <span class="token builtin class-name">cd</span> gpu-operator</code></pre></div><p>내가 받은 Helm Chart의 버전은 <code class="language-text">v1.11.1</code> 이다.
Chart 버전에 내용이 달라질 수 있음을 인지해두자.</p><h3 id="chart-내부-살펴보기" style="position:relative"><a href="#chart-%EB%82%B4%EB%B6%80-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0" aria-label="chart 내부 살펴보기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Chart 내부 살펴보기</h3><p>Chart 내부를 살펴보면 이렇다.
(아래에서 추가 설명할 부분은 하이라이팅 해두었다.)</p><div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre class="language-bash"><code class="language-bash">$ tree -L <span class="token number">2</span>
<span class="token builtin class-name">.</span>
├── Chart.lock
├── Chart.yaml
├── charts
<span class="gatsby-highlight-code-line">│   └── node-feature-discovery</span>├── crds
<span class="gatsby-highlight-code-line">│   └── nvidia.com_clusterpolicies_crd.yaml</span>├── templates
│   ├── _helpers.tpl
<span class="gatsby-highlight-code-line">│   ├── clusterpolicy.yaml</span><span class="gatsby-highlight-code-line">│   ├── operator.yaml</span>│   ├── podsecuritypolicy.yaml
│   ├── readonlyfs_scc.openshift.yaml
│   ├── role.yaml
│   ├── rolebinding.yaml
│   └── serviceaccount.yaml
└── values.yaml</code></pre></div><p>Chart에 대해 간단히 살펴보면,</p><ul><li><code class="language-text">charts/node-feature-discovery</code> 가 존재한다는 것에서 알 수 있듯이, 이 Chart는 <code class="language-text">node-feature-discovery</code> Chart에 의존성이 있다.<ul><li><code class="language-text">node-feature-discovery</code> 가 이미 클러스터에 배포되어있다면 <code class="language-text">values.yaml</code> 에서 <code class="language-text">nfd.enabled</code> 값을 <code class="language-text">false</code> 로 수정하면 된다. (기본 값은 <code class="language-text">true</code> 다.)</li><li>여기서는 <code class="language-text">node-feature-discovery</code> 도 <code class="language-text">gpu-operator</code> Chart와 함께 배포하기로 한다.</li></ul></li><li><code class="language-text">crds/nvidia.com_clusterpolicies_crd.yaml</code> 에 <code class="language-text">ClusterPolicy</code> 라는 CRD가 존재한다.<ul><li><code class="language-text">templates/clusterpolicy.yaml</code> 에 이 CR이 포함되어 있다.</li></ul></li><li><code class="language-text">templates/operator.yaml</code> 를 통해 알 수 있듯이, GPU Operator의 동작 흐름은 <code class="language-text">ClusterPolicy</code> 라는 CR을 제출하면 Operator가 이를 모니터링하여 관련한 컴포넌트들을 띄우는 방식이다.</li><li><code class="language-text">ClusterPolicy</code> CRD에 이렇게 배포되는 컴포넌트들에 대해 정의가 되어있고, <code class="language-text">values.yaml</code> 에서 이를 조정할 수 있다.</li></ul><h3 id="컴포넌트들의-역할과-동작-과정" style="position:relative"><a href="#%EC%BB%B4%ED%8F%AC%EB%84%8C%ED%8A%B8%EB%93%A4%EC%9D%98-%EC%97%AD%ED%95%A0%EA%B3%BC-%EB%8F%99%EC%9E%91-%EA%B3%BC%EC%A0%95" aria-label="컴포넌트들의 역할과 동작 과정 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>컴포넌트들의 역할과 동작 과정</h3><div class="mermaid" data-processed="true"><svg viewBox="0 0 662.390625 758" style="max-width:662.390625px" height="758" aria-labelled-by="chart-title-mermaid-1736145204081,chart-desc-mermaid-1736145204081" role="img" xmlnsXLink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1736145204081"><title id="chart-title-mermaid-1736145204081"></title><desc id="chart-desc-mermaid-1736145204081"></desc><style>#mermaid-1736145204081 {font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1736145204081 .error-icon{fill:#552222;}#mermaid-1736145204081 .error-text{fill:#552222;stroke:#552222;}#mermaid-1736145204081 .edge-thickness-normal{stroke-width:2px;}#mermaid-1736145204081 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1736145204081 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1736145204081 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1736145204081 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1736145204081 .marker{fill:#333333;stroke:#333333;}#mermaid-1736145204081 .marker.cross{stroke:#333333;}#mermaid-1736145204081 svg{font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;font-size:16px;}#mermaid-1736145204081 .label{font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;color:#333;}#mermaid-1736145204081 .cluster-label text{fill:#333;}#mermaid-1736145204081 .cluster-label span{color:#333;}#mermaid-1736145204081 .label text,#mermaid-1736145204081 span{fill:#333;color:#333;}#mermaid-1736145204081 .node rect,#mermaid-1736145204081 .node circle,#mermaid-1736145204081 .node ellipse,#mermaid-1736145204081 .node polygon,#mermaid-1736145204081 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1736145204081 .node .label{text-align:center;}#mermaid-1736145204081 .node.clickable{cursor:pointer;}#mermaid-1736145204081 .arrowheadPath{fill:#333333;}#mermaid-1736145204081 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1736145204081 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1736145204081 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1736145204081 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1736145204081 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1736145204081 .cluster text{fill:#333;}#mermaid-1736145204081 .cluster span{color:#333;}#mermaid-1736145204081 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1736145204081 :root{--mermaid-font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;}</style><g transform="translate(0, 0)"><g class="output"><g class="clusters"></g><g class="edgePaths"><g style="opacity:1" id="L-Operator-CR" class="edgePath LS-Operator LE-CR"><path style="fill:none" marker-end="url(#arrowhead24)" d="M107.87029474431819,360L131.40753728693184,304.5C154.94477982954547,249,202.01926491477275,138,251.48879912405303,82.5C300.9583333333333,27,352.8229166666667,27,378.7552083333333,27L404.6875,27" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead24"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-Operator-NodeFeatureDiscoveryW" class="edgePath LS-Operator LE-NodeFeatureDiscoveryW"><path style="fill:none" marker-end="url(#arrowhead25)" d="M110.55622632575758,360L133.64581360479798,319.1666666666667C156.73540088383837,278.3333333333333,202.9145754419192,196.66666666666666,235.58228772095958,155.83333333333334C268.25,115,287.40625,115,296.984375,115L306.5625,115" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead25"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-Operator-NodeFeatureDiscoveryM" class="edgePath LS-Operator LE-NodeFeatureDiscoveryM"><path style="fill:none" marker-end="url(#arrowhead26)" d="M115.92808948863636,360L138.12236624053028,333.8333333333333C160.31664299242425,307.6666666666667,204.70519649621212,255.33333333333334,236.60129616477272,229.16666666666666C268.4973958333333,203,287.9010416666667,203,297.6028645833333,203L307.3046875,203" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead26"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-Operator-GPUFeatureDiscovery" class="edgePath LS-Operator LE-GPUFeatureDiscovery"><path style="fill:none" marker-end="url(#arrowhead27)" d="M132.04367897727272,360L151.55202414772728,348.5C171.06036931818184,337,210.0770596590909,314,244.10493607954547,302.5C278.1328125,291,307.171875,291,321.69140625,291L336.2109375,291" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead27"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-Operator-NvidiaDriverInstaller" class="edgePath LS-Operator LE-NvidiaDriverInstaller"><path style="fill:none" marker-end="url(#arrowhead28)" d="M191.625,379L201.203125,379C210.78125,379,229.9375,379,255.44270833333334,379C280.9479166666667,379,312.8020833333333,379,328.7291666666667,379L344.65625,379" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead28"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-Operator-NvidiaDevicePlugin" class="edgePath LS-Operator LE-NvidiaDevicePlugin"><path style="fill:none" marker-end="url(#arrowhead29)" d="M132.04367897727272,398L151.55202414772728,409.5C171.06036931818184,421,210.0770596590909,444,246.69608191287878,455.5C283.3151041666667,467,317.5364583333333,467,334.6471354166667,467L351.7578125,467" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead29"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-Operator-NvidiaContainerToolkit" class="edgePath LS-Operator LE-NvidiaContainerToolkit"><path style="fill:none" marker-end="url(#arrowhead30)" d="M115.92808948863636,398L138.12236624053028,424.1666666666667C160.31664299242425,450.3333333333333,204.70519649621212,502.6666666666667,241.49061908143938,528.8333333333334C278.2760416666667,555,307.4583333333333,555,322.0494791666667,555L336.640625,555" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead30"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-Operator-GPUOperatorValidator" class="edgePath LS-Operator LE-GPUOperatorValidator"><path style="fill:none" marker-end="url(#arrowhead31)" d="M110.55622632575758,398L133.64581360479798,438.8333333333333C156.73540088383837,479.6666666666667,202.9145754419192,561.3333333333334,240.54582938762624,602.1666666666666C278.1770833333333,643,307.2604166666667,643,321.8020833333333,643L336.34375,643" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead31"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-Operator-DCGMExporter" class="edgePath LS-Operator LE-DCGMExporter"><path style="fill:none" marker-end="url(#arrowhead32)" d="M107.87029474431819,398L131.40753728693184,453.5C154.94477982954547,509,202.01926491477275,620,244.67109079071972,675.5C287.3229166666667,731,325.5520833333333,731,344.6666666666667,731L363.78125,731" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead32"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g></g><g class="edgeLabels"><g style="opacity:1" transform="translate(249.09375,27)" class="edgeLabel"><g class="label" transform="translate(-29.796875,-9)"><rect height="18" width="59.59375" ry="0" rx="0"></rect><foreignObject height="18" width="59.59375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-Operator&#x27; L-LE-CR" id="L-L-Operator-CR">1. watch</span></div></foreignObject></g></g><g style="opacity:1" transform="translate(249.09375,115)" class="edgeLabel"><g class="label" transform="translate(-32.46875,-9)"><rect height="18" width="64.9375" ry="0" rx="0"></rect><foreignObject height="18" width="64.9375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-Operator&#x27; L-LE-NodeFeatureDiscoveryW" id="L-L-Operator-NodeFeatureDiscoveryW">2. deploy</span></div></foreignObject></g></g><g style="opacity:1" transform="translate(249.09375,203)" class="edgeLabel"><g class="label" transform="translate(-32.46875,-9)"><rect height="18" width="64.9375" ry="0" rx="0"></rect><foreignObject height="18" width="64.9375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-Operator&#x27; L-LE-NodeFeatureDiscoveryM" id="L-L-Operator-NodeFeatureDiscoveryM">2. deploy</span></div></foreignObject></g></g><g style="opacity:1" transform="translate(249.09375,291)" class="edgeLabel"><g class="label" transform="translate(-32.46875,-9)"><rect height="18" width="64.9375" ry="0" rx="0"></rect><foreignObject height="18" width="64.9375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-Operator&#x27; L-LE-GPUFeatureDiscovery" id="L-L-Operator-GPUFeatureDiscovery">3. deploy</span></div></foreignObject></g></g><g style="opacity:1" transform="translate(249.09375,379)" class="edgeLabel"><g class="label" transform="translate(-32.46875,-9)"><rect height="18" width="64.9375" ry="0" rx="0"></rect><foreignObject height="18" width="64.9375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-Operator&#x27; L-LE-NvidiaDriverInstaller" id="L-L-Operator-NvidiaDriverInstaller">3. deploy</span></div></foreignObject></g></g><g style="opacity:1" transform="translate(249.09375,467)" class="edgeLabel"><g class="label" transform="translate(-32.46875,-9)"><rect height="18" width="64.9375" ry="0" rx="0"></rect><foreignObject height="18" width="64.9375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-Operator&#x27; L-LE-NvidiaDevicePlugin" id="L-L-Operator-NvidiaDevicePlugin">3. deploy</span></div></foreignObject></g></g><g style="opacity:1" transform="translate(249.09375,555)" class="edgeLabel"><g class="label" transform="translate(-32.46875,-9)"><rect height="18" width="64.9375" ry="0" rx="0"></rect><foreignObject height="18" width="64.9375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-Operator&#x27; L-LE-NvidiaContainerToolkit" id="L-L-Operator-NvidiaContainerToolkit">3. deploy</span></div></foreignObject></g></g><g style="opacity:1" transform="translate(249.09375,643)" class="edgeLabel"><g class="label" transform="translate(-32.46875,-9)"><rect height="18" width="64.9375" ry="0" rx="0"></rect><foreignObject height="18" width="64.9375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-Operator&#x27; L-LE-GPUOperatorValidator" id="L-L-Operator-GPUOperatorValidator">3. deploy</span></div></foreignObject></g></g><g style="opacity:1" transform="translate(249.09375,731)" class="edgeLabel"><g class="label" transform="translate(-32.46875,-9)"><rect height="18" width="64.9375" ry="0" rx="0"></rect><foreignObject height="18" width="64.9375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-Operator&#x27; L-LE-DCGMExporter" id="L-L-Operator-DCGMExporter">3. deploy</span></div></foreignObject></g></g></g><g class="nodes"><g style="opacity:1" transform="translate(480.4765625,27)" id="flowchart-CR-28" class="node default"><rect class="label-container" height="38" width="151.578125" y="-19" x="-75.7890625" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-65.7890625,-9)"><foreignObject height="18" width="131.578125"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">ClusterPolicy (CR)</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(99.8125,379)" id="flowchart-Operator-29" class="node default"><rect class="label-container" height="38" width="183.625" y="-19" x="-91.8125" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-81.8125,-9)"><foreignObject height="18" width="163.625"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">Operator (Deployment)</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(480.4765625,115)" id="flowchart-NodeFeatureDiscoveryW-30" class="node default"><rect class="label-container" height="38" width="347.828125" y="-19" x="-173.9140625" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-163.9140625,-9)"><foreignObject height="18" width="327.828125"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">Node Feature Discovery Worker (DaemonSet)</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(480.4765625,203)" id="flowchart-NodeFeatureDiscoveryM-31" class="node default"><rect class="label-container" height="38" width="346.34375" y="-19" x="-173.171875" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-163.171875,-9)"><foreignObject height="18" width="326.34375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">Node Feature Discovery Master (Deployment)</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(480.4765625,291)" id="flowchart-GPUFeatureDiscovery-32" class="node default"><rect class="label-container" height="38" width="288.53125" y="-19" x="-144.265625" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-134.265625,-9)"><foreignObject height="18" width="268.53125"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">GPU Feature Discovery (DaemonSet)</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(480.4765625,379)" id="flowchart-NvidiaDriverInstaller-33" class="node default"><rect class="label-container" height="38" width="271.640625" y="-19" x="-135.8203125" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-125.8203125,-9)"><foreignObject height="18" width="251.640625"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">Nvidia Driver Installer (DaemonSet)</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(480.4765625,467)" id="flowchart-NvidiaDevicePlugin-34" class="node default"><rect class="label-container" height="38" width="257.4375" y="-19" x="-128.71875" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-118.71875,-9)"><foreignObject height="18" width="237.4375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">NvidiaDevicePlugin (DaemonSet)</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(480.4765625,555)" id="flowchart-NvidiaContainerToolkit-35" class="node default"><rect class="label-container" height="38" width="287.671875" y="-19" x="-143.8359375" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-133.8359375,-9)"><foreignObject height="18" width="267.671875"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">Nvidia Container Toolkit (DaemonSet)</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(480.4765625,643)" id="flowchart-GPUOperatorValidator-36" class="node default"><rect class="label-container" height="38" width="288.265625" y="-19" x="-144.1328125" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-134.1328125,-9)"><foreignObject height="18" width="268.265625"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">GPU Operator Validator (DaemonSet)</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(480.4765625,731)" id="flowchart-DCGMExporter-37" class="node default"><rect class="label-container" height="38" width="233.390625" y="-19" x="-116.6953125" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-106.6953125,-9)"><foreignObject height="18" width="213.390625"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">DCGM Exporter (DaemonSet)</div></foreignObject></g></g></g></g></g></g></svg></div><p>컴포넌트들이 배포되는 과정과 각 컴포넌트들의 역할에 대해 좀 더 설명해보겠다.</p><p><strong><code class="language-text">Operator (Deployment)</code></strong> 가 <strong><code class="language-text">ClusterPolicy (CR)</code></strong> 을 모니터링하며 <code class="language-text">ClusterPolicy</code> 에 설정된 값에 따라 컴포넌트들을 배포한다.</p><p>한편, Chart 의존성에 따라 <code class="language-text">node-feature-discovery</code> Chart가 배포되는데,
구체적으로는 <code class="language-text">Node Feature Discovery Worker</code> 와 <code class="language-text">Node Feature Discovery Master</code> 가 배포된다.</p><ul><li><strong><code class="language-text">Node Feature Discovery Worker (DaemonSet)</code></strong><ul><li>각 노드에서 노드의 정보를 취합하여 <code class="language-text">Master</code> 로 전송한다.</li></ul></li><li><strong><code class="language-text">Node Feature Discovery Master (Deployment)</code></strong><ul><li><code class="language-text">Worker</code> 로부터 각 노드 정보를 받아서 이를 각 노드에 라벨로 추가한다.</li></ul></li></ul><p><code class="language-text">node-feature-discovery</code> Chart 배포가 완료되면, <code class="language-text">ClusterPolicy</code> 에 따라 다음의 컴포넌트들이 GPU 노드에 배포된다.</p><ul><li><strong><code class="language-text">GPU Feature Discovery (DaemonSet)</code></strong><ul><li>Driver, CUDA, Core 개수 등 GPU 관련 정보를 추출하여 <code class="language-text">Node Feature Discovery</code> 에게 전송한다.</li><li>실제로 노드에 라벨을 작성하는건 <code class="language-text">Node Feature Discovery</code> 가 담당한다.</li></ul></li><li><strong><code class="language-text">Nvidia Driver Installer (DaemonSet)</code></strong><ul><li>노드에서 GPU를 감지할 수 있게 GPU Driver를 노드에 설치한다.</li><li>이미 노드에 GPU Driver가 설치되어 있다면, 이 컴포넌트는 <code class="language-text">values.yaml</code> 에서 <code class="language-text">enabled: false</code> 로 설정하면 된다.</li></ul></li><li><strong><code class="language-text">Nvidia Device Plugin (DaemonSet)</code></strong> <ul><li>파드의 GPU 사용은 파드 스펙 내에 <code class="language-text">resources.nvidia.com/gpu: 1</code> 와 같이 작성하여 사용할 수 있다.</li><li>이 컴포넌트는 <code class="language-text">nvidia.com/gpu</code> 리소스를 감지하고 처리할 수 있게 한다.</li><li>참고로, <code class="language-text">Device Plugin</code> 은 일반적으로 이런 커스텀 리소스(<code class="language-text">cpu</code>, <code class="language-text">mem</code> 이 아닌)를 감지하고 처리하는 컴포넌트다.</li></ul></li><li><strong><code class="language-text">Nvidia Container Toolkit (DaemonSet)</code></strong> <ul><li>컨테이너 환경에서 GPU를 사용할 수 있게 한다.</li></ul></li><li><strong><code class="language-text">GPU Operator Validator (DaemonSet)</code></strong> <ul><li>GPU를 사용하는 컨테이너를 실행함으로써, 최종적으로 GPU 환경이 잘 세팅되었는지 확인한다.</li></ul></li><li><strong><code class="language-text">DCGM Exporter (DaemonSet)</code></strong><ul><li>GPU 관련 Metric을 특정 엔드포인트에 출력한다.</li><li>이를 통해 GPU 사용량, GPU 온도, 사용중인 파드, 네임스페이스 등을 알 수 있다.</li></ul></li></ul><p>위 다이어그램에 표기한 것 처럼 1 -&gt; 2 -&gt; 3 순으로 배포가 진행된다.
3에서는 일부 컴포넌트간 의존성이 존재하는데, 이는 다음과 같다.</p><div class="mermaid" data-processed="true"><svg viewBox="0 0 1065.328125 54" style="max-width:1065.328125px" height="54" aria-labelled-by="chart-title-mermaid-1736145204064,chart-desc-mermaid-1736145204064" role="img" xmlnsXLink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="mermaid-1736145204064"><title id="chart-title-mermaid-1736145204064"></title><desc id="chart-desc-mermaid-1736145204064"></desc><style>#mermaid-1736145204064 {font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-1736145204064 .error-icon{fill:#552222;}#mermaid-1736145204064 .error-text{fill:#552222;stroke:#552222;}#mermaid-1736145204064 .edge-thickness-normal{stroke-width:2px;}#mermaid-1736145204064 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1736145204064 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1736145204064 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1736145204064 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1736145204064 .marker{fill:#333333;stroke:#333333;}#mermaid-1736145204064 .marker.cross{stroke:#333333;}#mermaid-1736145204064 svg{font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;font-size:16px;}#mermaid-1736145204064 .label{font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;color:#333;}#mermaid-1736145204064 .cluster-label text{fill:#333;}#mermaid-1736145204064 .cluster-label span{color:#333;}#mermaid-1736145204064 .label text,#mermaid-1736145204064 span{fill:#333;color:#333;}#mermaid-1736145204064 .node rect,#mermaid-1736145204064 .node circle,#mermaid-1736145204064 .node ellipse,#mermaid-1736145204064 .node polygon,#mermaid-1736145204064 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1736145204064 .node .label{text-align:center;}#mermaid-1736145204064 .node.clickable{cursor:pointer;}#mermaid-1736145204064 .arrowheadPath{fill:#333333;}#mermaid-1736145204064 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1736145204064 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1736145204064 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-1736145204064 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-1736145204064 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1736145204064 .cluster text{fill:#333;}#mermaid-1736145204064 .cluster span{color:#333;}#mermaid-1736145204064 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1736145204064 :root{--mermaid-font-family:&quot;trebuchet ms&quot;,verdana,arial,sans-serif;}</style><g transform="translate(0, 0)"><g class="output"><g class="clusters"></g><g class="edgePaths"><g style="opacity:1" id="L-A-B" class="edgePath LS-A LE-B"><path style="fill:none" marker-end="url(#arrowhead22)" d="M180.046875,27L184.21354166666666,27C188.38020833333334,27,196.71354166666666,27,205.046875,27C213.38020833333334,27,221.71354166666666,27,225.88020833333334,27L230.046875,27" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead22"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-B-C" class="edgePath LS-B LE-C"><path style="fill:none" marker-end="url(#arrowhead23)" d="M418.125,27L422.2916666666667,27C426.4583333333333,27,434.7916666666667,27,443.125,27C451.4583333333333,27,459.7916666666667,27,463.9583333333333,27L468.125,27" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead23"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-C-D" class="edgePath LS-C LE-D"><path style="fill:none" marker-end="url(#arrowhead24)" d="M634.859375,27L639.0260416666666,27C643.1927083333334,27,651.5260416666666,27,659.859375,27C668.1927083333334,27,676.5260416666666,27,680.6927083333334,27L684.859375,27" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead24"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g><g style="opacity:1" id="L-D-E" class="edgePath LS-D LE-E"><path style="fill:none" marker-end="url(#arrowhead25)" d="M873.53125,27L877.6979166666666,27C881.8645833333334,27,890.1979166666666,27,898.53125,27C906.8645833333334,27,915.1979166666666,27,919.3645833333334,27L923.53125,27" class="path"></path><defs><marker orient="auto" markerHeight="6" markerWidth="8" markerUnits="strokeWidth" refY="5" refX="9" viewBox="0 0 10 10" id="arrowhead25"><path style="stroke-width:1;stroke-dasharray:1, 0" class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z"></path></marker></defs></g></g><g class="edgeLabels"><g style="opacity:1" transform="" class="edgeLabel"><g class="label" transform="translate(0,0)"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-A&#x27; L-LE-B" id="L-L-A-B"></span></div></foreignObject></g></g><g style="opacity:1" transform="" class="edgeLabel"><g class="label" transform="translate(0,0)"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-B&#x27; L-LE-C" id="L-L-B-C"></span></div></foreignObject></g></g><g style="opacity:1" transform="" class="edgeLabel"><g class="label" transform="translate(0,0)"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-C&#x27; L-LE-D" id="L-L-C-D"></span></div></foreignObject></g></g><g style="opacity:1" transform="" class="edgeLabel"><g class="label" transform="translate(0,0)"><rect height="0" width="0" ry="0" rx="0"></rect><foreignObject height="0" width="0"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel L-LS-D&#x27; L-LE-E" id="L-L-D-E"></span></div></foreignObject></g></g></g><g class="nodes"><g style="opacity:1" transform="translate(94.0234375,27)" id="flowchart-A-5" class="node default"><rect class="label-container" height="38" width="172.046875" y="-19" x="-86.0234375" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-76.0234375,-9)"><foreignObject height="18" width="152.046875"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">Nvidia Driver Installer</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(324.0859375,27)" id="flowchart-B-6" class="node default"><rect class="label-container" height="38" width="188.078125" y="-19" x="-94.0390625" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-84.0390625,-9)"><foreignObject height="18" width="168.078125"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">Nvidia Container Toolkit</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(551.4921875,27)" id="flowchart-C-7" class="node default"><rect class="label-container" height="38" width="166.734375" y="-19" x="-83.3671875" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-73.3671875,-9)"><foreignObject height="18" width="146.734375"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">Nvidia Device Plugin</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(779.1953125,27)" id="flowchart-D-8" class="node default"><rect class="label-container" height="38" width="188.671875" y="-19" x="-94.3359375" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-84.3359375,-9)"><foreignObject height="18" width="168.671875"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">GPU Operator Validator</div></foreignObject></g></g></g><g style="opacity:1" transform="translate(990.4296875,27)" id="flowchart-E-9" class="node default"><rect class="label-container" height="38" width="133.796875" y="-19" x="-66.8984375" ry="0" rx="0"></rect><g transform="translate(0,0)" class="label"><g transform="translate(-56.8984375,-9)"><foreignObject height="18" width="113.796875"><div style="display:inline-block;white-space:nowrap" xmlns="http://www.w3.org/1999/xhtml">DCGM Exporter</div></foreignObject></g></g></g></g></g></g></svg></div><p>화살표는 동작 흐름이다.
예를 들어, <code class="language-text">Nvidia Driver Installer</code> 가 잘 동작해야 <code class="language-text">Nvidia Container Toolkit</code> 이 그 다음에 잘 동작한다.
만약 직전 컴포넌트가 잘 동작하지 않는다면 뒤에 있는 컴포넌트는 앞의 컴포넌트가 잘 동작할 때까지 계속해서 기다리게 된다.</p><blockquote><p>여기서는 거의 필수적으로 배포해야 하는 컴포넌트들만 설명했다.
GPU Operator에서 제공하는 전체 컴포넌트는 <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/overview.html">공식 문서</a>에서 확인할 수 있다.</p></blockquote><h3 id="gpu-노드에-테인트-추가하기" style="position:relative"><a href="#gpu-%EB%85%B8%EB%93%9C%EC%97%90-%ED%85%8C%EC%9D%B8%ED%8A%B8-%EC%B6%94%EA%B0%80%ED%95%98%EA%B8%B0" aria-label="gpu 노드에 테인트 추가하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>GPU 노드에 테인트 추가하기</h3><p>Chart 배포 이전에 해야할 일이 하나 있다.
GPU 노드에 테인트를 붙여주지 않으면, GPU를 사용하지 않는 파드도 GPU 노드에 스케줄링될 것이다.
이를 방지하기 위해 GPU 노드에 특정 테인트를 붙여야 한다.</p><p>특정 테인트 값은 <code class="language-text">values.yaml</code> 에서 <code class="language-text">tolerations</code> 로 검색해보면 다음처럼 알 수 있다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># values.yaml</span>

<span class="token key atrule">daemonsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span>
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nvidia.com/gpu
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
    <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule

<span class="token punctuation">...</span>

<span class="token key atrule">node-feature-discovery</span><span class="token punctuation">:</span>
  <span class="token key atrule">worker</span><span class="token punctuation">:</span>
    <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
    <span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">&quot;nvidia.com/gpu&quot;</span>
      <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">&quot;Equal&quot;</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;present&quot;</span>
      <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">&quot;NoSchedule&quot;</span></code></pre></div><p>이제 다음과 같이 노드에 테인트를 추가하자. </p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl taint <span class="token function">node</span> node<span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">..</span><span class="token number">7</span><span class="token punctuation">}</span> nvidia.com/gpu<span class="token operator">=</span>present:NoSchedule</code></pre></div><h3 id="chart-배포하기" style="position:relative"><a href="#chart-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0" aria-label="chart 배포하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Chart 배포하기</h3><p>이제 Chart를 배포해보자.
여기서는 꼭 필요하지 않은 컴포넌트는 배포하지 않을거라, <code class="language-text">values.yaml</code> 에서 다음 컴포넌트들은 <code class="language-text">enabled: false</code> 로 수정한다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># values.yaml</span>

<span class="token key atrule">driver</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 노드에 이미 드라이버가 설치되어있기 때문에 false로 둔다. (드라이버 자체는 필수다)</span>
<span class="token punctuation">...</span>
<span class="token key atrule">migManager</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token punctuation">...</span>
<span class="token key atrule">vgpuManager</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">vgpuDeviceManager</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">vfioManager</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre></div><p>이제 다음처럼 Chart를 배포한다.</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ helm install gpu-operator gpu-operator -n gpu-operator --create-namespace</code></pre></div><p>배포가 성공적으로 되면 다음과 같은 오브젝트들이 배포된 것을 확인할 수 있다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get clusterpolicy -n gpu-operator
NAME             AGE
cluster-policy   6h27m

$ kubectl get all -n gpu-operator
NAME                                                              READY   STATUS      RESTARTS   AGE
pod/gpu-feature-discovery-99gq7                                   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          44s
pod/gpu-feature-discovery-bmncd                                   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          44s
pod/gpu-feature-discovery-qk5qx                                   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          44s
pod/gpu-operator-677fd4ff77-6mw6j                                 <span class="token number">1</span>/1     Running     <span class="token number">0</span>          46s
pod/gpu-operator-node-feature-discovery-master-856648b975-4m996   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h27m
pod/gpu-operator-node-feature-discovery-worker-5cqv5              <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h27m
pod/gpu-operator-node-feature-discovery-worker-n4kxd              <span class="token number">1</span>/1     Running     <span class="token number">0</span>          45s
pod/gpu-operator-node-feature-discovery-worker-rctp8              <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h27m
pod/gpu-operator-node-feature-discovery-worker-vgcbx              <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h27m
pod/gpu-operator-node-feature-discovery-worker-vmsgd              <span class="token number">0</span>/1     Running     <span class="token number">0</span>          47s
pod/gpu-operator-node-feature-discovery-worker-vt958              <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h27m
pod/gpu-operator-node-feature-discovery-worker-zt7n6              <span class="token number">0</span>/1     Running     <span class="token number">0</span>          47s
pod/nvidia-container-toolkit-daemonset-4lv5b                      <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h26m
pod/nvidia-container-toolkit-daemonset-fnrqk                      <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h26m
pod/nvidia-container-toolkit-daemonset-x25wz                      <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h26m
pod/nvidia-cuda-validator-7b8rw                                   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          6h26m
pod/nvidia-cuda-validator-95qwr                                   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          6h26m
pod/nvidia-cuda-validator-htqw7                                   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          6h26m
pod/nvidia-dcgm-exporter-qkjnc                                    <span class="token number">1</span>/1     Running     <span class="token number">0</span>          39s
pod/nvidia-dcgm-exporter-svv84                                    <span class="token number">1</span>/1     Running     <span class="token number">0</span>          34s
pod/nvidia-dcgm-exporter-x227h                                    <span class="token number">1</span>/1     Running     <span class="token number">0</span>          44s
pod/nvidia-device-plugin-daemonset-8hgf8                          <span class="token number">1</span>/1     Running     <span class="token number">0</span>          34s
pod/nvidia-device-plugin-daemonset-pjnpm                          <span class="token number">1</span>/1     Running     <span class="token number">0</span>          42s
pod/nvidia-device-plugin-daemonset-vqj4w                          <span class="token number">1</span>/1     Running     <span class="token number">0</span>          28s
pod/nvidia-device-plugin-validator-hmfmf                          <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          6h26m
pod/nvidia-device-plugin-validator-kwn7s                          <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          6h26m
pod/nvidia-device-plugin-validator-nzhgr                          <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          6h26m
pod/nvidia-operator-validator-6w7bn                               <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h26m
pod/nvidia-operator-validator-n5w2q                               <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h26m
pod/nvidia-operator-validator-tlj27                               <span class="token number">1</span>/1     Running     <span class="token number">0</span>          6h26m

NAME                                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
service/gpu-operator                                 ClusterIP   <span class="token number">10.233</span>.14.169   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   6h26m
service/gpu-operator-node-feature-discovery-master   ClusterIP   <span class="token number">10.233</span>.22.56    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   6h27m
service/nvidia-dcgm-exporter                         ClusterIP   <span class="token number">10.233</span>.42.33    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9400</span>/TCP   6h26m

NAME                                                        DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                                      AGE
daemonset.apps/gpu-feature-discovery                        <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>            <span class="token number">3</span>           nvidia.com/gpu.deploy.gpu-feature-discovery<span class="token operator">=</span>true   6h26m
daemonset.apps/gpu-operator-node-feature-discovery-worker   <span class="token number">7</span>         <span class="token number">7</span>         <span class="token number">5</span>       <span class="token number">3</span>            <span class="token number">5</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                                             6h27m
daemonset.apps/nvidia-container-toolkit-daemonset           <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>            <span class="token number">3</span>           nvidia.com/gpu.deploy.container-toolkit<span class="token operator">=</span>true       6h26m
daemonset.apps/nvidia-dcgm-exporter                         <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>            <span class="token number">3</span>           nvidia.com/gpu.deploy.dcgm-exporter<span class="token operator">=</span>true           6h26m
daemonset.apps/nvidia-device-plugin-daemonset               <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>            <span class="token number">3</span>           nvidia.com/gpu.deploy.device-plugin<span class="token operator">=</span>true           6h26m
daemonset.apps/nvidia-operator-validator                    <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>            <span class="token number">3</span>           nvidia.com/gpu.deploy.operator-validator<span class="token operator">=</span>true      6h26m

NAME                                                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/gpu-operator                                 <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           6h27m
deployment.apps/gpu-operator-node-feature-discovery-master   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           6h27m

NAME                                                                    DESIRED   CURRENT   READY   AGE
replicaset.apps/gpu-operator-677fd4ff77                                 <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       46s
replicaset.apps/gpu-operator-node-feature-discovery-master-856648b975   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       6h27m</code></pre></div><h2 id="binpack-스케줄링으로-리소스-사용-효율화-하기" style="position:relative"><a href="#binpack-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81%EC%9C%BC%EB%A1%9C-%EB%A6%AC%EC%86%8C%EC%8A%A4-%EC%82%AC%EC%9A%A9-%ED%9A%A8%EC%9C%A8%ED%99%94-%ED%95%98%EA%B8%B0" aria-label="binpack 스케줄링으로 리소스 사용 효율화 하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Binpack 스케줄링으로 리소스 사용 효율화 하기</h2><h3 id="resource-fragmentation-문제" style="position:relative"><a href="#resource-fragmentation-%EB%AC%B8%EC%A0%9C" aria-label="resource fragmentation 문제 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Resource Fragmentation 문제</h3><p>GPU를 사용하는 파드를 배포할 때 Default 스케줄러를 그대로 사용하면 문제가 될 수 있다.</p><p>먼저 GPU 리소스를 쓰는 파드 하나를 다음처럼 배포해보자.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># pod-gpu-1.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>gpu<span class="token punctuation">-</span><span class="token number">1</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cuda<span class="token punctuation">-</span>vector<span class="token punctuation">-</span>add
    <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/cuda<span class="token punctuation">-</span>vector<span class="token punctuation">-</span>add<span class="token punctuation">:</span>v0.1
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sleep&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;100000&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
    <span class="token key atrule">key</span><span class="token punctuation">:</span> nvidia.com/gpu
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists</code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f pod-gpu-1.yaml -n gpu-operator
pod/pod-gpu-1 created

$ kubectl get pods -o wide -n gpu-operator <span class="token operator">|</span> <span class="token function">grep</span> pod-gpu
pod-gpu-1         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s      <span class="token number">10.233</span>.100.157   node7    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span></code></pre></div><p>별 문제없이 잘 뜬다.</p><p>같은 파드 스펙을 이름만 바꿔 하나 더 배포해보자.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># pod-gpu-2.yaml</span>

<span class="token punctuation">...</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>gpu<span class="token punctuation">-</span><span class="token number">2</span>
<span class="token punctuation">...</span></code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f pod-gpu-2.yaml -n gpu-operator
pod/pod-gpu-2 created

$ kubectl get pods -o wide -n gpu-operator <span class="token operator">|</span> <span class="token function">grep</span> pod-gpu
pod-gpu-2         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s      <span class="token number">10.233</span>.97.186    node5    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span></code></pre></div><p>마찬가지로 별 문제없다.
그럼 대체 무엇이 문제가 될 수 있는걸까?</p><p>여기서 문제가 될 수 있는 부분은 <code class="language-text">pod-gpu-1</code> 는 <code class="language-text">node7</code>에, <code class="language-text">pod-gpu-2</code> 는 <code class="language-text">node5</code> 에 스케줄링되었다는 것이다.
GPU를 쓰는 파드가 여러 GPU 노드에 분산되어 스케줄링되었다.
이는 &quot;Resource Fragmentation&quot; 문제를 일으키는데, 쉽게 말해 클러스터 전체적으로 GPU 리소스가 남음에도 불구하고, 모두 분산되어 있어 쓸 수 없는 문제다.</p><p>예를 들어, 2개의 GPU 노드가 각각 4개 코어씩 가지고 있다고 하자.
현재 2개 코어를 쓰는 파드와 1개 코어를 쓰는 파드가 각 노드에 모두 배포되어 있다.
이 때 2개 코어를 쓰는 파드가 제출되었을 때, 이 파드는 스케줄링될 노드가 없다.
이 상황을 다음 그림이 보여준다.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:335px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:73.64864864864865%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACzklEQVQ4y5WR6XIaVxBG5/2fIP/iyDZIiE0yO5YQi2yEBDMwgJAFZp0BAwOzsVpwUozjRJRTqUpXfdW3b/U99XVfgVex2+2d3OlbuIIjvJEp3ugEX2zi5EP9Pjii3bOO+l+H8G/ArrLgLDQjmDT5w2Py2xuLdz6TQMLkNDSn01/8P2C7b/M2oOEJG5z4dN6c67wL6HjCOif+Ka3OT4c79vv9kY6Ah4tDTLQluYJGvqSTF+fcSXPyok6+bJIr6oznmx/98N8OX0P5+8lBLwc/sFrCwmZnmrwslrwcsmmyW2+cerdaIez3P20f2z+Mv3POYFgW2+UaW5TRcwWMTwXsSg2zUMIsPGBLVaximeVz81eH/GoZy7bZWhbrRovv/RHb1oDNlzarSp1145nvqsKq/MS6N0D4MinTnJV5mko01QZKX2EwGNDr9TAM44g9Xqo0FzLtZZ2WWaM36qIoQxRVdbTdbhHiIw8R1U9cOyXTilAuykiSRPG+iKIoP35z/+KssKYXCI3eExv6SU7d3FWylEsVJFFELInYto1w2Qrx++c0F+0Q+W6CqlRHlmUkUWI4HP4F3Dl/0zBKuOQwJ4UUcTVIqfGZarnm9MuVCovFAiE985KzfNyYHnLNJNVSHblcRSxKDNVXwB08GkVSpptby09q5uVezlMV61Qk2ZEDvBqecz32kpp6yE683CofyA7CXHcDdLTnf0beQ332QOKbi9TYR1rzkB37yaqXpJULMv0Q1spAuNF8ZE0fcfWSwHOUiHJB2vRxpbvpWI2jHTaMItfGGVk9SKgTIdiK8HEaJGN7ycwDWBsDIa37uV36CfcjnNU+EupGyVlBUoaHrvV0BHw07rkyXNzoPs4fo5xWY8TUCzKWh7Tmx1obCLGvbuLdU5J9N1eKy8mJ7hnhr29pTetHIzf1KrdaiLtZgnsjyoMZpTCPkZ/FuJskWWws/gSNiUWRNJxRbAAAAABJRU5ErkJggg==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="1.png" title="1.png" src="/blog/static/8c68d837f77836db5abc973eafa368c5/c0051/1.png" srcSet="/blog/static/8c68d837f77836db5abc973eafa368c5/12f09/1.png 148w,/blog/static/8c68d837f77836db5abc973eafa368c5/e4a3f/1.png 295w,/blog/static/8c68d837f77836db5abc973eafa368c5/c0051/1.png 335w" sizes="(max-width: 335px) 100vw, 335px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span>
<em>출처: <a href="https://www.alibabacloud.com/blog/the-burgeoning-kubernetes-scheduling-system-part-3-binpack-scheduling-that-supports-batch-jobs_597321">The Burgeoning Kubernetes Scheduling System – Part 3: Binpack Scheduling That Supports Batch Jobs</a></em></p><p>만약 두 번째 노드의 1개 코어를 쓰는 GPU 파드가 첫 번째 노드로 스케줄링 되었다면,
두 번째 노드는 2개 코어가 남기 때문에, 2개 코어를 쓰는 파드는 이 두 번째 노드로 스케줄링 될 수 있었을 것이다.
이 상황을 다음 그림이 보여준다.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:318px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:38.513513513513516%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB7klEQVQoz12Q2W6bQBSG547340F4mN7lqlkawzADXsCsNsaQVlXSRI1Up6qaxk5sRzZeEkDpBUL81SRSK/Xi09n/c3TIcKlC4E1VWDenGCxUDB9blT9TYU1OFWtySljiSIfqBXnf+izT3hK6va51e9Ww/goC3f4H6U5ddO9cDDdtRGuK/rwP/sOvwnUH0Yoqo0wj3cuBdKxfkyN6JTNnB8MvaubkjWYVoHYBw8v/QvRJAPotgL/sIFpraN86+HA1qJx5D6O1qow3KulehNIxvSZH2pXM+juYflmfGEXz7qDEwWEJ1heiBbhbgKQFQ5ozRBmDP6NInhnOCr2KtwzeVFO8GSXtc1861r+QI3ouM+cR3NvU3M0a7m6ED+5m4N4bZLQzMNpyJE/6K/GeY7Q1qijj8Gea4t9rxP2lS/Z3RuwbJg8WPQwf7TpaWc1400WcidgSuVdIWpoYP5voTR20bz0Eqx7S0qjGTwbCBVXCpU7CJZWCB5X496o8fuY4e+F1mHWa9k8X1r2NpOBIS46k5CBJYSLemxC/bH0doP9gIy2MKt4bCOZUCReUBHMq+TONeHeaHO8MUa/dhdWcXEZgkwCjXRtJ/nbYq2CSG/j4wvHpN3vblJtVLC78X3CqyWJRkpt1WhiN6BdzYl6ICfsHUHHshG+9nAoAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="2.png" title="2.png" src="/blog/static/42dce3690f759f62ff1f612fcf8c1bf9/cd2d9/2.png" srcSet="/blog/static/42dce3690f759f62ff1f612fcf8c1bf9/12f09/2.png 148w,/blog/static/42dce3690f759f62ff1f612fcf8c1bf9/e4a3f/2.png 295w,/blog/static/42dce3690f759f62ff1f612fcf8c1bf9/cd2d9/2.png 318w" sizes="(max-width: 318px) 100vw, 318px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span>
<em>출처: <a href="https://www.alibabacloud.com/blog/the-burgeoning-kubernetes-scheduling-system-part-3-binpack-scheduling-that-supports-batch-jobs_597321">The Burgeoning Kubernetes Scheduling System – Part 3: Binpack Scheduling That Supports Batch Jobs</a></em></p><p>이렇게 이미 사용 중인 노드로 (리소스가 허용가능하다면) 파드를 스케줄링 하는 방법을 &quot;Binpack 스케줄링&quot; 이라고 한다.
이 스케줄링 방법을 쓰면, 파드가 몇몇 노드들에 모이기 때문에 시스템적인 측면에서 안정성은 떨어지지만,
리소스가 차곡차곡 쌓이며 노드를 최대한으로 사용하므로, 리소스를 좀 더 효율적으로 사용할 수 있다.</p><p>기본적으로 쿠버네티스 스케줄러는 Binpack 스케줄링을 사용하지 않는다.
대신 <code class="language-text">LeastRequestedPriority</code> 방식으로 스케줄링을 한다.
이는 예약된 리소스가 가장 적은 사용되는 노드에 파드를 스케줄링하는 방식으로, 결과적으로 전체 클러스터의 리소스가 모든 노드에 고르게 분배된다.
쿠버네티스 스케줄링 정책은 기본적으로 리소스 효율성보다는 안정성에 좀 더 손을 들어준 것이다.
일반적인 파드라면 대부분 항상 동작해야하고, 안정성이 중요하므로 나도 이게 맞다고 생각한다.</p><p>그러나 GPU를 쓰는 파드는 이런 일반적인 파드가 아니다.
GPU를 쓰는 파드는 주로 머신러닝 모델 훈련을 실행하거나 데이터를 전처리하는 파이프라인성 파드들이다.
즉 항상 동작해야하는 것이 아니라 &quot;일시적&quot;으로 동작하고 내려가는 특성이 있다.</p><p>따라서 GPU를 쓰는 파드는 안정성을 중시하는 쿠버네티스 기본 스케줄링 방식인 <code class="language-text">LeastRequestedPriority</code> 보다 리소스 효율성을 중시하는 Binpack 방식으로 스케줄링되는게 더 잘 어울린다.</p><p>그럼 Binpack 방식으로 파드를 스케줄링 하려면 어떻게 해야할까?</p><h3 id="스케줄러의-동작-과정-이해하기" style="position:relative"><a href="#%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC%EC%9D%98-%EB%8F%99%EC%9E%91-%EA%B3%BC%EC%A0%95-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0" aria-label="스케줄러의 동작 과정 이해하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>스케줄러의 동작 과정 이해하기</h3><p>먼저 쿠버네티스 스케줄러가 파드를 노드에 어떻게 스케줄링하는지 그 과정에 대해 조금 알아볼 필요가 있다.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:44.5945945945946%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC0ElEQVQozxXKW0hTARjA8c9LSJCl5lMjFSF6KHzoIYIiwZfwTainCKIsKF8SCknLNLK80crIFNfUqXPmFfKym3Nnzu3snLPL2aab286m03TzMpdKXuaZX/iH39sf7tRcB6nqKyyvAuxhJbi4ZyDFGPzGMBQVFULetTy4lX8Z8gsEcLvgKpz0uOEmlLTdS+qYLO3p1pR25+SeTQeA1KclhQlQ3f0iASZONgTEV8mbkRtJQsRkHWLipdzsM+nnMwRZ2amC7JxEwcWscxcAIC3s7wXDr/un162P6rfY4uaHd/MEp1Iy0hARoFpSCjLoSpiyUmqNxebRzzmcphHprI1ROdk/FjfjnfHpnZRPZ2e9lMccNLh1ypBfVfc3ZPLP+zw6X8Azvb9hssYiJBdZ1NRBWeeT58Lxijda29yByryI7EoUXTIJchYNcrteDERdqDbbcIRwoS24gO51+85ueJqMrrEop/1oDmwiv21BjDnwcJOcgtL2B5n1fa+v9MuHt/rl4zg4OcaL3pXHlWOy+FzYGWcDdJz2sHG9Y45nvCwyPuMaNysnoqsMzvucRy6fO74TImMLs6O45B4fhwZpFbR97k4dUPdsf++vxR9DDcffeoTYOtyEEkULdspPNKNE2XwsUTSjaKw1MiEro+zqt+ieros7tR/Rra/jZeJK1CnEE+D3L4BKq8q0LpNbrUQtdtLCI3NIxw8wYv6nsYHvIpv4L6NVvMTQxLcbG1FMtobC1nL1BlWMEXtF7Jh7ya+SJTGMKvB41z4GBKWBkYmhTHPAwPeRIuwzitDIaXCEkqJ0pgVlehGKlU3Yb+zAQVqMvYauvaBNSG06anDJ0ogr5ve4YvmEh2tK/Ldu0kLHoAg+CKtSLH5Tr2PJbLAHmSk2yBCETU1M0nJCx6oJdpEm7EFGaw8yRpojO5c9irKDDSO16lNMeW3DRJhTafbXDfTGwmTZf2vT5GJua/fdAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="3.png" title="3.png" src="/blog/static/119c110736d4e01b37984d6d21160f12/fcda8/3.png" srcSet="/blog/static/119c110736d4e01b37984d6d21160f12/12f09/3.png 148w,/blog/static/119c110736d4e01b37984d6d21160f12/e4a3f/3.png 295w,/blog/static/119c110736d4e01b37984d6d21160f12/fcda8/3.png 590w,/blog/static/119c110736d4e01b37984d6d21160f12/efc66/3.png 885w,/blog/static/119c110736d4e01b37984d6d21160f12/c83ae/3.png 1180w,/blog/static/119c110736d4e01b37984d6d21160f12/ad00e/3.png 1366w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span>
<em>출처: <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework/">Kubernetes Documentation - Scheduling Framework</a></em></p><p>구체적인 스케줄링 과정은 조금 복잡하지만, 여기서 이해해야할 핵심 과정만 간추리면 다음과 같다.</p><p><strong>1. 필터링 (Filtering)</strong></p><ul><li>클러스터 내 전체 노드 항목에서 파드를 스케줄링하기 적합하지 않은 노드들을 거르는 과정이다.</li><li>예를 들어 노드가 <code class="language-text">SchedulingDisabled</code> 상태이거나, 파드를 스케줄링하기에 리소스가 부족한 상태라면, 이 노드는 스케줄링 대상에서 제외된다.</li><li>이 과정에서 걸리지지 않은 노드들은 최종적으로 스케줄링될 노드의 후보가 된다.</li></ul><p><strong>2. 스코어링 (Scoring)</strong></p><ul><li>후보 노드들 중에서 어떤 노드에 배치해야할 지, 각 노드들의 점수를 매김으로써 최종적으로 스케줄링될 노드를 결정하는 과정이다.</li><li>점수를 매기는 방법은 스케줄링 정책에 따라 달라진다. (이 방법이 곧 스케줄링 정책이다.)</li><li><code class="language-text">LeastRequestedPriority</code> 이 스케줄링 기본 정책으로 쓰이고 있는 것이고, 만약 우리가 Binpack 방법을 사용하고 싶다면, 스코어링 관련 설정 값을 수정해야 한다.</li><li>노드를 스코어링하는 예시는 <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/resource-bin-packing/#node-scoring-for-capacity-allocation">공식 문서</a>를 참고하자.</li></ul><p><strong>3. 바인딩 (Binding)</strong></p><ul><li>최종적으로 결정된 노드에 실제로 파드를 연결하는 과정이다.</li><li>바인딩 이후 etcd에 바인딩 정보를 저장하게 되면, Kubelet이 이를 읽어 실제로 바인딩하게 된다.</li></ul><p>스케줄러 관련 설정 중 스코어링 정책을 수정해야 함을 알았다.
이렇게 스케줄러 관련 설정을 수정하여 내 입맛대로 스케줄러를 커스터마이징하는 것을 &quot;스케줄러 확장&quot; 한다라고 한다.
이제 스코어링 정책에 대해 스케줄러를 확장하고, 이를 배포하는 방법에 대해 알아보자.</p><blockquote><p>스케줄러 동작 과정에 대해 좀 더 자세히 알고 싶다면 <a href="https://netpple.github.io/docs/deepdive-into-kubernetes/k8s-scheduler">NETPPLE 블로그 - kube-scheduler 글</a>을 읽어보길 추천한다.</p></blockquote><h3 id="스케줄러의-스코어링-정책-설정하기" style="position:relative"><a href="#%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC%EC%9D%98-%EC%8A%A4%EC%BD%94%EC%96%B4%EB%A7%81-%EC%A0%95%EC%B1%85-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0" aria-label="스케줄러의 스코어링 정책 설정하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>스케줄러의 스코어링 정책 설정하기</h3><p>스케줄러를 확장하는 방법 중 하나는 <code class="language-text">KubeSchedulerConfiguration</code> 오브젝트에서 플러그인을 조정하는 것이다.</p><p><code class="language-text">KubeSchedulerConfiguration</code> 오브젝트는 스케줄러의 설정 값을 담는다.
이 오브젝트는 다음처럼 생겼다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubescheduler.config.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeSchedulerConfiguration
<span class="token key atrule">profiles</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> non<span class="token punctuation">-</span>multipoint<span class="token punctuation">-</span>scheduler
    <span class="token key atrule">plugins</span><span class="token punctuation">:</span>
      <span class="token key atrule">score</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MyPlugin
      <span class="token key atrule">filter</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MyPlugin</code></pre></div><p>조금 더 설명을 붙이면,</p><ul><li><code class="language-text">profiles</code> 항목 안에 여러 개의 프로필이 들어갈 수 있다.</li><li>프로필 안에 <code class="language-text">schedulerName</code> 으로 스케줄러 이름을 지정해줄 수 있다. 이는 쿠버네티스에 여러 개의 스케줄러를 띄울 때, 스케줄러 간 구분 값이 된다.</li><li>프로필 안의 <code class="language-text">plugins</code> 항목에 플러그인을 추가하거나 삭제할 수 있다. 플러그인은 쿠버네티스에서 제공해주는 것들을 추가해도 되고, 자기가 직접 만든 뒤 추가해도 된다.</li></ul><blockquote><p>쿠버네티스에서 제공해주는 플러그인들은 <a href="https://kubernetes.io/docs/reference/scheduling/config/#scheduling-plugins">공식 문서</a>에서 확인할 수 있다.</p></blockquote><p>스코어링 정책으로 Binpack 방법을 사용하기 위해 <code class="language-text">KubeSchedulerConfiguration</code> 를 다음처럼 작성한다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubescheduler.config.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeSchedulerConfiguration
<span class="token key atrule">profiles</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">plugins</span><span class="token punctuation">:</span>
    <span class="token key atrule">score</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestedToCapacityRatio
  <span class="token key atrule">pluginConfig</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> RequestedToCapacityRatio
    <span class="token key atrule">args</span><span class="token punctuation">:</span> 
      <span class="token key atrule">shape</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">utilization</span><span class="token punctuation">:</span> <span class="token number">0</span>
        <span class="token key atrule">score</span><span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token punctuation">-</span> <span class="token key atrule">utilization</span><span class="token punctuation">:</span> <span class="token number">100</span>
        <span class="token key atrule">score</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nvidia.com/gpu
        <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu
        <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> memory
        <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
<span class="token key atrule">leaderElection</span><span class="token punctuation">:</span>
  <span class="token key atrule">leaderElect</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre></div><p>조금 더 설명을 붙이면,</p><ul><li><code class="language-text">RequestedToCapacityRatio</code> 는 <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/resource-bin-packing/#enabling-bin-packing-using-requestedtocapacityratio">쿠버네티스에서 제공해주는 플러그인</a> 중 하나다. 이 플러그인을 활성화한다.</li><li><code class="language-text">RequestedToCapacityRatio</code> 를 통해 리소스의 사용량에 따라 스코어링 결과를 계산할 수 있다.</li><li>인자로 <code class="language-text">shape</code> 과 <code class="language-text">resources</code> 두 가지가 있다.<ul><li><code class="language-text">shape</code> 은 리소스 사용량이 곧 점수 몇점에 해당되는지에 대한 매핑 정보를 담는다. 여기서는 사용량이 0이면 0점으로, 사용량이 100이면 10점이 되도록 설정했다. 즉 사용량이 많은 노드가 높은 점수를 받아 최종적으로 스케줄링될 가능성이 더 높아진다.</li><li><code class="language-text">resources</code> 는 이러한 스코어링 정책을 어떤 리소스를 기준으로 가중치를 매길지에 대한 정보를 담는다. 우리는 GPU 리소스에 대해서만 비교할 것이므로, <code class="language-text">nvidia.com/gpu</code> 에만 가중치 <code class="language-text">100</code> 을 설정한다.</li></ul></li><li><code class="language-text">leaderElection</code> 는 스케줄러 HA 구성을 위한 리더 선출에 참여하느냐에 대한 설정인데, 여기서 자세한 설명은 생략한다.</li></ul><blockquote><p>스케줄러 설정에 대한 더 자세한 내용이 궁금하다면 <a href="https://kubernetes.io/docs/reference/scheduling/config">공식 문서</a>를 읽어보길 추천한다.</p></blockquote><h3 id="커스텀-스케줄러-만들고-배포하기" style="position:relative"><a href="#%EC%BB%A4%EC%8A%A4%ED%85%80-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%9F%AC-%EB%A7%8C%EB%93%A4%EA%B3%A0-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0" aria-label="커스텀 스케줄러 만들고 배포하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>커스텀 스케줄러 만들고 배포하기</h3><p>위의 <code class="language-text">KubeSchedulerConfiguration</code> 로 설정된 스케줄러를 배포해보자.</p><p>쿠버네티스에서 이미 사용 중인 기본 스케줄러를 수정한 뒤 재배포하는 방법도 있겠지만, 여기서는 별도의 스케줄러로 배포한다.
즉 쿠버네티스에 스케줄러가 2개가 배포되는 셈이다.</p><p>이렇게 하는 이유는 다음과 같다.</p><ul><li>기본 스케줄러는 이미 동작 중이기 때문에, 작업 과정에서 혹시나 모를 사이드 이펙트를 최소화하기 위해서다.</li><li>GPU 스케줄러 자체를 애초에 기본 스케줄러와 분리하여 그 역할과 책임을 명확히 다르게 가져간다.</li></ul><p>쿠버네티스 스케줄러를 배포하는 방법은 일반 파드를 배포하는 것과 다르지 않다.
파드 이미지로 <code class="language-text">registry.k8s.io/kube-scheduler:v1.22.5</code> 를 사용하고, <code class="language-text">KubeSchedulerConfiguration</code> 스펙을 가진 설정 파일을 사용한다.</p><p>다음처럼 스케줄러 배포를 위한 파일들을 작성한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token function">mkdir</span> gpu-binpack-scheduler
$ <span class="token builtin class-name">cd</span> gpu-binpack-scheduler</code></pre></div><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># gpu-binpack-scheduler/configmap.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">gpu-binpack-scheduler-config.yaml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    apiVersion: kubescheduler.config.k8s.io/v1beta1
    kind: KubeSchedulerConfiguration
    profiles:
    - schedulerName: gpu-binpack-scheduler
      plugins:
        score:
          enabled:
          - name: RequestedToCapacityRatio
      pluginConfig:
      - name: RequestedToCapacityRatio
        args: 
          shape:
          - utilization: 0
            score: 0
          - utilization: 100
            score: 10
          resources:
          - name: nvidia.com/gpu
            weight: 100
          - name: cpu
            weight: 1
          - name: memory
            weight: 1
    leaderElection:
      leaderElect: false</span></code></pre></div><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># gpu-binpack-scheduler/serviceaccount.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system</code></pre></div><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># gpu-binpack-scheduler/rbac.yaml</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> configmaps
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler<span class="token punctuation">-</span>as<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler<span class="token punctuation">-</span>as<span class="token punctuation">-</span>volume<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>volume<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io</code></pre></div><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># gpu-binpack-scheduler/deployment.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> scheduler
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">component</span><span class="token punctuation">:</span> scheduler
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">component</span><span class="token punctuation">:</span> scheduler
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">node-role.kubernetes.io/control-plane</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">&quot;node-role.kubernetes.io/master&quot;</span>
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">&quot;Exists&quot;</span>
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">&quot;NoSchedule&quot;</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /usr/local/bin/kube<span class="token punctuation">-</span>scheduler
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/scheduler.conf
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authorization<span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/scheduler.conf
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>config=/etc/kubernetes/gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler/gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler<span class="token punctuation">-</span>config.yaml
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/scheduler.conf
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>bind<span class="token punctuation">-</span>address=0.0.0.0
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>port=0
        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.k8s.io/kube<span class="token punctuation">-</span>scheduler<span class="token punctuation">:</span>v1.22.5
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">8</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10259</span>
            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>
        <span class="token key atrule">startupProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10259</span>
            <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler
            <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubeconfig
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/scheduler.conf
            <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  
      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>node<span class="token punctuation">-</span>critical
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">hostPID</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler<span class="token punctuation">-</span>config
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubeconfig
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/scheduler.conf
            <span class="token key atrule">type</span><span class="token punctuation">:</span> FileOrCreate</code></pre></div><p><a href="https://kubernetes.io/docs/tasks/extend-kubernetes/configure-multiple-schedulers/">공식 문서</a>에 있는 내용을 따라했다.
내용을 봐도 <code class="language-text">KubeSchedulerConfiguration</code> 를 Configmap에 넣어 파드에 마운트한 것 말고는 따로 특별한 것은 없다.</p><p>이제 이를 다음처럼 배포하자.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f gpu-binpack-scheduler -n kube-system</code></pre></div><h3 id="binpack-스케줄링-확인하기" style="position:relative"><a href="#binpack-%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0" aria-label="binpack 스케줄링 확인하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Binpack 스케줄링 확인하기</h3><p>이제 의도한대로 잘 스케줄링이 되는지 확인해보자.</p><p>위에서 작성한 <code class="language-text">pod-gpu-1.yaml</code> 을 다음처럼 수정한다.</p><div class="gatsby-highlight has-highlighted-lines" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># pod-gpu-1.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>gpu<span class="token punctuation">-</span><span class="token number">1</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cuda<span class="token punctuation">-</span>vector<span class="token punctuation">-</span>add
    <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/cuda<span class="token punctuation">-</span>vector<span class="token punctuation">-</span>add<span class="token punctuation">:</span>v0.1
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sleep&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;100000&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
    <span class="token key atrule">key</span><span class="token punctuation">:</span> nvidia.com/gpu
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="gatsby-highlight-code-line">  <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>binpack<span class="token punctuation">-</span>scheduler</span></code></pre></div><p>주목할만한 부분은 <code class="language-text">schedulerName</code> 이 추가되었다는 것이다.
<code class="language-text">schedulerName</code> 의 값으로는 위에서 <code class="language-text">KubeSchedulerConfiguration</code> 에서 정의한 <code class="language-text">schedulerName</code> 을 작성해주었다.</p><p>이제 다음처럼 배포한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f pod-gpu-1.yaml -n kube-system
pod/pod-gpu-1 created

$ kubectl get pods -o wide <span class="token operator">|</span> <span class="token function">grep</span> pod-gpu
pod-gpu-1         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s      <span class="token number">10.233</span>.100.157   node7    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span></code></pre></div><p><code class="language-text">node7</code> 노드에 스케줄링 되었다.</p><p>같은 파드 스펙을 이름만 바꿔 하나 더 배포해보자.
이 때 우리가 의도한대로면, 이 파드도 <code class="language-text">node7</code> 노드에 스케줄링 되어야 한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f pod-gpu-2.yaml -n kube-system
pod/pod-gpu-2 created

$ kubectl get pods -o wide <span class="token operator">|</span> <span class="token function">grep</span> pod-gpu
pod-gpu-2         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5s      <span class="token number">10.233</span>.100.157   node7    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span></code></pre></div><p><code class="language-text">node7</code> 노드에 배포되었다.
GPU 리소스를 사용하는 다른 파드들을 배포해도 <code class="language-text">node7</code> 노드에 리소스가 남는한 <code class="language-text">node7</code> 노드로 스케줄링될 것이다.</p><p>이제 GPU 리소스를 클러스터 차원에서 좀 더 효율적으로 사용할 수 있게 되었다.</p><blockquote><p>Binpack 스케줄링 구현을 위한 또 다른 방법으로 오픈소스인 <a href="https://github.com/AliyunContainerService/gpushare-scheduler-extender">gpushare-scheduler-extender</a>
를 활용하는 방법도 있다.
이 오픈소스는 기존 플러그인을 활용하지 않고, 별도의 Device Plugin과 Extend Webhook 서버를 통해 GPU 리소스를 스케줄링 한다. (이 역시 스케줄러 확장 방법 중 하나다.)</p><p>다만 여기서는 외부 의존성을 되도록 최소화 하기 위해 오픈소스를 사용하지는 않았다.
위 링크의 README에 동작 과정에 대해 잘 설명되어 있으니, 관심있는 분은 살펴보면 좋을거 같다.</p></blockquote><h2 id="opa로-code-classlanguage-textschedulernamecode-검증하기" style="position:relative"><a href="#opa%EB%A1%9C-code-classlanguage-textschedulernamecode-%EA%B2%80%EC%A6%9D%ED%95%98%EA%B8%B0" aria-label="opa로 code classlanguage textschedulernamecode 검증하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OPA로 <code class="language-text">SchedulerName</code> 검증하기</h2><h3 id="code-classlanguage-textschedulernamecode-를-작성해주지-않는다면" style="position:relative"><a href="#code-classlanguage-textschedulernamecode-%EB%A5%BC-%EC%9E%91%EC%84%B1%ED%95%B4%EC%A3%BC%EC%A7%80-%EC%95%8A%EB%8A%94%EB%8B%A4%EB%A9%B4" aria-label="code classlanguage textschedulernamecode 를 작성해주지 않는다면 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="language-text">SchedulerName</code> 를 작성해주지 않는다면</h3><p>지금까지의 작업도 꽤 괜찮지만, 한가지 걸리는게 있다.
파드 스펙에 매번 <code class="language-text">schedulerName: gpu-binpack-scheduler</code> 를 작성해줘야한다는 것이다.
만약 이를 작성해주지 않으면 파드는 기본 스케줄러에 의해 스케줄링 되어 Binpack 스케줄링이 깨지게 되고, 다시 Resource Fragementation 문제가 발생하게 된다.
따라서 파드 스펙에 <code class="language-text">schedulerName: gpu-binpack-scheduler</code> 는 &quot;반드시&quot; 작성되어야 한다.</p><p>클러스터 사용자에게 &quot;파드 스펙을 작성하실 때 반드시 <code class="language-text">schedulerName: gpu-binpack-scheduler</code> 를 붙여주세요.&quot; 정도의 가이드는 해주겠지만, 모든 사용자가 이를 지키리라는 보장이 없다.
의도치 않게 실수로 제출될 가능성도 크다.</p><p>따라서 파드 스펙에 <code class="language-text">schedulerName: gpu-binpack-scheduler</code> 이 작성되지 않는 경우, 아예 API Server 단에서 거절해야한다.
그러면 어떻게해야 거절하도록 할 수 있을까?</p><h3 id="dynamic-admission-controller와-opa" style="position:relative"><a href="#dynamic-admission-controller%EC%99%80-opa" aria-label="dynamic admission controller와 opa permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dynamic Admission Controller와 OPA</h3><p>API Server로 제출된 파드를 확인하여 조건에 부합하는지, 그리고 추가로 더 주입해줄 부분은 없는지 확인하는 일은 Dynamic Admission Controller을 통해 가능하다.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:37.16216216216216%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABPElEQVQoz4WQbUvDMBSF+/9/iIiIiJ/ED6KoU6egbmWbumlb19bZdmv6kvRl7SPtcDhUvBDOzc1zDkm0mlWlqsAJIuI0Q6QZH0IhkoxY5sxChcpLRKJwg5gsL4jSvGWaPkwaXpIVJVoqJVPLpPdssXc2ZGR5XOmv7Bz3uB6Y9CcOu6d9ph8LbgYGW0e3OL6gOzDZP+vj+iGXusFBZ0QQSbSqbu5YM48kuuHhiZSpJ+i9vGP7AvNdcKFP8cIUNxA8jF0SlTNxFhx2DWKZtfzQ8klVjsY/tYgL3CAjTIqN+TwqOO/Pf/BaXa9+sdHvq6pW80SW+GGOypbtfllVrfoip6MHP7x/BrZhqmBohejGgrEdUZTL9dnjm2D7xODJFhv+X5/8ZbJmgtP7F25GTquBkGtmYs85uZtgzqKNwE9ruhWNnpYI1QAAAABJRU5ErkJggg==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="4.png" title="4.png" src="/blog/static/09310f62603777824f6fd1a4bca23711/fcda8/4.png" srcSet="/blog/static/09310f62603777824f6fd1a4bca23711/12f09/4.png 148w,/blog/static/09310f62603777824f6fd1a4bca23711/e4a3f/4.png 295w,/blog/static/09310f62603777824f6fd1a4bca23711/fcda8/4.png 590w,/blog/static/09310f62603777824f6fd1a4bca23711/efc66/4.png 885w,/blog/static/09310f62603777824f6fd1a4bca23711/c83ae/4.png 1180w,/blog/static/09310f62603777824f6fd1a4bca23711/9cea8/4.png 1278w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span>
<em>출처: <a href="https://kubernetes.io/blog/2019/03/21/a-guide-to-kubernetes-admission-controllers/">쿠버네티스 공식 문서</a></em></p><p>위 다이어그램에서 Mutating Admission Webhook과 Validation Admission Webhook이 Dynamic Admission Controller이라고 보면 된다.</p><blockquote><p>Dynamic Admission Controller에 대한 자세한 내용은 <a href="https://coffeewhale.com/kubernetes/admission-control/2021/04/28/opa1/">커피고래님 블로그 - 쿠버네티스 Admission Control #1</a>를 참고하고,
여기서는 이런 역할을 하는게 Dynamic Admission Controller라는 것 정도만 알아두자.</p></blockquote><p>Dynamic Admission Controller를 구현하려면 결국 코딩을 해야하는데, 이걸 쉽고 확장성있게 할 수 있도록 돕는 프레임워크가 바로 <a href="https://www.openpolicyagent.org/">OPA(Open Policy Agent)</a>다.</p><p>OPA는 Rego 스크립트라는 언어로 허용/불가에 대한 규칙을 정할 수 있는데, 특정 플랫폼 (쿠버네티스, 클라우드 등)에 국한되지 않고 범용적으로 사용할 수 있다.
예를 들어, Rego 스크립트로 작성한 규칙을 쿠버네티스, 파이썬, 테라폼 등등에 통합하여 사용할 수 있다.</p><p>이렇듯 OPA는 &quot;정책 작성을 위한 프레임워크&quot; 정도로 이해하면 된다.</p><blockquote><p>OPA에 대한 자세한 내용은 다음 두 글을 읽어보기를 추천한다.</p><ul><li><a href="https://coffeewhale.com/kubernetes/admission-control/2021/05/04/opa2/">커피고래님 블로그 - 쿠버네티스 Admission Control #2 - Open Policy Agent</a>와</li><li><a href="https://coffeewhale.com/opa3">쿠버네티스 Admission Control #3 - Open Policy Agent 적용</a></li></ul><p>위 두 글을 읽고나면 앞으로 나올 Rego 스크립트를 조금 더 잘 이해할 수 있을 것이다.</p></blockquote><h3 id="validation-admission-webhook을-위한-rego-스크립트" style="position:relative"><a href="#validation-admission-webhook%EC%9D%84-%EC%9C%84%ED%95%9C-rego-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8" aria-label="validation admission webhook을 위한 rego 스크립트 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Validation Admission Webhook을 위한 Rego 스크립트</h3><p>우리는 파드 스펙에 <code class="language-text">schedulerName: gpu-binpack-scheduler</code> 이 작성되지 않는 경우, 이를 거절해야한다고 했다.
이러한 일은 Validation Admission Webhook에서 담당하면 될 것이고, 이 Webhook 내 규칙은 OPA의 Rego 스크립트를 통해 구현할 수 있을 것이다.</p><p>Rego 스크립트를 다음처럼 작성한다.
(여기서는 현시점 OPA의 가장 최근 버전인 <code class="language-text">v0.44.0</code> 를 기준으로 작성한다.)</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ mkdir opa
$ cd opa</code></pre></div><div class="gatsby-highlight has-highlighted-lines" data-language="rego"><pre class="language-rego"><code class="language-rego"><span class="token comment"># opa/main.rego</span>

<span class="token keyword">package</span> system

<span class="token keyword">import</span> future<span class="token punctuation">.</span>keywords<span class="token punctuation">.</span>in

main <span class="token operator">:=</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;apiVersion&quot;</span><span class="token operator">:</span> <span class="token string">&quot;admission.k8s.io/v1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AdmissionReview&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;response&quot;</span><span class="token operator">:</span> response<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">default</span> uid <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>

uid <span class="token operator">:=</span> input<span class="token punctuation">.</span>request<span class="token punctuation">.</span>uid

response <span class="token operator">:=</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;allowed&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">&quot;uid&quot;</span><span class="token operator">:</span> uid<span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> reason<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token punctuation">{</span>
    reason <span class="token operator">=</span> <span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;, &quot;</span><span class="token punctuation">,</span> deny<span class="token punctuation">)</span>
    reason <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">else</span> <span class="token operator">:=</span> <span class="token punctuation">{</span><span class="token property">&quot;allowed&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token property">&quot;uid&quot;</span><span class="token operator">:</span> uid<span class="token punctuation">}</span>

<span class="token function">has_key</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">_</span> <span class="token operator">=</span> x<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token punctuation">}</span>

<span class="gatsby-highlight-code-line">deny<span class="token punctuation">[</span>msg<span class="token punctuation">]</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  input<span class="token punctuation">.</span>request<span class="token punctuation">.</span>operation <span class="token operator">==</span> <span class="token string">&quot;CREATE&quot;</span></span><span class="gatsby-highlight-code-line">  input<span class="token punctuation">.</span>request<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>kind <span class="token operator">==</span> <span class="token string">&quot;Pod&quot;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">some</span> container in input<span class="token punctuation">.</span>request<span class="token punctuation">.</span>object<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>containers</span><span class="gatsby-highlight-code-line">  <span class="token function">has_key</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>limits<span class="token punctuation">,</span> <span class="token string">&quot;nvidia.com/gpu&quot;</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">not</span> input<span class="token punctuation">.</span>request<span class="token punctuation">.</span>object<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>schedulerName</span><span class="gatsby-highlight-code-line">  msg <span class="token operator">:=</span> <span class="token string">&quot;spec.schedulerName value must be `gpu-binpack-scheduler` when you use nvidia.com/gpu&quot;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">deny<span class="token punctuation">[</span>msg<span class="token punctuation">]</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  input<span class="token punctuation">.</span>request<span class="token punctuation">.</span>operation <span class="token operator">==</span> <span class="token string">&quot;CREATE&quot;</span></span><span class="gatsby-highlight-code-line">  input<span class="token punctuation">.</span>request<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>kind <span class="token operator">==</span> <span class="token string">&quot;Pod&quot;</span></span><span class="gatsby-highlight-code-line">  <span class="token keyword">some</span> container in input<span class="token punctuation">.</span>request<span class="token punctuation">.</span>object<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>containers</span><span class="gatsby-highlight-code-line">  <span class="token function">has_key</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>resources<span class="token punctuation">.</span>limits<span class="token punctuation">,</span> <span class="token string">&quot;nvidia.com/gpu&quot;</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">  input<span class="token punctuation">.</span>request<span class="token punctuation">.</span>object<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>schedulerName <span class="token operator">!=</span> <span class="token string">&quot;gpu-binpack-scheduler&quot;</span></span><span class="gatsby-highlight-code-line">  msg <span class="token operator">:=</span> <span class="token string">&quot;spec.schedulerName value must be `gpu-binpack-scheduler` when you use nvidia.com/gpu&quot;</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span></code></pre></div><p>규칙을 정의한 부분에 대해서만 좀 더 설명하면</p><ul><li>파드 생성이 제출되었을 때,</li><li>파드 내 <code class="language-text">nvidia.com/gpu</code> 리소스를 사용하는 컨테이너가 있고, <ul><li>파드 스펙 내 <code class="language-text">schedulerName</code> 이 정의되어 있지 않다면</li><li>또는 <code class="language-text">schedulerName</code> 이 정의되어 있지만 그 값이 <code class="language-text">gpu-binpack-scheduler</code> 이 아니라면</li></ul></li><li>이 제출은 에러 메시지와 함께 거절한다.</li></ul><p>쉽게 말해, GPU 리소스를 쓰는 컨테이너가 파드 내에 포함되어 있다면 <code class="language-text">schedulerName: gpu-binpack-scheduler</code> 이 반드시 파드 스펙에 있어야
정상적으로 제출된다는 것이다.</p><blockquote><p>파드 생성에 대한 Rego 스크립트 결과는 다음 <a href="https://play.openpolicyagent.org/p/ACVmOnT1i4">Rego Playgroud</a>에서 확인할 수 있다.</p></blockquote><h3 id="opa-배포하기" style="position:relative"><a href="#opa-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0" aria-label="opa 배포하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>OPA 배포하기</h3><p>위 Rego 스크립트를 포함하여 OPA를 배포해보자.</p><blockquote><p>배포 과정에 대한 자세한 설명은 <a href="https://www.openpolicyagent.org/docs/latest/kubernetes-tutorial/">공식 문서</a>를 참고하자.
여기서는 그저 공식 문서에 나온대로 따라간다.</p></blockquote><p>OPA를 배포할 네임스페이스를 다음처럼 생성한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl create namespace opa</code></pre></div><p>위에서 생성한 <code class="language-text">opa</code> 디렉토리에서 다음처럼 TLS 인증서를 만들어둔다. </p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Communication between Kubernetes and OPA must be secured using TLS. </span>
<span class="token comment"># To configure TLS, use openssl to create a certificate authority (CA) and certificate/key pair for OPA</span>
$ openssl genrsa -out ca.key <span class="token number">2048</span>
$ openssl req -x509 -new -nodes -sha256 -key ca.key -days <span class="token number">100000</span> -out ca.crt -subj <span class="token string">&quot;/CN=admission_ca&quot;</span>

<span class="token comment"># Generate the TLS key and certificate for OPA:</span>
$ <span class="token function">cat</span> <span class="token operator">&gt;</span>server.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
[ req ]
prompt = no
req_extensions = v3_ext
distinguished_name = dn

[ dn ]
CN = opa.opa.svc

[ v3_ext ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
extendedKeyUsage = clientAuth, serverAuth
subjectAltName = DNS:opa.opa.svc,DNS:opa.opa.svc.cluster,DNS:opa.opa.svc.cluster.local
EOF</span>

$ openssl genrsa -out server.key <span class="token number">2048</span>
$ openssl req -new -key server.key -sha256 -out server.csr -extensions v3_ext -config server.conf
$ openssl x509 -req -in server.csr -sha256 -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days <span class="token number">100000</span> -extensions v3_ext -extfile server.conf</code></pre></div><p>다음처럼 TLS 인증서를 클러스터에 배포한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl create secret tls opa-server --cert<span class="token operator">=</span>server.crt --key<span class="token operator">=</span>server.key --namespace opa</code></pre></div><p>다음처럼 OPA Deployment와 연관된 리소스를 작성한 뒤 배포한다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># opa/admission-controller.yaml</span>

<span class="token comment"># Grant OPA/kube-mgmt read-only access to resources. This lets kube-mgmt</span>
<span class="token comment"># replicate resources into OPA so they can be used in policies.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> opa<span class="token punctuation">-</span>viewer
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> view
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>serviceaccounts<span class="token punctuation">:</span>opa
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token punctuation">---</span>
<span class="token comment"># Define role for OPA/kube-mgmt to update configmaps with policy status.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> opa
  <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap<span class="token punctuation">-</span>modifier
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;configmaps&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;patch&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token comment"># Grant OPA/kube-mgmt role defined above.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> opa
  <span class="token key atrule">name</span><span class="token punctuation">:</span> opa<span class="token punctuation">-</span>configmap<span class="token punctuation">-</span>modifier
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> configmap<span class="token punctuation">-</span>modifier
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>serviceaccounts<span class="token punctuation">:</span>opa
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> opa
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> opa
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> opa
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> opa
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> opa
  <span class="token key atrule">name</span><span class="token punctuation">:</span> opa
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> opa
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> opa
      <span class="token key atrule">name</span><span class="token punctuation">:</span> opa
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token comment"># WARNING: OPA is NOT running with an authorization policy configured. This</span>
        <span class="token comment"># means that clients can read and write policies in OPA. If you are</span>
        <span class="token comment"># deploying OPA in an insecure environment, be sure to configure</span>
        <span class="token comment"># authentication and authorization on the daemon. See the Security page for</span>
        <span class="token comment"># details: https://www.openpolicyagent.org/docs/security.html.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> opa
          <span class="token key atrule">image</span><span class="token punctuation">:</span> openpolicyagent/opa<span class="token punctuation">:</span>0.44.0<span class="token punctuation">-</span>rootless
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;run&quot;</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--server&quot;</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--tls-cert-file=/certs/tls.crt&quot;</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--tls-private-key-file=/certs/tls.key&quot;</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--addr=0.0.0.0:8443&quot;</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--addr=http://127.0.0.1:8181&quot;</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--log-format=json-pretty&quot;</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--set=status.console=true&quot;</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--set=decision_logs.console=true&quot;</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /certs
              <span class="token key atrule">name</span><span class="token punctuation">:</span> opa<span class="token punctuation">-</span>server
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /health<span class="token punctuation">?</span>plugins<span class="token important">&amp;bundle</span>
              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8443</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8443</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>mgmt
          <span class="token key atrule">image</span><span class="token punctuation">:</span> openpolicyagent/kube<span class="token punctuation">-</span>mgmt<span class="token punctuation">:</span>2.0.1
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--replicate-cluster=v1/namespaces&quot;</span>
            <span class="token punctuation">-</span> <span class="token string">&quot;--replicate=networking.k8s.io/v1/ingresses&quot;</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> opa<span class="token punctuation">-</span>server
          <span class="token key atrule">secret</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> opa<span class="token punctuation">-</span>server</code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f admission-controller.yaml -n opa</code></pre></div><p>다음처럼 OPA Webhook 서버를 AdmissionController의 ValidatingWebhook에 등록해야 한다.
이를 위해 <code class="language-text">ValidatingWebhookConfiguration</code> 오브젝트도 다음처럼 작성한다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># opa/webhook-configuration.yaml</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> ValidatingWebhookConfiguration
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> admissionregistration.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> opa<span class="token punctuation">-</span>validating<span class="token punctuation">-</span>webhook
<span class="token key atrule">webhooks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> validating<span class="token punctuation">-</span>webhook.openpolicyagent.org
    <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
      <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> openpolicyagent.org/webhook
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> NotIn
        <span class="token key atrule">values</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> ignore
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">operations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;CREATE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;UPDATE&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">apiVersions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;v1&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;pods&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">clientConfig</span><span class="token punctuation">:</span>
      <span class="token key atrule">caBundle</span><span class="token punctuation">:</span> <span class="token string">&quot;...&quot;</span>
      <span class="token key atrule">service</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> opa
        <span class="token key atrule">name</span><span class="token punctuation">:</span> opa
    <span class="token key atrule">admissionReviewVersions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;v1&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">sideEffects</span><span class="token punctuation">:</span> None</code></pre></div><p>이 때 위에서 생략한 <code class="language-text">caBundle</code> 값은 다음처럼 얻을 수 있다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> ca.crt <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">&#x27;\n&#x27;</span><span class="token variable">)</span></span></code></pre></div><p><code class="language-text">kube-system</code> 과 <code class="language-text">opa</code> 네임스페이스에 한해서는 OPA의 Validation 기능을 꺼두도록 하자.
이를 위해서는 다음처럼 네임스페이스에 라벨을 추가해주면 된다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl label ns kube-system openpolicyagent.org/webhook<span class="token operator">=</span>ignore
$ kubectl label ns opa openpolicyagent.org/webhook<span class="token operator">=</span>ignore</code></pre></div><p>이제 작성한 <code class="language-text">ValidatingWebhookConfiguration</code> 를 다음처럼 배포하자.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f webhook-configuration.yaml -n opa</code></pre></div><p>이제 마지막이다.
위에서 작성한 <code class="language-text">main.rego</code> 를 컨피그맵으로 배포한 뒤, OPA 서버가 이를 읽어갈 수 있게 라벨을 추가한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl create cm main -n opa --from-file<span class="token operator">=</span>main.rego 
$ kubectl label  cm main -n opa openpolicyagent.org/policy<span class="token operator">=</span>rego </code></pre></div><blockquote><p>Rego 스크립트에 문제가 없다면, 다음처럼 컨피그맵 조회 시 <code class="language-text">annotations</code> 내 <code class="language-text">openpolicyagent.org/policy-status</code> 값이 <code class="language-text">&#x27;{&quot;status&quot;:&quot;ok&quot;}&#x27;</code> 이 되어 있는 것을 볼 수 있다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get cm main -o yaml

kind: ConfigMap
metadata:
  annotations:
    openpolicyagent.org/policy-status: <span class="token string">&#x27;{&quot;status&quot;:&quot;ok&quot;}&#x27;</span>
<span class="token punctuation">..</span>.</code></pre></div></blockquote><h3 id="작동-확인하기" style="position:relative"><a href="#%EC%9E%91%EB%8F%99-%ED%99%95%EC%9D%B8%ED%95%98%EA%B8%B0" aria-label="작동 확인하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>작동 확인하기</h3><p>OPA Webhook이 잘 작동하는지 확인해보자.</p><p>다음처럼 GPU 리소스를 사용하며, 스펙에 <code class="language-text">ScheculerName</code> 을 작성하지 않은 파드를 제출한다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># pod-gpu-3.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>gpu<span class="token punctuation">-</span><span class="token number">3</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cuda<span class="token punctuation">-</span>vector<span class="token punctuation">-</span>add
    <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/cuda<span class="token punctuation">-</span>vector<span class="token punctuation">-</span>add<span class="token punctuation">:</span>v0.1
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sleep&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;100000&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
    <span class="token key atrule">key</span><span class="token punctuation">:</span> nvidia.com/gpu
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
<span class="token comment">#  schedulerName: gpu-binpack-scheduler</span></code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl create ns <span class="token builtin class-name">test</span>
$ kubectl apply -f pod-gpu-1.yaml -n <span class="token builtin class-name">test</span>

Error from server: error when creating <span class="token string">&quot;pod-gpu-1.yaml&quot;</span><span class="token builtin class-name">:</span> admission webhook <span class="token string">&quot;validating-webhook.openpolicyagent.org&quot;</span> denied the request: spec.schedulerName value must be <span class="token variable"><span class="token variable">`</span>gpu-binpack-scheduler<span class="token variable">`</span></span> when you use nvidia.com/gpu</code></pre></div><p>위처럼 에러 메시지와 함께 파드 제출이 거절되는 것을 볼 수 있다.
또, <code class="language-text">schedulerName</code> 이 <code class="language-text">gpu-binpack-scheduler</code> 이 아닌 경우에도 위와 같은 에러를 내는 것을 확인할 수 있다.</p><p>이제 사용자는 파드 스펙에 <code class="language-text">schedulerName: gpu-binpack-scheduler</code> 를 반드시 붙여주어야 정상적인 파드 제출이 가능하게 되었다.</p><h2 id="리소스-모니터링하기" style="position:relative"><a href="#%EB%A6%AC%EC%86%8C%EC%8A%A4-%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81%ED%95%98%EA%B8%B0" aria-label="리소스 모니터링하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>리소스 모니터링하기</h2><h3 id="prometheus와-grafana-배포하기" style="position:relative"><a href="#prometheus%EC%99%80-grafana-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0" aria-label="prometheus와 grafana 배포하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prometheus와 Grafana 배포하기</h3><p>GPU 사용량 등의 Metric을 모니터링하기 위해 Prometheus와 Grafana를 사용할 것이다.
(정확히 말하면 Prometheus Operator를 사용할 것이다.)</p><blockquote><p>Prometheus와 Grafana는 여기서 다루기에 너무 큰 주제라, 여기서는 이 둘에 대해 별도로 설명하지는 않는다.
만약 처음 들어보시는 분이라면, 구글링해서 찾아보시길 추천한다. 검색하면 입문자들이 읽어볼만한 좋은 글들이 많이 나온다.</p></blockquote><p>먼저 클러스터에 Prometheus와 Grafana를 배포해야한다.
만약 이미 클러스터에 배포된 상태라면 이 내용은 패스해도 좋다.</p><p>이 둘을 배포하는 가장 쉬운 방법 중 하나는 <code class="language-text">kube-prometheus-stack</code> Helm Chart를 배포하는 것이다.</p><p>다음처럼 Helm Chart를 받아온다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ helm repo <span class="token function">add</span> prometheus-community https://prometheus-community.github.io/helm-charts
$ helm repo update
$ helm pull prometheus-community/kube-prometheus-stack --untar
$ <span class="token builtin class-name">cd</span> kube-prometheus-stack</code></pre></div><p>내가 받은 Chart의 버전은 <code class="language-text">40.1.2</code> 이다.
Chart 버전에 내용이 달라질 수 있음을 인지해두자.</p><p><code class="language-text">values.yaml</code> 에서 다음 파라미터들을 수정한다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">prometheus</span><span class="token punctuation">:</span>
  <span class="token key atrule">prometheusSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">serviceMonitorSelectorNilUsesHelmValues</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">podMonitorSelectorNilUsesHelmValues</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre></div><p>이 값을 <code class="language-text">false</code> 로 두면, 다른 네임스페이스에 존재하는 <code class="language-text">ServiceMonitor</code> 오브젝트들도 이 Prometheus 오브젝트에서 관리하게 된다.
(이 값이 <code class="language-text">true</code> 면 별도의 라벨링을 추가해야 한다.)</p><p>이제 Chart를 다음처럼 배포한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ helm <span class="token function">install</span> kube-prometheus-stack kube-prometheus-stack -n kube-prometheus-stack --create-namespace</code></pre></div><p>성공적으로 배포했다면, 다음과 같은 리소스들이 배포된다.</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ kubectl get all -n kube-prometheus-stack
             
NAME                                                           READY   STATUS    RESTARTS   AGE
pod/alertmanager-kube-prometheus-stack-alertmanager-0          2/2     Running   0          29s
pod/kube-prometheus-stack-grafana-559b476bcb-79k5b             3/3     Running   0          35s
pod/kube-prometheus-stack-kube-state-metrics-8ff55f6c9-wj5f7   1/1     Running   0          35s
pod/kube-prometheus-stack-operator-65c968d89f-j7lsg            1/1     Running   0          35s
pod/kube-prometheus-stack-prometheus-node-exporter-7zhs4       1/1     Running   0          35s
pod/kube-prometheus-stack-prometheus-node-exporter-89hmf       1/1     Running   0          34s
pod/kube-prometheus-stack-prometheus-node-exporter-bd89s       1/1     Running   0          35s
pod/kube-prometheus-stack-prometheus-node-exporter-hr6xc       1/1     Running   0          34s
pod/kube-prometheus-stack-prometheus-node-exporter-psmxb       1/1     Running   0          35s
pod/kube-prometheus-stack-prometheus-node-exporter-qcm46       1/1     Running   0          34s
pod/kube-prometheus-stack-prometheus-node-exporter-qscls       1/1     Running   0          34s
pod/prometheus-kube-prometheus-stack-prometheus-0              2/2     Running   0          28s

NAME                                                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                            ClusterIP   None           &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   29s
service/kube-prometheus-stack-alertmanager               ClusterIP   10.233.27.81   &lt;none&gt;        9093/TCP                     35s
service/kube-prometheus-stack-grafana                    ClusterIP   10.233.2.62    &lt;none&gt;        80/TCP                       35s
service/kube-prometheus-stack-kube-state-metrics         ClusterIP   10.233.45.1    &lt;none&gt;        8080/TCP                     35s
service/kube-prometheus-stack-operator                   ClusterIP   10.233.5.111   &lt;none&gt;        443/TCP                      35s
service/kube-prometheus-stack-prometheus                 ClusterIP   10.233.9.65    &lt;none&gt;        9090/TCP                     35s
service/kube-prometheus-stack-prometheus-node-exporter   ClusterIP   10.233.49.24   &lt;none&gt;        9100/TCP                     35s
service/prometheus-operated                              ClusterIP   None           &lt;none&gt;        9090/TCP                     28s

NAME                                                            DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
daemonset.apps/kube-prometheus-stack-prometheus-node-exporter   7         7         7       7            7           &lt;none&gt;          35s

NAME                                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/kube-prometheus-stack-grafana              1/1     1            1           36s
deployment.apps/kube-prometheus-stack-kube-state-metrics   1/1     1            1           36s
deployment.apps/kube-prometheus-stack-operator             1/1     1            1           36s

NAME                                                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/kube-prometheus-stack-grafana-559b476bcb             1         1         1       36s
replicaset.apps/kube-prometheus-stack-kube-state-metrics-8ff55f6c9   1         1         1       36s
replicaset.apps/kube-prometheus-stack-operator-65c968d89f            1         1         1       36s

NAME                                                               READY   AGE
statefulset.apps/alertmanager-kube-prometheus-stack-alertmanager   1/1     30s
statefulset.apps/prometheus-kube-prometheus-stack-prometheus       1/1     29s</code></pre></div><h3 id="gpu-metric을-위한-servicemonitor-배포하기" style="position:relative"><a href="#gpu-metric%EC%9D%84-%EC%9C%84%ED%95%9C-servicemonitor-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0" aria-label="gpu metric을 위한 servicemonitor 배포하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>GPU Metric을 위한 ServiceMonitor 배포하기</h3><p>GPU Metric은 GPU Operator로 배포한 DCGM Exporter가 수집해준다.
이는 다음처럼 확인할 수 있다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get svc -n gpu-operator

NAME                                         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
<span class="token punctuation">..</span>.
nvidia-dcgm-exporter                         ClusterIP   <span class="token number">10.233</span>.42.33    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9400</span>/TCP   32h</code></pre></div><p>Metric이 정말 찍히고 있는지 다음처럼 확인할 수 있다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl port-forward svc/nvidia-dcgm-exporter <span class="token number">9400</span>:9400 -n gpu-operator</code></pre></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:64.86486486486486%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACS0lEQVQ4y3WS0W6bMBSG8wAksQ2FYAoujZJCBCW1qaoq0CiZ2uu9ydaLjavtBbbcrevVpL3lVoF8puOGaFW3i18cS8nn//+PBw6x3kaCf8+z9Mt0Gu8opbvRaLQbj8c7Qsg/hb9hjO1s2zZizP7qufY394isBos0+alKBXVdwXK5hCRJYDabQRzHEEURnJycgBDiIDwfHx/DZDIBzjkEQQCcBxCFHAL/qBmUZflwc3MD2+32l5SyzfO8nc/nbRRFre/7LefcCOf+7HleSwhpKaXmSwj5TQiB8Zi8GyilHuu6hs1m0yoldZZlkKYpTKdTczu6RIVhaIQzOqOUAmMMpRljHc6UkvvB5eXl43q9htvb27aqKl0UBSwWCxP99PTUxOth/YwXOY4DzxBqgHgBIeQeIxuH2+22Xa1WWikFCJ3P5wc3CHjuih/Onuf1Ll8CpZSPVVVBXdftcrnU6A5hffn9MvroOCNw7+41EB3iUtbrdauU0nmem7j4536Tvu+/kOu6rzo8ALHDPnJZlqZDKaV5OgjFHvEJoWMUntHhf4G4ZYyMDi8uLtChTtNUCyF0EASac65939eTycQIZ8dxNCEEQfrVUpRSDwjcbDZP19fXnZSyK4qiS5Kki+PYSAjRRVF0UBiGneu6COn2T+ZpD3yPkX9gh3d3dxgbrq6uAHvEyPgWcTG9+m3jjF3+tRjYAz8Mzs7O3mRZ9lkp9bEoiibLsub8/LyZzWaNEKKxbbuhlB6+jDEjx3Ga0WjUWJbVDIfDj8Ph8JNlWfIP1YdDWm9w/yMAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="5.png" title="5.png" src="/blog/static/d147783d285534f1e3fcd82dc9e94814/fcda8/5.png" srcSet="/blog/static/d147783d285534f1e3fcd82dc9e94814/12f09/5.png 148w,/blog/static/d147783d285534f1e3fcd82dc9e94814/e4a3f/5.png 295w,/blog/static/d147783d285534f1e3fcd82dc9e94814/fcda8/5.png 590w,/blog/static/d147783d285534f1e3fcd82dc9e94814/efc66/5.png 885w,/blog/static/d147783d285534f1e3fcd82dc9e94814/c83ae/5.png 1180w,/blog/static/d147783d285534f1e3fcd82dc9e94814/69d6b/5.png 1912w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></p><p>이제 이 Metric 정보를 Prometheus에서 수집하기 위해 다음처럼 <code class="language-text">ServiceMonitor</code> 를 추가하자.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># servicemonitor.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> dcgm<span class="token punctuation">-</span>exporter
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nvidia<span class="token punctuation">-</span>dcgm<span class="token punctuation">-</span>exporter
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>metrics
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/metrics&quot;</span>
    <span class="token key atrule">relabelings</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
      <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> __meta_kubernetes_pod_node_name
      <span class="token key atrule">targetLabel</span><span class="token punctuation">:</span> node
    <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labeldrop
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token string">&quot;Hostname&quot;</span></code></pre></div><p>중간에 Relabeling 하는 내용이 있는데, 기존 Metric에서 <code class="language-text">Hostname</code> 라벨 값이 올바르지 않아 이를 수정하는 작업이라 보면 된다.
(아무래도 DCGM Exporter 쪽의 버그같다.)</p><p>다음처럼 배포한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f servicemonitor.yaml -n gpu-operator</code></pre></div><p>그러면 다음처럼 Prometheus 대시보드에서 이 Metric이 정상적으로 수집되는 것을 볼 수 있다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl port-forward svc/kube-prometheus-stack-prometheus <span class="token number">9090</span>:9090 -n kube-prometheus-stack</code></pre></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:64.86486486486486%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxklEQVQ4y3WRS48bRRSFe80i435UV1V3dVU/yna33fF4PGPPZGY8jxAiJFhEWSQZCTYI5bGIJrMIng3iB5BJJEQwEkLiB7BgzYK/BVFZdVDbjlAUsvh0S3Wlo3POdYjfulPo7Kfh1vD7suxc+b5/5XnuCte9cj9As/M978pb8SIk3o8k2DhwJuOd3w73d7G/N8Z4bx+D0RjV9SH6myP0ByP0N7ffo27mcjdCPVz97U+n2NoezZzOwd3X5WfPwKZf/x3poYllapQuDYulYUluSKQM4XJJwIQJWGx8GhkmlImVNpEsTKSKf0TaBk/yc4d09uZk6w7C7buGdsaWZjXizjZo9wbCwEXgXkPgtRD4LkIeI4wSxDIDEwo8ycBFanmSLZhIEfLkwlG6midFCSq1YbJto7wLodsQ1QSdz58ju32O7OMnUMdfQdc7ULlGt7+JJGuvRRvBdMGTFDSWF04oijlNK9CsZ5jILFcZuIrBy110z/9C9+mf0F/+gvzeK8hqB1GiIFKNxlEjyERqmUgXzZtG8sKhUs9Z1gPL+k1nNkpzRGmCuNxF+eQPdB/+jvYXP0PfewHVG0PIFKroLuM2ou85pCKdM6nBmshJbpkswIRE1N1B++wH6PsvoW6fQ918jKioweIEfN3hGsuEWjtMLhySD+ekOgKpjgyppnb1noKUByDlIUjnBsLJGZhsg3EGluRrZ9lblkfhzVEawbAYzWn/Jmjv1NDeiX2H6tiywaeWTR9ZllaWFQPLG0dJZtfd2f86XAtKPXqt61Po+vRN0T9Z6HpF0T9a0u4dLqLx/QXdPVvwYrOJtlg6epc3a8FnDskGv4bVFGHZcICwPFzOZeTeCcL6E9DJA7Drt95e9YOEUfLcabn+Ldcn37W8YNbygssV/uVGEF1uqK1ZK5/M/PJ45l77aOYSPnMD+n984wX025ZPRv8CN35SNHn7T4kAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="6.png" title="6.png" src="/blog/static/c930723e64e308347223afcfecc915a6/fcda8/6.png" srcSet="/blog/static/c930723e64e308347223afcfecc915a6/12f09/6.png 148w,/blog/static/c930723e64e308347223afcfecc915a6/e4a3f/6.png 295w,/blog/static/c930723e64e308347223afcfecc915a6/fcda8/6.png 590w,/blog/static/c930723e64e308347223afcfecc915a6/efc66/6.png 885w,/blog/static/c930723e64e308347223afcfecc915a6/c83ae/6.png 1180w,/blog/static/c930723e64e308347223afcfecc915a6/69d6b/6.png 1912w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></p><blockquote><p>DCGM Exproter가 찍어주는 Metric에 대한 정보는 <a href="https://docs.nvidia.com/datacenter/dcgm/1.6/dcgm-api/group__dcgmFieldIdentifiers.html">공식 문서</a>에서 확인할 수 있다.</p></blockquote><h3 id="grafana에-대시보드-추가히기" style="position:relative"><a href="#grafana%EC%97%90-%EB%8C%80%EC%8B%9C%EB%B3%B4%EB%93%9C-%EC%B6%94%EA%B0%80%ED%9E%88%EA%B8%B0" aria-label="grafana에 대시보드 추가히기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Grafana에 대시보드 추가히기</h3><p>Metric 수집까지 마쳤으니, 이제 Grafana에 수집한 Metric을 가지고 대시보드를 만들어보자.</p><p>먼저 다음처럼 웹 브라우저에서 Grafana 대시보드에 접속한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl port-forward svc/kube-prometheus-stack-grafana <span class="token number">8888</span>:80 -n kube-prometheus-stack</code></pre></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:64.86486486486486%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAADUUlEQVQ4y23L21MadxjG8d0Fl13ksCxHOSzLGYIILHJQEKKCWuMh2iJRYxsd6yFmklAT6aTTdnrT6Uxqr5py1Zn+l23mt/N7Ol2TaS968Zn34n2+jFu2PYzGAr+lssm3YTVy65Cdtzan7dYm2W/t/8PxH5LL8dHPXq/jV4/b1mQelZf+eNbexDfrfbxZ3cbX3Q2MljdxvbiN550dnLc+w/H8Hg4bA/TrA+zUBticHWBV20NXG6BTGmCu0EejsINipjdizrT9d6O5E/zQPv3zp6ULctu7Ir+sPCdvey/Jj8tfke8XX5E392/IdWdEnrVH5Lx1Q57Mvyb79VdkZ/aarJWGZLHw4q9G7grFxOELZiOzOd4vDHBcPiRnlc/pZfUYV7Uv8bR2jvPqBU6rl3hceYoDwyX62iUeli+wXjxHt3CG9r1T2sie6FrqCLno1pDpqL3xWnILW5ldspvbo/38AQbTRzgonKCb3cBMbA4P8vNYyjaRj82jnd3Fav4U93NP0Mp8gVrqiJYT+3pe/RTJ8MqQqYQWxk2lh476CVmKb9BeYhsryV2spx+hEmsjHi2h39SwVpuFqpSgxVfQSj1GLTGAFuujoO7QnLKpJ0NrUPwLQybrrY5nAi1owQ6phhZpPdxFQ1lBM/oA00oD+bSGbLJiSESnkYt0UFK2kQ+vIxNeQyLYpWpgUY/4Wgi4K0NGkabHcbmMlGeWZLx1mvPNIe9vYtq/gHSkBjVVw1RkBlPhGUwpBcSCdST8Haj+FhTfPELeOp1yV3WfXIbbeW/IeCdjY78tjaA9R8LOPI1IBSiuIqJSEUpIQ7J6iHTtCNnmKVL1IwQDJQRcJfjlInyuAjxSnsqOnC7Z03DY1CFjtwTGDiEISQgTl6hQ2apS92SceiYT1OOIU7dTuSNFqdulUtmZoC57gkq2OHXaYtQ+GaU2a0S3iiGIgn/I8GbnO4tZgsXsei+YZV2YcOsi7/3Ap4t8QBct/7Ia/Loo+HXR4tMF3qPzE/L7CbMLE2bHS4bj+N9Z1gLOIBhYVoCFd0AQJINocMEqygaLxQmTyXqHEz80PDiOf82wLLfMstx3LMvdsCw3YlmTwWSaGJnN/Mhs4u+uwWL45/dxd9cY7bcsy2l/AyrwX5uaPyxdAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="7.png" title="7.png" src="/blog/static/c5fa039b8ad2f241029382fd3e22e0bc/fcda8/7.png" srcSet="/blog/static/c5fa039b8ad2f241029382fd3e22e0bc/12f09/7.png 148w,/blog/static/c5fa039b8ad2f241029382fd3e22e0bc/e4a3f/7.png 295w,/blog/static/c5fa039b8ad2f241029382fd3e22e0bc/fcda8/7.png 590w,/blog/static/c5fa039b8ad2f241029382fd3e22e0bc/efc66/7.png 885w,/blog/static/c5fa039b8ad2f241029382fd3e22e0bc/c83ae/7.png 1180w,/blog/static/c5fa039b8ad2f241029382fd3e22e0bc/69d6b/7.png 1912w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></p><p>초기 계정 아이디는 <code class="language-text">admin</code> 비밀번호는 <code class="language-text">prom-operator</code> 이다.</p><p>Nvidia에서 기본적으로 DCGM Exporter에 대한 Grafana 다음과 같은 대시보드 만들어두었다.</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://grafana.com/grafana/dashboards/12239</code></pre></div><p>대시보드에 이를 추가한다.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:64.86486486486486%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAABzklEQVQ4y5WRz27TQBCHfcYh+393dte7dmzTKGpRW24IcUBcOPIMvAD0QH2CF4DeKDkh8ZZQbeRBduKqIlGhh0+jlWa+Gf02U4K8beri+9npyZflsr3inI0Iwa84vx8hxAjn/KvR4ptW9EVWl+FnjBUeLVd4cvwU67pFAD9ihmqLw4BH6wI6H9G6iCEEdBa6rKyaa8oMUg6/yuYsxcVx0qZIQrkklU+UqUSZToybPegEM78J1Tgn8n3Wtqs1FwYVLNL5q3f98vwNWh/RFdW42cUn6EKD4AKCi3tYX/YGwoZxg5Spi8z6cs0EoNIu1XXbh1BhiA2CjSgVYFw+x9CcIlg/DB+iNzZsKNNIqLrINBRrLgC5tEko3283aRzqsIhSgdpsZfddeCs0k1AMWch+yHOSTmJjw63w7nWHhTasGVeoXZuq1cteGzcK7jKJ/k84XmhQ6iL58qgfPuRQVn/L/iEEFBISuNCDiw9iT1iExfUoVPbGFdXG+vJBDDPGhpud8ENWL6ofQsIYvtQOpdqitEdldmi/9576hhkhLe6EHzOl4fV8zj/nM3KZ56QbeJTPO0JEx5jqGJMd3bF9q45QMfZM/XlOLmeP6afZjDz7AxixLVIH0ltSAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="8.png" title="8.png" src="/blog/static/4f50ec9535e7c218ce2a57c3328e5569/fcda8/8.png" srcSet="/blog/static/4f50ec9535e7c218ce2a57c3328e5569/12f09/8.png 148w,/blog/static/4f50ec9535e7c218ce2a57c3328e5569/e4a3f/8.png 295w,/blog/static/4f50ec9535e7c218ce2a57c3328e5569/fcda8/8.png 590w,/blog/static/4f50ec9535e7c218ce2a57c3328e5569/efc66/8.png 885w,/blog/static/4f50ec9535e7c218ce2a57c3328e5569/c83ae/8.png 1180w,/blog/static/4f50ec9535e7c218ce2a57c3328e5569/69d6b/8.png 1912w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:64.86486486486486%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB90lEQVQ4y5WSy27TQBSGvcYh9sx47jMee5zEzYWmIHXFkhW7vgl0Qb2CF4DsKFkh8ZZQOfJBM0kqaEolFp+sc+bom/9onFCSXTXefLtYrz63bbNBGG0wxhtCcPw+BSEkgjH+whn5ymj+OvHO/ijLCmbtHFYvLsD7GXChIyIgzeMIA1JZULoEqUqw1oKSokuca25zxCFH/KctJ33ppr2QVV8w0xOq+hyxPZifgo6wX1nOYJwV75LJ5GyLiQDKTX+2WA/NdAH1ZAmlX4AyFWhbg3UNSO1i/Rf73sCl3SEcQtHrRGq3DQUTtp/MluEQhCpBhlW0A116qPwsCkL9kKMwRwyynF4nTJi9kJve1bNBWw9clkCZDr1wERwveQyp3cDFH0IuzX3C+eLlUNUtGOsjUjkoChofIaQ5CO55Wsh1v1ydD9N2BX4yh2Y6B1e30F5egW3OQUh9su4/hHaLMAOufL+6fDuY0gPlGpjYr6urJUjTnKR7Uogxh4LZ3jbrQdt6EKocwmAclnoQyg5Cudh/yInQ2Po2/DakkHdSmZ3U7r9Qptpxae8OwveJr6vvpBCAYkoNBVWR8Mph9QjTJ/VxrmAqhIGD8ENCmXgzHuNP6Si7SdOsCzxLx12WkQ4h2iFUdPmBfU27LCdx5jifptnN6Hn+cTTKXv0GA+IwB/nDA/EAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="9.png" title="9.png" src="/blog/static/5754f0f2c94fa5b18f2c995b3c1e594f/fcda8/9.png" srcSet="/blog/static/5754f0f2c94fa5b18f2c995b3c1e594f/12f09/9.png 148w,/blog/static/5754f0f2c94fa5b18f2c995b3c1e594f/e4a3f/9.png 295w,/blog/static/5754f0f2c94fa5b18f2c995b3c1e594f/fcda8/9.png 590w,/blog/static/5754f0f2c94fa5b18f2c995b3c1e594f/efc66/9.png 885w,/blog/static/5754f0f2c94fa5b18f2c995b3c1e594f/c83ae/9.png 1180w,/blog/static/5754f0f2c94fa5b18f2c995b3c1e594f/69d6b/9.png 1912w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></p><p><code class="language-text">Import</code> 버튼을 누르면 다음처럼 대시보드가 추가된다.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:64.86486486486486%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAADEUlEQVQ4y2XTz2/kNBQH8EgcQZ1Ofk0mcewkzi/bk8l0pr9m2u6W3UVsd7uAqJDKcuBYEOJHD2xOcEMcoDeWOSHxX8Iqkb8oqZCQOHz0np+tJ9uyDcccfRRH/u+LWv5SFPzONM278Xh8Z9vWwHHsO9v+P8uyBv160zR/nTjmb669e2IkLPwzTXNU1QJSVshygTjJEIYxCGEIAnof/yugYBEfUJaAkAhxHIEEfmMwlrwOaIog5H8RmrYhy9o+TqasDcK09XzWWo7fWk4wcCY90roeaU1z2kZZ3kZ5/rftBhib3rdGkhTbKOEoVN7mMtO5zFD0VAZRlZBV2c+hnBXIRQYhKwi1h4QLVOc1UiV1nJVdLApYtndr2C7ZKiXx4YvT9vJio59fbPD8Yo3LPj5d4+LpMfra5bMN3ntyiFm1h1LuQdQ13v/6MZhItRdHnchLcBL2Df1tfw9KiVZKoZUUfQ4pBRZ1jbqe49+aECVYnIJGORjPEc4zzOYzLZTsXJ8idEnfcLrlXEKog5ZxpcNYgMYSYSzBuALjsyHvkahEkgrkosY0ynFeSDTHZ7pZn3XnUuGtXevWGJmT7dH+Pr75/Lq9ub7SN9dXuLn+GPfxCl98eoUvX17hq88+wcsPnmFWLVHVhxCzOX46eYiSJHoept3Px6fIGLk1LMff8jTD6Xq/PTla6ZPjFR6eHPVjbA6XWB8usTlaDeOD5WLYIc8UhJrjSTFDRhKtKO8e9af02a3hToItoSm8adyaTqB7PuPa9Zn2w0RHqdKUS+0FiXa8UE8Dqj2fakITbQdMT3yqaVp0PhewJuTWcKfktSjnON3bf5Nw3qU87WYL1ZWy6EpRdYvlcVfV+12U5J1PosGURJ3ns84P7klZvynFHN40/M6glP6RJBnePT3A2XqFB5sVHj3oj7xCXqjhzRWiBh1+RTRgUYyYp4jiBIQypJkCzyRcj3xvuK73eDS2f3x7x3r1zshudnbdxidJY7tBMxrbzdhym7HpDCzbbUzLadzJtEnToglp1JhWv8Z5NTadH3ZG5vIfvxdXoO3ZPh4AAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="10.png" title="10.png" src="/blog/static/c8bac8543e1e104141aecfb421e6550a/fcda8/10.png" srcSet="/blog/static/c8bac8543e1e104141aecfb421e6550a/12f09/10.png 148w,/blog/static/c8bac8543e1e104141aecfb421e6550a/e4a3f/10.png 295w,/blog/static/c8bac8543e1e104141aecfb421e6550a/fcda8/10.png 590w,/blog/static/c8bac8543e1e104141aecfb421e6550a/efc66/10.png 885w,/blog/static/c8bac8543e1e104141aecfb421e6550a/c83ae/10.png 1180w,/blog/static/c8bac8543e1e104141aecfb421e6550a/69d6b/10.png 1912w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></p><blockquote><p>사실 위 대시보드로는 내게는 조금 부족하여, 다음처럼 직접 별도로 만들었다.
<span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:64.86486486486486%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAADH0lEQVQ4y12Sy29bRRTG7z+AnJhWYYVYIaR2QXf8AawQWSCgUKpKLMIFCRZdgCUkWLBF4lnfRHnUteskbQSCOLbzclRUBCJVEpOkDxzHvnEip8Gxfa/vczwzd+ZDdiIrYqSfvu87cxZHZ0Z5NvTMqy88/9zkpZcvjl248NLEwMDARDgcnujv7+8RCoV69PX19bRD+KRn9Hw4PH0uFHpHScbGvkylZpHJZpHNZjGbSiE1N4fFpUUsLC5ifmEB6Uyme9fpyWQyXU1n0kin06d5HrmlJUwmEjHloKJ/ygMJ1/NJu004gC4eoT3fgQWCyzP5fxAAqB4+/VHJr69FXI/Achj3KaRpU7gU+O3vJgybYOOfJnIPCvDcI0BKAAFo24Pr2rDsHtz1XBQKBU3Z2d2LUNKAcB9xkEcS3gbgbYNYBdRNG5VjhmLVwkHNQt0WqNsBai2GWouCMg7GKHzS5oQGKJbKmnL4L4sc7c3h/syLPPvToPwh+Q2+Tozgi9gc3htu4N0RB1dGHLwdtXFZs3BZs/HmDRvvjzsgDAg4hef5XAiJUrmsKU+r+5H9oyZWto758rYr05tAh/ktieUtB8tbNnJdrBO/fVK799CG4xEwzsAY44EIUNZ1TSnreqQzNvVtDkmkax4C8CFZ63TfARhtw2jZXd8l8MGpA8d1YTtOB+75PnaKRU3Z08sRygI0LcGZhGxaElQAto/ecQhw3Ap6ORAAZRKEtEHa7dMdMuyWSpqi7zcjvvkYZn6QN9dfk2Z+UDbWX5f1jTfkwYOrUl8dkuXVD2VpVZW7Xf1I7v6lSn3tuhSBJxnj0nFc1nmUnWIpquwUDz4zag+xufIW3bx3TfyRuy5+z0XEyvJXYjp7Rwyn7ovvZvPi+zN8++uG0DKbwvWpkFIIHgS0M3mlUokq+bU/Pz+uG9CrLo4MoOECNQuo1gUarQC2F8CwfBgWgXmGTq1pmDBNE4Zpdv/j4ydPRpWR0fGLU1OTH0/dHh+aTo598MtMTP357k01GR9W707fUmfuTKqJeExNJM7Qywk1Ho+rt+LxodvJ5Cc3otFX/gMRAkehA3yvugAAAABJRU5ErkJggg==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="11.png" title="11.png" src="/blog/static/fea03874f4875754764aad7dae9d6092/fcda8/11.png" srcSet="/blog/static/fea03874f4875754764aad7dae9d6092/12f09/11.png 148w,/blog/static/fea03874f4875754764aad7dae9d6092/e4a3f/11.png 295w,/blog/static/fea03874f4875754764aad7dae9d6092/fcda8/11.png 590w,/blog/static/fea03874f4875754764aad7dae9d6092/efc66/11.png 885w,/blog/static/fea03874f4875754764aad7dae9d6092/c83ae/11.png 1180w,/blog/static/fea03874f4875754764aad7dae9d6092/6ac4e/11.png 3824w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span>
궁금하신 분은 <a href="https://github.com/heumsi/grafana-dashboards/tree/main/kube-gpu-resources-cluster">이 Repository</a>를 참고하길 바란다.</p></blockquote><h2 id="나가며" style="position:relative"><a href="#%EB%82%98%EA%B0%80%EB%A9%B0" aria-label="나가며 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>나가며</h2><p>위의 내용을 다시 회고하며, 지금까지 한 작업을 정리하면 다음과 같다.</p><ul><li>GPU Operator로 쿠버네티스에서 GPU를 사용할 수 있는 환경을 세팅했다.</li><li>GPU를 사용하는 파드들을 좀 더 리소스 효율적으로 스케줄링 하기위해 Binpack 스케줄러를 별도로 배포했다.</li><li>GPU를 사용하는 파드들은 반드시 Binpack 스케줄러를 사용하게끔 OPA를 통해 제한했다.</li><li>Prometheus와 Grafana로 GPU 사용량을 볼 수 있도록 대시보드를 세팅했다.</li></ul><p>이 이상으로 GPU 리소스를 어떻게 더 잘 사용할 수 있을지에 대해서는 상황에 따라 달라지지 않을까 싶다.
앞으로도 이와 비슷한 작업을 하거나 이 과정 중 무언가를 알게 되면 별도의 글에 더 적어봐야겠다.</p><p>적다보니 글이 꽤 길어졌다.
글을 두 개로 쪼개볼까 생각도 해봤는데, 그래도 묵직하게 하나의 글로 남겨두는게 낫겠단 생각에 이대로 글을 남겨둔다.</p><h2 id="참고" style="position:relative"><a href="#%EC%B0%B8%EA%B3%A0" aria-label="참고 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>참고</h2><ul><li><a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/overview.html">NVIDIA Documentation - GPU Operator</a></li><li><a href="https://www.alibabacloud.com/blog/the-burgeoning-kubernetes-scheduling-system-part-3-binpack-scheduling-that-supports-batch-jobs_597321">Alibaba Cloud - The Burgeoning Kubernetes Scheduling System – Part 3: Binpack Scheduling That Supports Batch Jobs</a></li><li><a href="https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework">Kubernetes Documentation - Scheduling Framework</a></li><li><a href="https://kubernetes.io/docs/reference/scheduling/config/">Kubernetes Documentation - Scheduler Configuration</a></li><li><a href="https://netpple.github.io/docs/deepdive-into-kubernetes/k8s-scheduler">Netpple - Deepdive into kubernetes 6편. kube-scheduler</a></li><li><a href="https://engineering.clova.ai/posts/2022/08/nsml-scheduler-part-1">CLOVA Engineering 블로그 - NSML 분산 학습 플랫폼의 스케줄링 요구 사항과 해결 방안</a></li><li><a href="https://www.openpolicyagent.org/docs/latest/kubernetes-tutorial/">OPA - Tutorial: Ingress Validation</a></li><li><a href="https://coffeewhale.com/kubernetes/admission-control/2021/04/28/opa1/">커피고래님 블로그 - 쿠버네티스 Admission Control #1</a></li><li><a href="https://coffeewhale.com/kubernetes/admission-control/2021/05/04/opa2/">커피고래님 블로그 - 쿠버네티스 Admission Control #2 - Open Policy Agent</a></li><li><a href="https://coffeewhale.com/opa3">커피고래님 블로그 - 쿠버네티스 Admission Control #3 - Open Policy Agent 적용</a></li></ul></div><div id="disqus_thread"></div></main><footer><ul class="external-links"><li><a href="https://www.facebook.com/heumsi/"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook" class="svg-inline--fa fa-facebook " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.8 90.69 226.4 209.3 245V327.7h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.3 482.4 504 379.8 504 256z"></path></svg></a></li><li><a href="https://www.linkedin.com/in/siheum-jeon-04222a1b3/"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li><a href="https://github.com/heumsi/"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3 .3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5 .3-6.2 2.3zm44.2-1.7c-2.9 .7-4.9 2.6-4.6 4.9 .3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3 .7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3 .3 2.9 2.3 3.9 1.6 1 3.6 .7 4.3-.7 .7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3 .7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3 .7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a href="https://bit.ly/3zAT8Ab"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="file-lines" class="svg-inline--fa fa-file-lines " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M256 0v128h128L256 0zM224 128L224 0H48C21.49 0 0 21.49 0 48v416C0 490.5 21.49 512 48 512h288c26.51 0 48-21.49 48-48V160h-127.1C238.3 160 224 145.7 224 128zM272 416h-160C103.2 416 96 408.8 96 400C96 391.2 103.2 384 112 384h160c8.836 0 16 7.162 16 16C288 408.8 280.8 416 272 416zM272 352h-160C103.2 352 96 344.8 96 336C96 327.2 103.2 320 112 320h160c8.836 0 16 7.162 16 16C288 344.8 280.8 352 272 352zM288 272C288 280.8 280.8 288 272 288h-160C103.2 288 96 280.8 96 272C96 263.2 103.2 256 112 256h160C280.8 256 288 263.2 288 272z"></path></svg></a></li></ul><p class="copy-right">@ heumsi</p></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/setup-gpu-env-in-k8s/";window.___webpackCompilationHash="9023d6fb65f6071942db";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-4aa291e7e6681714b3e8.js"],"app":["/app-c321c5efdf12999a1dd7.js"],"component---src-components-templates-log-js":["/component---src-components-templates-log-js-8be2b192cec9967ef4ea.js"],"component---src-components-templates-post-js":["/component---src-components-templates-post-js-d80014afc9ad124b5ee3.js"],"component---src-pages-404-js":["/component---src-pages-404-js-5ed0d86fb0763a04a4b4.js"],"component---src-pages-index-js":["/component---src-pages-index-js-67136b30be5717c21631.js"],"component---src-pages-logs-index-js":["/component---src-pages-logs-index-js-bf19e8f568991d11bb86.js"],"component---src-pages-posts-index-js":["/component---src-pages-posts-index-js-2779df3cf8aef25ec545.js"]};/*]]>*/</script><script src="/blog/polyfill-4aa291e7e6681714b3e8.js" nomodule=""></script><script src="/blog/app-c321c5efdf12999a1dd7.js" async=""></script><script src="/blog/framework-c9b92197cbae3c33e091.js" async=""></script><script src="/blog/webpack-runtime-d16735df36b4c0712223.js" async=""></script></body></html>