<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-rh="true" property="keywords" content="Kubernetes,CRD,Operator,Kopf,Python"/><meta data-rh="true" property="og:image" content="/blog/static/16bee52d861719ebb9351d2ff0dc005f/0ea1b/thumbnail.png"/><meta data-rh="true" property="og:description" content="CRD 작성부터 Operator 실행까지"/><meta data-rh="true" property="og:title" content="Kopf로 Kubernetes CRD Operator 구현해보기"/><meta data-rh="true" property="og:url" content="https://heumsi.github.io/blog/posts/crd-and-kopf-tutorial/"/><meta data-rh="true" name="description" content="CRD 작성부터 Operator 실행까지"/><meta data-rh="true" name="googlebot" content="index,follow"/><meta data-rh="true" name="robots" content="index,follow"/><meta data-rh="true" property="og:site_name" content="하나씩. 점을. 찍어나가며."/><meta data-rh="true" property="og:type" content="website"/><meta data-rh="true" name="twitter:creator" content="@handle"/><meta data-rh="true" name="twitter:site" content="@site"/><meta data-rh="true" name="twitter:card" content="summary_large_image"/><meta name="generator" content="Gatsby 4.17.2"/><style data-href="/blog/styles.202b843a3255cda52de9.css" data-identity="gatsby-global-css">/*! minireset.css v0.0.7 | MIT License | github.com/jgthms/minireset.css */blockquote,body,dd,dl,dt,fieldset,figure,h1,h2,h3,h4,h5,h6,hr,html,iframe,legend,li,ol,p,pre,textarea,ul{margin:0;padding:0}h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:400}ul{list-style:none}button,input,select{margin:0}html{box-sizing:border-box}*,:after,:before{box-sizing:inherit}img,video{height:auto;max-width:100%}iframe{border:0}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}code[class*=language-],pre[class*=language-]{background:#fafafa;color:#383a42;direction:ltr;font-family:Fira Code,Fira Mono,Menlo,Consolas,DejaVu Sans Mono,monospace;font-size:.95em;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{background:#e5e5e6;color:inherit}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection{background:#e5e5e6;color:inherit}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.2em .3em;white-space:normal}.token.cdata,.token.comment,.token.prolog{color:#a0a1a7}.token.doctype,.token.entity,.token.punctuation{color:#383a42}.token.atrule,.token.attr-name,.token.boolean,.token.class-name,.token.constant,.token.number{color:#b76b01}.token.keyword{color:#a626a4}.token.deleted,.token.important,.token.property,.token.symbol,.token.tag{color:#e45649}.token.attr-value,.token.attr-value>.token.punctuation,.token.builtin,.token.char,.token.inserted,.token.regex,.token.selector,.token.string{color:#50a14f}.token.function,.token.operator,.token.variable{color:#4078f2}.token.url{color:#0184bc}.token.attr-value>.token.punctuation.attr-equals,.token.special-attr>.token.attr-value>.token.value.css{color:#383a42}.language-css .token.selector{color:#e45649}.language-css .token.property{color:#383a42}.language-css .token.function,.language-css .token.url>.token.function{color:#0184bc}.language-css .token.url>.token.string.url{color:#50a14f}.language-css .token.atrule .token.rule,.language-css .token.important,.language-javascript .token.operator{color:#a626a4}.language-javascript .token.template-string>.token.interpolation>.token.interpolation-punctuation.punctuation{color:#ca1243}.language-json .token.operator{color:#383a42}.language-json .token.null.keyword{color:#b76b01}.language-markdown .token.url,.language-markdown .token.url-reference.url>.token.string,.language-markdown .token.url>.token.operator{color:#383a42}.language-markdown .token.url>.token.content{color:#4078f2}.language-markdown .token.url-reference.url,.language-markdown .token.url>.token.url{color:#0184bc}.language-markdown .token.blockquote.punctuation,.language-markdown .token.hr.punctuation{color:#a0a1a7;font-style:italic}.language-markdown .token.code-snippet{color:#50a14f}.language-markdown .token.bold .token.content{color:#b76b01}.language-markdown .token.italic .token.content{color:#a626a4}.language-markdown .token.list.punctuation,.language-markdown .token.strike .token.content,.language-markdown .token.strike .token.punctuation,.language-markdown .token.title.important>.token.punctuation{color:#e45649}.token.bold{font-weight:700}.token.comment,.token.italic{font-style:italic}.token.entity{cursor:help}.token.namespace{opacity:.8}.token.token.cr:before,.token.token.lf:before,.token.token.space:before,.token.token.tab:not(:empty):before{color:rgba(56,58,66,.2)}div.code-toolbar>.toolbar.toolbar>.toolbar-item{margin-right:.4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span{background:#e5e5e6;border-radius:.3em;color:#696c77;padding:.1em .4em}div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>a:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>button:hover,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:focus,div.code-toolbar>.toolbar.toolbar>.toolbar-item>span:hover{background:#c6c7c7;color:#383a42}.line-highlight.line-highlight{background:rgba(56,58,66,.05)}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background:#e5e5e6;border-radius:.3em;box-shadow:0 2px 0 0 rgba(0,0,0,.2);color:#383a42;padding:.1em .6em}pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows>span:hover:before{background-color:rgba(56,58,66,.05)}.command-line .command-line-prompt,.line-numbers.line-numbers .line-numbers-rows{border-right-color:rgba(56,58,66,.2)}.command-line .command-line-prompt>span:before,.line-numbers .line-numbers-rows>span:before{color:#9d9d9f}.rainbow-braces .token.token.punctuation.brace-level-1,.rainbow-braces .token.token.punctuation.brace-level-5,.rainbow-braces .token.token.punctuation.brace-level-9{color:#e45649}.rainbow-braces .token.token.punctuation.brace-level-10,.rainbow-braces .token.token.punctuation.brace-level-2,.rainbow-braces .token.token.punctuation.brace-level-6{color:#50a14f}.rainbow-braces .token.token.punctuation.brace-level-11,.rainbow-braces .token.token.punctuation.brace-level-3,.rainbow-braces .token.token.punctuation.brace-level-7{color:#4078f2}.rainbow-braces .token.token.punctuation.brace-level-12,.rainbow-braces .token.token.punctuation.brace-level-4,.rainbow-braces .token.token.punctuation.brace-level-8{color:#a626a4}pre.diff-highlight>code .token.token.deleted:not(.prefix),pre>code.diff-highlight .token.token.deleted:not(.prefix){background-color:rgba(255,82,102,.15)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.deleted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.deleted:not(.prefix)::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.deleted:not(.prefix)::selection{background-color:rgba(251,86,105,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix),pre>code.diff-highlight .token.token.inserted:not(.prefix){background-color:rgba(25,255,91,.15)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::-moz-selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::-moz-selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection{background-color:rgba(56,224,98,.25)}pre.diff-highlight>code .token.token.inserted:not(.prefix) ::selection,pre.diff-highlight>code .token.token.inserted:not(.prefix)::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix) ::selection,pre>code.diff-highlight .token.token.inserted:not(.prefix)::selection{background-color:rgba(56,224,98,.25)}.prism-previewer-gradient.prism-previewer-gradient div,.prism-previewer.prism-previewer:before{border-color:hsl(0,0,95%)}.prism-previewer-color.prism-previewer-color:before,.prism-previewer-easing.prism-previewer-easing:before,.prism-previewer-gradient.prism-previewer-gradient div{border-radius:.3em}.prism-previewer.prism-previewer:after{border-top-color:hsl(0,0,95%)}.prism-previewer-flipped.prism-previewer-flipped.after{border-bottom-color:hsl(0,0,95%)}.prism-previewer-angle.prism-previewer-angle:before,.prism-previewer-easing.prism-previewer-easing,.prism-previewer-time.prism-previewer-time:before{background:#fff}.prism-previewer-angle.prism-previewer-angle circle,.prism-previewer-time.prism-previewer-time circle{stroke:#383a42;stroke-opacity:1}.prism-previewer-easing.prism-previewer-easing circle,.prism-previewer-easing.prism-previewer-easing line,.prism-previewer-easing.prism-previewer-easing path{stroke:#383a42}.prism-previewer-easing.prism-previewer-easing circle{fill:transparent}.gatsby-highlight-code-line{background-color:#eee;display:block;margin-left:-1em;margin-right:-1em;padding-left:1em;padding-right:1em}.gatsby-highlight{background:#fafafa;margin:0 0 1em;overflow:auto;padding:1em}.gatsby-highlight pre[class*=language-]{background-color:transparent;float:left;margin:0;min-width:100%;overflow:initial;padding:0}.toc{overflow-y:auto}.toc>.toc-list{overflow:hidden;position:relative}.toc>.toc-list li{list-style:none}.toc-list{margin:0;padding-left:10px}a.toc-link{color:currentColor;height:100%}.is-collapsible{max-height:1000px;overflow:hidden;transition:all .3s ease-in-out}.is-collapsed{max-height:0}.is-position-fixed{position:fixed!important;top:0}.is-active-link{font-weight:700}.toc-link:before{background-color:#eee;content:" ";display:inline-block;height:inherit;left:0;margin-top:-1px;position:absolute;width:2px}.is-active-link:before{background-color:#54bc4b}.toc{color:#333;font-size:.8em;left:0;line-height:1.8em;max-width:20rem;padding-left:1rem;position:fixed;top:50vh;transform:translateY(-50%);transition:all .4s cubic-bezier(.25,.8,.4,.95);visibility:visible;width:100%}.toc-list-item{font-weight:300}.is-active-link{font-weight:400}.toc-hidden{transform:translate(-100%,-50%);visibility:hidden}.toc-link:before{background-color:inherit}@media only screen and (max-width:85rem){.toc{visibility:hidden}}*{color:inherit;text-decoration:none}body{-ms-text-size-adjust:100%;-moz-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#333;font-size:1rem;word-break:break-all}h1{font-size:2.441em}h1,h2{font-weight:700}h2{font-size:1.953em}h3{font-size:1.563em}h3,h4{font-weight:700}h4{font-size:1.25em}li,p{font-size:1em;font-weight:400;line-height:1.8em}a{cursor:pointer}.container{font-family:sans-serif;margin:auto;max-width:45rem;width:100%}header{align-items:center;display:flex;justify-content:space-between;margin:1.5rem 0 1rem}header .site-title{font-weight:700;margin:0;transition:.33s}header .site-title:hover{color:#344cb7}header nav{display:flex;font-weight:400}header nav .nav-item a{padding-right:1.5rem;transition:.33s}header nav .nav-item a:hover{color:#344cb7}header nav .nav-item a:last-child{padding-right:0}.content .page-title{font-weight:500}.content .post-item{align-items:center;list-style:none;margin:2rem 0;transition:.33s}.content .post-item:hover{color:#344cb7}.content .post-item a{text-decoration:none}.content .post-item article{display:flex}.content .post-item-thumbnail{height:7rem;width:7rem}.content .post-item-desc{display:flex;flex-direction:column;height:7rem;margin-left:1.5rem}.content .post-item-title{font-weight:400;margin-top:0}.content .post-item-sub-title{line-height:1.4em;margin-top:.5rem}.content .post-item-meta{color:#666;font-size:.9em;line-height:1em;margin:auto 0 0}.content .post-cover-image{height:400px;left:50%;margin-bottom:2rem;margin-left:-50vw;margin-right:-50vw;max-width:100vw;position:relative;right:50%;width:100vw}.content .post-sub-title{color:#666;font-weight:400;margin-top:1rem}.content .post-meta{color:#666;display:block;margin-top:.5rem}.content .post-content{margin:3rem 0 5rem}.content .log-content{margin-top:1rem}.content .post-content h2,h3,h4{margin-top:2em}.content .post-content p{margin:1em 0}.content .post-content hr{background-color:#eee;border:0;height:1px;margin:2em}.content .post-content table{overflow-x:auto;width:100%}.content .post-content table th{background-color:#fafafa}.content .post-content table th,td{border:1px solid #ccc;padding:.5em}.content .log-content a,.content .post-content a{text-decoration:underline}.content .post-content>ul{margin:1em 0}.content .log-content ul li,.content .post-content ul li{list-style:outside;margin-left:1em}.content .log-content ul li p,.content .post-content ul li p{margin:0}.content .log-content ol li,.content .post-content ol li{margin-left:1em}.content .post-content .gatsby-resp-image-wrapper{margin:2em 0}.content .log-content .gatsby-resp-image-wrapper{margin:1em 0;margin-left:0!important;margin-right:0!important;max-width:100%!important}.content .log-content .gatsby-resp-image-wrapper+em,.content .post-content .gatsby-resp-image-wrapper+em{color:#999;display:block;font-size:.9em;font-style:normal;line-height:1.5em;margin:-1.5em auto 2em;max-width:90%;text-align:center}.content .log-content blockquote,.content .post-content blockquote{background:#f6f6f6;border-left:4px solid #e6e6e6;color:#666;margin:1rem 0;padding:1rem}.content .log-content blockquote code,.content .post-content blockquote code{color:#666}.content .log-content blockquote ol,.content .log-content blockquote p,.content .log-content blockquote ul,.content .post-content blockquote ol,.content .post-content blockquote p,.content .post-content blockquote ul{margin:1em 0}.content .log-content blockquote p:first-child,.content .log-content blockquote p:last-child,.content .post-content blockquote p:first-child,.content .post-content blockquote p:last-child{margin:0}.content .post-content .mermaid{margin:0 auto;width:-webkit-fit-content;width:-moz-fit-content;width:fit-content}.content .log-item{line-height:1.8em;margin:2rem 0}.content .log-title span{cursor:pointer;font-size:.6em;margin-left:.6em;opacity:.6;transition:.33s}.content .log-title span:hover{opacity:1}.content .log-content a{text-decoration:underline}.content .log-datetime{color:#666;font-size:.9em}footer{align-items:center;color:#666;display:flex;justify-content:space-between;margin:3rem 0}footer .external-links li{display:inline-block;margin:0 .5rem;transition:.33s}footer .external-links li:hover{color:#344cb7}footer .copy-right{font-size:.9rem;text-align:right}@media screen and (max-width:800px){html{font-size:1rem}h1{font-size:1.749em}h1,h2{font-weight:700}h2{font-size:1.521em}h3{font-size:1.322em}h3,h4{font-weight:700}h4{font-size:1.15em}.container{padding:0 1rem}header .site-title{font-size:1rem}header nav .nav-item a{padding-right:1rem}.content .post-list .post-item{border-bottom:1px solid #ccc;margin:0 -1rem;padding:1rem}.content .post-list .post-item:last-child{border-bottom:none}.content .post-list .post-item a{text-decoration:none}.content .post-cover-image{margin-bottom:1.5rem}.content .page-title{font-size:1rem}.content .post-item-title{font-size:1.2rem}.content .post-item-thumbnail{display:none!important}.content .post-item-desc{height:-webkit-fit-content;height:-moz-fit-content;height:fit-content;margin-left:0}.content .post-item-meta{line-height:1.4em}footer{margin:1rem 0}}</style><link rel="preconnect" href="https://plausible.io"/><script async="" defer="" data-domain="heumsi.github.io/blog" src="https://plausible.io/js/plausible.js"></script><script>
          window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) };
          
          </script><title data-rh="true">Kopf로 Kubernetes CRD Operator 구현해보기</title><link data-rh="true" rel="canonical" href="https://heumsi.github.io/blog/posts/crd-and-kopf-tutorial/"/><script data-rh="true" defer="" src="https://cloud.umami.is/script.js" data-website-id="c247e343-b8cb-4751-8e13-8e8557a94875"></script><link rel="sitemap" type="application/xml" href="/blog/sitemap/sitemap-index.xml"/><link rel="alternate" type="application/rss+xml" title="하나씩 점을 찍어나가며 - Heumsi의 블로그 RSS" href="/blog/rss.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZRH97WV1XY"></script><script>
    window.GATSBY_GTAG_PLUGIN_GA_TRACKING_ID = (
      'G-ZRH97WV1XY'
    );
    window.GATSBY_GTAG_PLUGIN_ANONYMIZE = false;

    var options = {
      send_page_view: false
    };
    if (false) {
      options.anonymize_ip = true;
    }

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', 'G-ZRH97WV1XY', options);
  </script><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="container"><header><h3 class="site-title"><a href="/blog/">하나씩. 점을. 찍어나가며.</a></h3><nav><ul><li class="nav-item"><a class="nav-link-text" href="/blog/posts">글</a><a class="nav-link-text" href="/blog/logs">로그</a></li></ul></nav></header><main class="content"><section class="post-cover-image gbi-2032240659-1MpG8NgL1gFjqpV4cdQMgZ" style="background-position:center;background-repeat:no-repeat;background-size:cover;position:relative"><style>
          .post-cover-image.gbi-2032240659-1MpG8NgL1gFjqpV4cdQMgZ:before,
          .post-cover-image.gbi-2032240659-1MpG8NgL1gFjqpV4cdQMgZ:after {
            content: '';
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            
            transition: opacity 0.5s ease 250ms;
            background-position: center;
background-repeat: no-repeat;
background-size: cover;

          }
          .post-cover-image.gbi-2032240659-1MpG8NgL1gFjqpV4cdQMgZ:before {
            z-index: -100;
            
            
            opacity: 1; 
          }
          .post-cover-image.gbi-2032240659-1MpG8NgL1gFjqpV4cdQMgZ:after {
            z-index: -101;
            
            
            
          }
        </style><noscript><style>
    .post-cover-image.gbi-2032240659-1MpG8NgL1gFjqpV4cdQMgZ:before {
      opacity: 1;
      background-image: url('/blog/static/16bee52d861719ebb9351d2ff0dc005f/0ea1b/thumbnail.png');
    }</style></noscript></section><h1 class="post-title">Kopf로 Kubernetes CRD Operator 구현해보기</h1><h3 class="post-sub-title">CRD 작성부터 Operator 실행까지</h3><p class="post-meta"><span>2022년 7월 15일</span> — <span>Kubernetes<!-- -->, <!-- -->CRD<!-- -->, <!-- -->Operator<!-- -->, <!-- -->Kopf<!-- -->, <!-- -->Python</span></p><div class="toc toc-hidden"></div><div class="post-content"><h2 id="들어가며" style="position:relative"><a href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0" aria-label="들어가며 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>들어가며</h2><p>Kubernetes 위에서 뭔가를 배포하다보면, Deployment, Helm을 알게되고, 그러다 어느순간 CRD와 Operator라는 개념을 마주하게 된다.
처음엔 그저 이게 뭐지하고 사용 하다가, 어느 순간 꽤 많은 애플리케이션들이 자체적인 CRD와 Operator를 쓴다는 것을 느끼게 된다.</p><p>Kubernetes CRD와 Operator는 어떻게 구현하는건지 평소에 궁금했었는데, 최근에 Kopf 라는 툴을 알게되어 이에 대해 소개해보고자 한다.
CRD 구현부터 Kopf를 통해 파이썬으로 Operator를 구현하는 것까지 이 글에서 다루어보겠다.</p><h2 id="crd" style="position:relative"><a href="#crd" aria-label="crd permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CRD</h2><h3 id="crd-란" style="position:relative"><a href="#crd-%EB%9E%80" aria-label="crd 란 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CRD 란?</h3><p>CRD는 Custom Resource Definition의 약자로, 이름 그대로 사용자가 정의하는 Kubernetes 리소스다.
우리는 CRD를 먼저 정의하고 배포한 후 CR(Custom Resource)를 배포할 수 있다.</p><p>Kubernetes에는 Pod, Deployment, Service 등 기본적인 리소스 유형들이 존재한다.
그런데 이렇게 기본적인 리소스 유형말고 개발자가 직접 리소스 유형을 정의해서 사용할 수 있는데, 이렇게 직접 정의된 리소스들을 CRD라고 부르는 것이다.</p><p>사실 CRD는 아예 새로운 것을 만들어내는 것은 아니고, Kubernetes의 기본 리소스 유형을 조합하여 사용에 맞게 추상화한 리소스라고 보면 된다.</p><blockquote><p>Kubernetes의 리소스 유형 확장 방법으로 CRD가 유일한 것은 아니다. API Aggregation 이라는 방법도 있는데,
이에 대해서는 <a href="https://blog.naver.com/alice_k106/221579974362">Alice님 블로그 글</a>에 잘 소개가 되어 있어 공유해본다.</p></blockquote><h3 id="crd-작성하기" style="position:relative"><a href="#crd-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0" aria-label="crd 작성하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CRD 작성하기</h3><p>먼저, CRD 작성 전에 현재 마주한 문제 상황은 다음과 같다.</p><p>보통 Kubernetes에서 앱을 배포하기 위해서는 Deployment와 Service를 배포해야 한다.
그런데 매번 Deployment와 Service의 yaml 파일을 일일이 다 작성하는게 귀찮다.
개발자는 배포에 다음 설정 값들만 작성해도 충분하다고 해보자.</p><ul><li>Deployment에 어떤 컨테이너 이미지를 쓸지 (image)</li><li>Deployment에 Pod 수는 몇 개로 할지 (replicas)</li><li>Service에 포트는 몇번으로 할지 (port)</li></ul><p>위 문제 상황을 해결하기 위해 <code class="language-text">Application</code> 이라는 CR을 만드려고 한다.
<code class="language-text">Application</code> 리소스를 작성할 때 위 3개의 설정 값만 주고, <code class="language-text">Application</code> 을 배포하면 Deployment와 Service가 자동으로 만들어지게끔 할 것이다.</p><p>이제 <code class="language-text">Application</code> 의 CRD를 작성을 시작해보자.
<code class="language-text">crd.yaml</code> 을 만들어 다음처럼 작성한다.</p><div class="gatsby-highlight has-highlighted-lines" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># crd.yaml</span>

<span class="gatsby-highlight-code-line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1</span><span class="gatsby-highlight-code-line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition</span><span class="gatsby-highlight-code-line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">  <span class="token comment"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span></span><span class="gatsby-highlight-code-line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> applications.heumsi.github.io</span></code></pre></div><ul><li>CRD를 작성할 때는 위와 같은 <code class="language-text">apiVersion</code> 과 <code class="language-text">kind</code> 를 사용한다.</li><li><code class="language-text">metadata.name</code> 값은 CRD의 Full Name이다.<ul><li>이 값은 <code class="language-text">&lt;plural&gt;.&lt;group&gt;</code> 형태로 작성되어야 하는데, 아래에서 설명하겠다.</li><li>리소스의 Full Name은 API Group(위의 경우 <code class="language-text">heumsi.github.io</code>)을 포함하는데, API Group은 리소스 구분을 위한 일종의 네임스페이스라 보면 된다.</li></ul></li></ul><p>계속해서 더 작성해보자.</p><div class="gatsby-highlight has-highlighted-lines" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># crd.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token comment"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> applications.heumsi.github.io
<span class="gatsby-highlight-code-line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">  <span class="token comment"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span></span><span class="gatsby-highlight-code-line">  <span class="token key atrule">group</span><span class="token punctuation">:</span> heumsi.github.io</span><span class="gatsby-highlight-code-line">  <span class="token comment"># either Namespaced or Cluster</span></span><span class="gatsby-highlight-code-line">  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced</span><span class="gatsby-highlight-code-line">  <span class="token key atrule">names</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token comment"># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">plural</span><span class="token punctuation">:</span> applications</span><span class="gatsby-highlight-code-line">    <span class="token comment"># singular name to be used as an alias on the CLI and for display</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">singular</span><span class="token punctuation">:</span> application</span><span class="gatsby-highlight-code-line">    <span class="token comment"># kind is normally the CamelCased singular type. Your resource manifests use this.</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Application</span><span class="gatsby-highlight-code-line">    <span class="token comment"># shortNames allow shorter string to match your resource on the CLI</span></span><span class="gatsby-highlight-code-line">    <span class="token key atrule">shortNames</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">      <span class="token punctuation">-</span> app</span></code></pre></div><ul><li><code class="language-text">spec.group</code> 의 값은 API Group이다. API Group은 보통 자신의 도메인을 사용한다.</li><li><code class="language-text">spec.scope</code> 의 값은 이 커스텀 리소스가 배포되었을 때의 유효 범위이다.<ul><li><code class="language-text">Namespaced</code> 로 주면 커스텀 리소스는 네임스페이스 범위로 배포된다.</li><li><code class="language-text">Cluster</code> 로 주면 커스텀 리소스는 클러스터 범위로 배포된다.</li><li>CRD 자체는 Cluster 범위다. 여기서 말하는 <code class="language-text">scoped</code> 값은 CR(여기선 <code class="language-text">Applicaton</code>)의 범위를 말하는 것이다.</li></ul></li><li><code class="language-text">spec.names</code> 에는 이 리소스를 부르는 여러 이름을 담는다.<ul><li><code class="language-text">plural</code> 의 값은 이 리소스의 복수 형태의 이름이다.</li><li><code class="language-text">singular</code> 의 값은 이 리소스의 단수 형태의 이름이다.</li><li><code class="language-text">kind</code> 의 값은 이 리소스를 생성할 때 작성하는 단수 형태의 이름이다.</li><li><code class="language-text">shortNames</code> 의 값은 이 리소스를 부르는 단축 형태의 이름으로, 일종의 Alias다.</li></ul></li></ul><p>이제 실제로 <code class="language-text">Application</code> 은 어떤 스펙을 담고있어야 하는지 작성해보자.</p><div class="gatsby-highlight has-highlighted-lines" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># crd.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiextensions.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CustomResourceDefinition
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token comment"># name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> applications.heumsi.github.io
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> heumsi.github.io
  <span class="token comment"># either Namespaced or Cluster</span>
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> Namespaced
  <span class="token key atrule">names</span><span class="token punctuation">:</span>
    <span class="token comment"># plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span>
    <span class="token key atrule">plural</span><span class="token punctuation">:</span> applications
    <span class="token comment"># singular name to be used as an alias on the CLI and for display</span>
    <span class="token key atrule">singular</span><span class="token punctuation">:</span> application
    <span class="token comment"># kind is normally the CamelCased singular type. Your resource manifests use this.</span>
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Application
    <span class="token comment"># shortNames allow shorter string to match your resource on the CLI</span>
    <span class="token key atrule">shortNames</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> app
<span class="gatsby-highlight-code-line">  <span class="token comment"># list of versions supported by this CustomResourceDefinition</span></span><span class="gatsby-highlight-code-line">  <span class="token key atrule">versions</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1</span><span class="gatsby-highlight-code-line">      <span class="token comment"># Each version can be enabled/disabled by Served flag.</span></span><span class="gatsby-highlight-code-line">      <span class="token key atrule">served</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span><span class="gatsby-highlight-code-line">      <span class="token comment"># One and only one version must be marked as the storage version.</span></span><span class="gatsby-highlight-code-line">      <span class="token key atrule">storage</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span><span class="gatsby-highlight-code-line">      <span class="token key atrule">schema</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">        <span class="token key atrule">openAPIV3Schema</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">          <span class="token key atrule">type</span><span class="token punctuation">:</span> object</span><span class="gatsby-highlight-code-line">          <span class="token key atrule">properties</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token key atrule">spec</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">              <span class="token key atrule">type</span><span class="token punctuation">:</span> object</span><span class="gatsby-highlight-code-line">              <span class="token key atrule">x-kubernetes-preserve-unknown-fields</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span><span class="gatsby-highlight-code-line">              <span class="token key atrule">properties</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                <span class="token key atrule">image</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                  <span class="token key atrule">type</span><span class="token punctuation">:</span> string</span><span class="gatsby-highlight-code-line">                <span class="token key atrule">replicas</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                  <span class="token key atrule">type</span><span class="token punctuation">:</span> integer</span><span class="gatsby-highlight-code-line">                <span class="token key atrule">port</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                  <span class="token key atrule">type</span><span class="token punctuation">:</span> integer</span><span class="gatsby-highlight-code-line">              <span class="token key atrule">required</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">                <span class="token punctuation">-</span> image</span><span class="gatsby-highlight-code-line">                <span class="token punctuation">-</span> replicas</span><span class="gatsby-highlight-code-line">                <span class="token punctuation">-</span> port</span><span class="gatsby-highlight-code-line">            <span class="token key atrule">status</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">              <span class="token key atrule">type</span><span class="token punctuation">:</span> object</span><span class="gatsby-highlight-code-line">              <span class="token key atrule">x-kubernetes-preserve-unknown-fields</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span><span class="gatsby-highlight-code-line">          <span class="token key atrule">required</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">            <span class="token punctuation">-</span> spec</span></code></pre></div><ul><li><code class="language-text">spec.versions</code> 내에 버전 단위로 스펙을 작성한다.<ul><li><code class="language-text">served</code> 와 <code class="language-text">storage</code>는 실제 운영에 제공할 버전에 대한 표시이며, 제공할 버전은 <code class="language-text">true</code> 로 둔다.</li><li><code class="language-text">schema</code> 항목에 실제 스펙을 작성하며, 스펙 포맷은 <code class="language-text">openAPIV3Schema</code> 를 사용한다.<ul><li>우리가 json 스키마를 정의할 때 흔히 쓰는 그 <a href="https://swagger.io/specification/">OpenAPI 스키마</a>가 맞다.</li></ul></li></ul></li><li><code class="language-text">x-kubernetes-preserve-unknown-fields</code> 를 <code class="language-text">true</code> 로 주면 추후에 동적으로 해당 field 값을 수정할 수 있다. 왠만하면 <code class="language-text">true</code> 로 주자.</li></ul><blockquote><p><code class="language-text">x-kubernetes-preserve-unknown-fields</code> 에 대해서 좀 더 알아보고 싶다면, <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#controlling-pruning">공식 문서</a>를 확인해봐도 좋다.</p></blockquote><p>여기서는 위에서 필요하다고 이야기한 설정 값에 맞게 <code class="language-text">image</code>, <code class="language-text">replicas</code>, <code class="language-text">port</code> 이 3개의 속성 값을 <code class="language-text">spec</code> 안에 설정하였다.</p><h3 id="crd-배포하기" style="position:relative"><a href="#crd-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0" aria-label="crd 배포하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CRD 배포하기</h3><p>이제 위에서 작성한 CRD를 다음처럼 배포하자.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f crd.yaml

customresourcedefinition.apiextensions.k8s.io/applications.heumsi.github.io created</code></pre></div><p>이제 다음처럼 조회도 되고</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get crd
 
NAME                            CREATED AT
applications.heumsi.github.io   <span class="token number">2022</span>-07-13T12:16:19Z</code></pre></div><p>다음처럼 확인할 수도 있다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl describe crd applications.heumsi.github.io

Name:         applications.heumsi.github.io
Namespace:    
Labels:       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Annotations:  <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
API Version:  apiextensions.k8s.io/v1
Kind:         CustomResourceDefinition
Metadata:
  <span class="token punctuation">..</span>.
Spec:
  <span class="token punctuation">..</span>.
Status:
  <span class="token punctuation">..</span>.
Events:
  <span class="token punctuation">..</span>.</code></pre></div><p>이렇게 CRD 자체는 클러스터 전역에서 배포된다.</p><h3 id="cr-작성하기" style="position:relative"><a href="#cr-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0" aria-label="cr 작성하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CR 작성하기</h3><p>이제 위에서 CRD로 정의한 CR을 작성해보자.
<code class="language-text">application.yaml</code> 을 만들고 다음처럼 작성한다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># application.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> heumsi.github.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Application
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre></div><p>위 <code class="language-text">crd.yaml</code> 에서 작성한 <code class="language-text">spec</code> 에 맞춰 <code class="language-text">application.yaml</code> 을 작성하였다.
이제 우리는 이 <code class="language-text">application.yaml</code> 을 배포하면 다음의 일들이 일어나길 기대한다.</p><ul><li><code class="language-text">Deployment</code> 가 배포된다.<ul><li>Container는 하나이며 <code class="language-text">image</code> 는 <code class="language-text">nginx:latest</code> 이다.</li><li><code class="language-text">replicas</code> 는 <code class="language-text">1</code> 이다.</li></ul></li><li><code class="language-text">Service</code> 가 배포된다.<ul><li><code class="language-text">Deployment</code> 로 만들어진 <code class="language-text">Pod</code> 들에 연결된다.</li><li>포트는 <code class="language-text">80:80</code> 으로 설정된다.</li></ul></li></ul><h3 id="cr-배포하기" style="position:relative"><a href="#cr-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0" aria-label="cr 배포하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CR 배포하기</h3><p>위에서 작성한 <code class="language-text">application.yaml</code> 을 배포하자.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl apply -f application.yaml

application.heumsi.github.io/nginx created</code></pre></div><p>마찬가지로 다음처럼 조회할 수 있다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get applications   

NAME    AGE
nginx   35s</code></pre></div><p>다음처럼 <code class="language-text">crd.yaml</code> 에서 설정한 <code class="language-text">shortNames</code> 이나 <code class="language-text">group</code> 으로도 조회 가능하다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get app
 
NAME    AGE
nginx   2m38s

$ kubectl get applications.heumsi.github.io
 
NAME    AGE
nginx   2m29s</code></pre></div><p>CR을 배포했으나 아직 Deployment나 Service는 만들어지지 않았다.
CR을 모니터링하며 어떤 추가적인 작업을 실행하려면 Operator를 만들어야 한다.</p><h2 id="operator" style="position:relative"><a href="#operator" aria-label="operator permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Operator</h2><h3 id="operator-란" style="position:relative"><a href="#operator-%EB%9E%80" aria-label="operator 란 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Operator 란?</h3><p>Operator는 위에서 설명한대로, 특정 리소스를 계속 모니터링하며 무언가의 작업을 수행하는 역할을 담당한다.</p><p>예를 들어 어떤 CR이 생성되면 추가적인 특정 파드를 띄운다던가, CR에 변경이 일어나면 이러한 내용을 어딘가에 저장하게 할 수 있다.
이렇게 리소스를 모니터링하며 발생하는 이벤트에 따라 사용자가 추가적인 로직을 부여하고 싶을 때 Operator를 사용한다. </p><h3 id="kopf-란" style="position:relative"><a href="#kopf-%EB%9E%80" aria-label="kopf 란 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kopf 란?</h3><p><a href="https://github.com/nolar/kopf">Kopf</a>는 Kubernetes OPerator Framework의 약자로,
Python으로 Operator를 만들 수 있게 도와주는 프레임워크다.</p><p>말 그대로 프레임워크다 보니, 많은 것들이 추상화 되어있고 우리는 주어진 프레임 안에서 적당히 잘 코딩을 하면 된다.
비슷한 도구로 <a href="https://github.com/operator-framework/operator-sdk">CoreOS Operator SDK</a>나
<a href="https://operatorframework.io/">CoreOS Operator Framework</a>들도 있지만, Kopf 개발자들은 Kopf가 이들보다 사용하기 훨씬 쉬운 프레임워크라고 말한다.</p><blockquote><p>kopf 대안에 대해 좀 더 자세히 적어둔 글이 있는데, 궁금하면 <a href="https://kopf.readthedocs.io/en/stable/alternatives/">공식 문서</a>를 확인하자.</p></blockquote><p>그럼 이제 kopf로 Operator를 작성해보자.</p><h3 id="kopf-설치하기" style="position:relative"><a href="#kopf-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0" aria-label="kopf 설치하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Kopf 설치하기</h3><p>먼저 다음처럼 <code class="language-text">kopf</code> 를 설치한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ pip <span class="token function">install</span> kopf

kopf --version
kopf, version <span class="token number">1.35</span>.5</code></pre></div><blockquote><p><a href="https://pip.pypa.io/en/stable/">pip</a>는 Python package manager로, Python을 설치하면 같이 설치된다.
아직 pip가 설치되지 않았다면, Python 설치를 먼저 진행하자.
Python은 <a href="https://github.com/pyenv/pyenv">pyenv</a>로 쉽게 설치할 수 있다.</p></blockquote><h3 id="yaml-파일-작성하기" style="position:relative"><a href="#yaml-%ED%8C%8C%EC%9D%BC-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0" aria-label="yaml 파일 작성하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>yaml 파일 작성하기</h3><p>먼저 Deployment와 Service로 사용할 yaml 파일을 다음처럼 작성하자.
<code class="language-text">service.yaml</code> 을 만든 뒤 다음처럼 작성한다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># service.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;{name}&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> <span class="token string">&quot;{name}&quot;</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>port<span class="token punctuation">}</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>port<span class="token punctuation">}</span></code></pre></div><p><code class="language-text">deployment.yaml</code> 을 만든 뒤 다음처럼 작성한다.</p><div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># deployment.yaml</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;{name}&quot;</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> <span class="token string">&quot;{name}&quot;</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>replicas<span class="token punctuation">}</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> <span class="token string">&quot;{name}&quot;</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> <span class="token string">&quot;{name}&quot;</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;{name}&quot;</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">&quot;{image}&quot;</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>port<span class="token punctuation">}</span></code></pre></div><p><code class="language-text">yaml</code> 파일 내 <code class="language-text">{}</code> 로 표현된 변수들은 Python 코드에서 주입해줄 예정이다.</p><h3 id="cr-생성-이벤트-핸들러-작성하기" style="position:relative"><a href="#cr-%EC%83%9D%EC%84%B1-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%ED%95%B8%EB%93%A4%EB%9F%AC-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0" aria-label="cr 생성 이벤트 핸들러 작성하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CR 생성 이벤트 핸들러 작성하기</h3><p>이제 진짜로 Operator를 작성해보자.
<code class="language-text">main.py</code> 를 만든 뒤 다음처럼 작성한다.</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment"># main.py</span>

<span class="token keyword">import</span> kopf


<span class="token decorator annotation punctuation">@kopf<span class="token punctuation">.</span>on<span class="token punctuation">.</span>create</span><span class="token punctuation">(</span><span class="token string">&#x27;heumsi.github.io&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;v1&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;applications&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Application &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is created.&quot;</span></span><span class="token punctuation">)</span></code></pre></div><p><code class="language-text">applications.v1.heumsi.github.io</code> 리소스가 생성될 때 이를 감지하여 <code class="language-text">create</code> 함수가 실행되는 코드다.
즉 <code class="language-text">create</code> 라고 하는 이벤트의 핸들러를 kopf 에서는 위처럼 작성하게 된다.</p><p>위 코드를 다음처럼 실행한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kopf run main.py --verbose

<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,392<span class="token punctuation">]</span> kopf._core.reactor.r <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> Starting Kopf <span class="token number">1.35</span>.5.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,392<span class="token punctuation">]</span> kopf._core.engines.a <span class="token punctuation">[</span>INFO    <span class="token punctuation">]</span> Initial authentication has been initiated.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,392<span class="token punctuation">]</span> kopf.activities.auth <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> Activity <span class="token string">&#x27;login_via_client&#x27;</span> is invoked.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,417<span class="token punctuation">]</span> kopf.activities.auth <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> Client is configured via kubeconfig file.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,418<span class="token punctuation">]</span> kopf.activities.auth <span class="token punctuation">[</span>INFO    <span class="token punctuation">]</span> Activity <span class="token string">&#x27;login_via_client&#x27;</span> succeeded.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,418<span class="token punctuation">]</span> kopf._core.engines.a <span class="token punctuation">[</span>INFO    <span class="token punctuation">]</span> Initial authentication has finished.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,464<span class="token punctuation">]</span> kopf._cogs.clients.w <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> Starting the watch-stream <span class="token keyword">for</span> customresourcedefinitions.v1.apiextensions.k8s.io cluster-wide.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,465<span class="token punctuation">]</span> kopf._cogs.clients.w <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> Starting the watch-stream <span class="token keyword">for</span> applications.v1.heumsi.github.io cluster-wide.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,573<span class="token punctuation">]</span> kopf.objects         <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> <span class="token punctuation">[</span>default/nginx<span class="token punctuation">]</span> Creation is <span class="token keyword">in</span> progress: <span class="token punctuation">{</span><span class="token string">&#x27;apiVersion&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;heumsi.github.io/v1&#x27;</span>, <span class="token string">&#x27;kind&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;Application&#x27;</span>, <span class="token string">&#x27;metadata&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&#x27;annotations&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&#x27;kubectl.kubernetes.io/last-applied-configuration&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;{&quot;apiVersion&quot;:&quot;heumsi.github.io/v1&quot;,&quot;kind&quot;:&quot;Application&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;image&quot;:&quot;nginx:latest&quot;,&quot;port&quot;:80,&quot;replicas&quot;:1}}\n&#x27;</span><span class="token punctuation">}</span>, <span class="token string">&#x27;creationTimestamp&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;2022-07-13T13:18:02Z&#x27;</span>, <span class="token string">&#x27;generation&#x27;</span><span class="token builtin class-name">:</span> <span class="token number">1</span>, <span class="token string">&#x27;managedFields&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&#x27;apiVersion&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;heumsi.github.io/v1&#x27;</span>, <span class="token string">&#x27;fieldsType&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;FieldsV1&#x27;</span>, <span class="token string">&#x27;fieldsV1&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&#x27;f:metadata&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&#x27;f:annotations&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&#x27;.&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>, <span class="token string">&#x27;f:kubectl.kubernetes.io/last-applied-configuration&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">&#x27;f:spec&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&#x27;.&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>, <span class="token string">&#x27;f:image&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>, <span class="token string">&#x27;f:port&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>, <span class="token string">&#x27;f:replicas&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>, <span class="token string">&#x27;manager&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;kubectl-client-side-apply&#x27;</span>, <span class="token string">&#x27;operation&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;Update&#x27;</span>, <span class="token string">&#x27;time&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;2022-07-13T13:18:02Z&#x27;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>, <span class="token string">&#x27;name&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;nginx&#x27;</span>, <span class="token string">&#x27;namespace&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;default&#x27;</span>, <span class="token string">&#x27;resourceVersion&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;79214&#x27;</span>, <span class="token string">&#x27;uid&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;f6f0f256-aaa8-4a42-83f2-3df27755ab06&#x27;</span><span class="token punctuation">}</span>, <span class="token string">&#x27;spec&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&#x27;image&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;nginx:latest&#x27;</span>, <span class="token string">&#x27;port&#x27;</span><span class="token builtin class-name">:</span> <span class="token number">80</span>, <span class="token string">&#x27;replicas&#x27;</span><span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,574<span class="token punctuation">]</span> kopf.objects         <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> <span class="token punctuation">[</span>default/nginx<span class="token punctuation">]</span> Handler <span class="token string">&#x27;create&#x27;</span> is invoked.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,574<span class="token punctuation">]</span> kopf.objects         <span class="token punctuation">[</span>INFO    <span class="token punctuation">]</span> <span class="token punctuation">[</span>default/nginx<span class="token punctuation">]</span> Application <span class="token string">&#x27;nginx&#x27;</span> is created.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,576<span class="token punctuation">]</span> kopf.objects         <span class="token punctuation">[</span>INFO    <span class="token punctuation">]</span> <span class="token punctuation">[</span>default/nginx<span class="token punctuation">]</span> Handler <span class="token string">&#x27;create&#x27;</span> succeeded.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,576<span class="token punctuation">]</span> kopf.objects         <span class="token punctuation">[</span>INFO    <span class="token punctuation">]</span> <span class="token punctuation">[</span>default/nginx<span class="token punctuation">]</span> Creation is processed: <span class="token number">1</span> succeeded<span class="token punctuation">;</span> <span class="token number">0</span> failed.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,577<span class="token punctuation">]</span> kopf.objects         <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> <span class="token punctuation">[</span>default/nginx<span class="token punctuation">]</span> Patching with: <span class="token punctuation">{</span><span class="token string">&#x27;metadata&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&#x27;annotations&#x27;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token string">&#x27;kopf.zalando.org/last-handled-configuration&#x27;</span><span class="token builtin class-name">:</span> <span class="token string">&#x27;{&quot;spec&quot;:{&quot;image&quot;:&quot;nginx:latest&quot;,&quot;port&quot;:80,&quot;replicas&quot;:1}}\n&#x27;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,690<span class="token punctuation">]</span> kopf.objects         <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> <span class="token punctuation">[</span>default/nginx<span class="token punctuation">]</span> Something has changed, but we are not interested <span class="token punctuation">(</span>the essence is the same<span class="token punctuation">)</span>.
<span class="token punctuation">[</span><span class="token number">2022</span>-07-13 <span class="token number">22</span>:18:08,690<span class="token punctuation">]</span> kopf.objects         <span class="token punctuation">[</span>DEBUG   <span class="token punctuation">]</span> <span class="token punctuation">[</span>default/nginx<span class="token punctuation">]</span> Handling cycle is finished, waiting <span class="token keyword">for</span> new changes.</code></pre></div><p>로그를 보면 핸들러에서 <code class="language-text">applications.heumsi.github.io</code> 리소스가 생성된 것을 감지하고 있다.</p><p>또한 생성된 CR의 Events에도 위 Operator가 작업한 이벤트가 기록된다.</p><div class="gatsby-highlight has-highlighted-lines" data-language="yaml"><pre class="language-yaml"><code class="language-yaml">$ kubectl describe app nginx

<span class="token key atrule">Name</span><span class="token punctuation">:</span>         nginx
<span class="token key atrule">Namespace</span><span class="token punctuation">:</span>    default
<span class="token key atrule">Labels</span><span class="token punctuation">:</span>       &lt;none<span class="token punctuation">&gt;</span>
<span class="token key atrule">Annotations</span><span class="token punctuation">:</span>  <span class="token key atrule">kopf.zalando.org/last-handled-configuration</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>&quot;spec&quot;<span class="token punctuation">:</span><span class="token punctuation">{</span>&quot;image&quot;<span class="token punctuation">:</span><span class="token string">&quot;nginx:latest&quot;</span><span class="token punctuation">,</span>&quot;port&quot;<span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">,</span>&quot;replicas&quot;<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">API Version</span><span class="token punctuation">:</span>  heumsi.github.io/v1
<span class="token key atrule">Kind</span><span class="token punctuation">:</span>         Application
<span class="token key atrule">Metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">Creation Timestamp</span><span class="token punctuation">:</span>  <span class="token datetime number">2022-07-10T06:45:11Z</span>
  <span class="token key atrule">Generation</span><span class="token punctuation">:</span>          <span class="token number">1</span>
  <span class="token key atrule">Managed Fields</span><span class="token punctuation">:</span>
    <span class="token key atrule">API Version</span><span class="token punctuation">:</span>  heumsi.github.io/v1
    <span class="token key atrule">Fields Type</span><span class="token punctuation">:</span>  FieldsV1
    <span class="token key atrule">fieldsV1</span><span class="token punctuation">:</span>
      <span class="token key atrule">f:metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">f:annotations</span><span class="token punctuation">:</span>
          <span class="token key atrule">.</span><span class="token punctuation">:</span>
          <span class="token key atrule">f:kubectl.kubernetes.io/last-applied-configuration</span><span class="token punctuation">:</span>
      <span class="token key atrule">f:spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">.</span><span class="token punctuation">:</span>
        <span class="token key atrule">f:image</span><span class="token punctuation">:</span>
        <span class="token key atrule">f:port</span><span class="token punctuation">:</span>
        <span class="token key atrule">f:replicas</span><span class="token punctuation">:</span>
    <span class="token key atrule">Manager</span><span class="token punctuation">:</span>      kubectl<span class="token punctuation">-</span>client<span class="token punctuation">-</span>side<span class="token punctuation">-</span>apply
    <span class="token key atrule">Operation</span><span class="token punctuation">:</span>    Update
    <span class="token key atrule">Time</span><span class="token punctuation">:</span>         <span class="token datetime number">2022-07-10T06:45:11Z</span>
    <span class="token key atrule">API Version</span><span class="token punctuation">:</span>  heumsi.github.io/v1
    <span class="token key atrule">Fields Type</span><span class="token punctuation">:</span>  FieldsV1
    <span class="token key atrule">fieldsV1</span><span class="token punctuation">:</span>
      <span class="token key atrule">f:metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">f:annotations</span><span class="token punctuation">:</span>
          <span class="token key atrule">f:kopf.zalando.org/last-handled-configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">Manager</span><span class="token punctuation">:</span>         kopf
    <span class="token key atrule">Operation</span><span class="token punctuation">:</span>       Update
    <span class="token key atrule">Time</span><span class="token punctuation">:</span>            <span class="token datetime number">2022-07-10T06:45:59Z</span>
  <span class="token key atrule">Resource Version</span><span class="token punctuation">:</span>  <span class="token number">3413</span>
  <span class="token key atrule">UID</span><span class="token punctuation">:</span>               289ff6b3<span class="token punctuation">-</span>29a1<span class="token punctuation">-</span>4896<span class="token punctuation">-</span>b8f3<span class="token punctuation">-</span>82c20c4a904e
<span class="token key atrule">Spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">Image</span><span class="token punctuation">:</span>     nginx<span class="token punctuation">:</span>latest
  <span class="token key atrule">Port</span><span class="token punctuation">:</span>      <span class="token number">80</span>
  <span class="token key atrule">Replicas</span><span class="token punctuation">:</span>  <span class="token number">1</span>
<span class="gatsby-highlight-code-line"><span class="token key atrule">Events</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">  Type    Reason   Age   From  Message</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">---</span><span class="token punctuation">-</span>    <span class="token punctuation">---</span><span class="token punctuation">---</span>   <span class="token punctuation">---</span><span class="token punctuation">-</span>  <span class="token punctuation">---</span><span class="token punctuation">-</span>  <span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span></span><span class="gatsby-highlight-code-line">  <span class="token key atrule">Normal  Logging  8s    kopf  Creation is processed</span><span class="token punctuation">:</span> 1 succeeded; 0 failed.</span><span class="gatsby-highlight-code-line">  Normal  Logging  8s    kopf  Handler &#x27;create_fn&#x27; succeeded.</span></code></pre></div><p>그러면 이제 <code class="language-text">main.py</code> 내 <code class="language-text">create</code> 함수 내에 Deployment와 Service를 배포하는 코드를 작성해보자.</p><p>코드에서 Kubernetes API를 Python SDK 형태로 쓰기 위해 다음 패키지를 설치한다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ pip <span class="token function">install</span> kubernetes
$ pip list <span class="token operator">|</span> <span class="token function">grep</span> kubernetes

kubernetes         <span class="token number">24.2</span>.0</code></pre></div><p><code class="language-text">main.py</code> 를 다음처럼 수정한다.</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os

<span class="token keyword">import</span> kopf

<span class="token keyword">import</span> kubernetes
<span class="token keyword">import</span> yaml


<span class="token decorator annotation punctuation">@kopf<span class="token punctuation">.</span>on<span class="token punctuation">.</span>create</span><span class="token punctuation">(</span><span class="token string">&#x27;heumsi.github.io&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;v1&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;applications&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> spec<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Application &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is created.&quot;</span></span><span class="token punctuation">)</span>
    kapps_v1 <span class="token operator">=</span> kubernetes<span class="token punctuation">.</span>client<span class="token punctuation">.</span>AppsV1Api<span class="token punctuation">(</span><span class="token punctuation">)</span>
    kcore_v1 <span class="token operator">=</span> kubernetes<span class="token punctuation">.</span>client<span class="token punctuation">.</span>CoreV1Api<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Create Deployment</span>
    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#x27;deployment.yaml&#x27;</span><span class="token punctuation">)</span>
    tmpl <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&#x27;rt&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    text <span class="token operator">=</span> tmpl<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> <span class="token operator">**</span>spec<span class="token punctuation">)</span>
    data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    kopf<span class="token punctuation">.</span>adopt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># Add as child</span>
    deployment <span class="token operator">=</span> kapps_v1<span class="token punctuation">.</span>create_namespaced_deployment<span class="token punctuation">(</span>
        namespace<span class="token operator">=</span>namespace<span class="token punctuation">,</span>
        body<span class="token operator">=</span>data
    <span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Deployment &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is created.&quot;</span></span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>deployment<span class="token punctuation">)</span>

    <span class="token comment"># Create Service</span>
    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#x27;service.yaml&#x27;</span><span class="token punctuation">)</span>
    tmpl <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&#x27;rt&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    text <span class="token operator">=</span> tmpl<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> <span class="token operator">**</span>spec<span class="token punctuation">)</span>
    data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    kopf<span class="token punctuation">.</span>adopt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># Add as child</span>
    service <span class="token operator">=</span> kcore_v1<span class="token punctuation">.</span>create_namespaced_service<span class="token punctuation">(</span>
        namespace<span class="token operator">=</span>namespace<span class="token punctuation">,</span>
        body<span class="token operator">=</span>data
    <span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Service &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is created.&quot;</span></span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>service<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;deployment&quot;</span><span class="token punctuation">:</span> deployment<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token string">&quot;service&quot;</span><span class="token punctuation">:</span> service<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    <span class="token punctuation">}</span></code></pre></div><p>별 다른 내용은 없고, <code class="language-text">kubernetes</code> 패키지로 Deployment와 Service를 생성하는 코드다.
<code class="language-text">tmpl.format(name=name, **spec)</code> 코드를 통해 이전에 작성한 <code class="language-text">deployment.yaml</code> 와 <code class="language-text">service.yaml</code> 에
<code class="language-text">name</code> 및 <code class="language-text">spec</code> 의 데이터를 주입하여 실제로 배포할 yaml 파일을 렌더링한다.
이후 <code class="language-text">kubernetes.client</code> 를 통해 이 yaml 파일을 배포한다.</p><blockquote><p><code class="language-text">kubernetes.client</code> 는 리소스의 <code class="language-text">apiVersion</code> 에 따라 나뉜다.
예를 들어 <code class="language-text">apiVersion</code> 이 <code class="language-text">v1</code> 인 리소스는 <code class="language-text">kubernetes.client.CoreV1Api</code> 를 사용하면 되고,
<code class="language-text">apiVersion</code> 이 <code class="language-text">apps/v1</code> 인 리소스는 <code class="language-text">kubernetes.client.AppsV1Api</code> 를 사용하면 된다.</p></blockquote><p>그리고 <code class="language-text">kopf.adopt(data)</code> 코드를 넣어주게 되면, 배포되는 yaml 파일은 이 CR의 자식 리소스가 된다.
즉, 이 CR이 지워질 때 자식 리소스(여기서는 Deployment와 Service)가 같이 지워지게 된다.</p><p>마지막에는 <code class="language-text">Dict</code> 를 반환하는데, Key, Value들은 CR의 <code class="language-text">status</code> 항목에 핸들러 함수 이름과 함께 저장된다.
이는 아래에서 CR 배포 후 확인해보자.</p><blockquote><p>이벤트 핸들러의 파라미터로 <code class="language-text">kwargs</code> 를 받게 되는데, 이 안에 이벤트에 대한 각종 정보들이 담겨있다.
<code class="language-text">kwargs</code> 에 어떤 정보가 있는지 직접 디버깅하며 스크린샷을 찍어보았다.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:590px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:67.56756756756756%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACSUlEQVQ4y22S2XLbMAxF9VWxJVsbxVWkZclxncRJmmXy1un0HzpNmn716ZBe2nT6cAYgSEAArjIx3iB3d4jpgdxsmesNM73hQm8ozIZCjVyIwKxbMe+GIwf/FJuJFY3/hB62ZNoGlmZEGYlxGmk61BFtBMYIlGqQqqEVZUKIirYtEV2FiOfu4PehJxN+YKYCi+kb5vkd9fkVdf+d8PIL+/QT8/iGeXpPVj++0j+/EV7e6Z9f0716eEU/vlHtfyB3X8nurtfsJkNudtTbL4zTC+34QjM80QzP5PaWubmlcHfk9o652ZObPUWM6326m+k9M32LXN2QXe8GtqOhaiomW3NjNVpLpJb40DOMA6shoLRCdIKyLlmWS4rlgkX5F8uCWgiysmmJFHXL1kuuXEBZj3IH3GqN8UPydR9QLlAJmd4vanGmqFqEtmR5WVNUDXndMnnFVSxkHdL2SOtolaGRCqFMSljULeecsj77kUZqsugsqoZ53eLCisl5OtvjwpCoO5WIjyOxaCs1rdJ0xiXifV42yT8XjB0G3xNsT2cdfhhTQdMHjD9wGls7n4rHbpeNSLao6rS67NRu3Mmub7l0HmFcKjRMl6lwGKdk/Xo6x6RxibiSTlsqoeiM/9ihC4HR9mgfCOvpvMeYqGK8D9RCpq7KtkviRBs5xf7ssGqpwoZdVPaobhwtJqXRjuPF9/NllcQ42b/50OEUNPd+hT/+MnHskxBJgKONnXfGJhvVP4kTP34uGP+jUlmUkEnFqFy8O43yP6p/znGS37ph/u69ubvCAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="1.png" title="1.png" src="/blog/static/a3ceabfcb0b980bfaec18bc85d7a2505/fcda8/1.png" srcSet="/blog/static/a3ceabfcb0b980bfaec18bc85d7a2505/12f09/1.png 148w,/blog/static/a3ceabfcb0b980bfaec18bc85d7a2505/e4a3f/1.png 295w,/blog/static/a3ceabfcb0b980bfaec18bc85d7a2505/fcda8/1.png 590w,/blog/static/a3ceabfcb0b980bfaec18bc85d7a2505/d4c13/1.png 825w" sizes="(max-width: 590px) 100vw, 590px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy" decoding="async"/>
    </span></p><p>다시 코드로 표현하면 다음과 같다.</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{
  &#x27;annotations&#x27;: {&#x27;kubectl.kubernetes.io/last-applied-configuration&#x27;: &#x27;{&quot;apiVersion&quot;:&quot;heumsi.github.io/v1&quot;,&quot;kind&quot;:&quot;Application&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;image&quot;:&quot;nginx:latest&quot;,&quot;port&quot;:80,&quot;replicas&quot;:1}}\n&#x27;},
  &#x27;diff&#x27;: ((&#x27;add&#x27;, (), None, {&#x27;spec&#x27;: {&#x27;image&#x27;: &#x27;nginx:latest&#x27;, &#x27;port&#x27;: 80, &#x27;replicas&#x27;: 1}}),),
  &#x27;labels&#x27;: {},
  &#x27;logger&#x27;: &lt;ObjectLogger kopf.objects (INFO)&gt;,
  &#x27;memo&#x27;: {},
  &#x27;meta&#x27;: {&#x27;annotations&#x27;: {&#x27;kubectl.kubernetes.io/last-applied-configuration&#x27;: &#x27;{&quot;apiVersion&quot;:&quot;heumsi.github.io/v1&quot;,&quot;kind&quot;:&quot;Application&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;nginx&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;image&quot;:&quot;nginx:latest&quot;,&quot;port&quot;:80,&quot;replicas&quot;:1}}\n&#x27;}, &#x27;creationTimestamp&#x27;: &#x27;2022-07-10T08:10:10Z&#x27;, &#x27;generation&#x27;: 1, &#x27;managedFields&#x27;: [{&#x27;apiVersion&#x27;: &#x27;heumsi.github.io/v1&#x27;, &#x27;fieldsType&#x27;: &#x27;FieldsV1&#x27;, &#x27;fieldsV1&#x27;: {&#x27;f:metadata&#x27;: {&#x27;f:annotations&#x27;: {&#x27;.&#x27;: {}, &#x27;f:kubectl.kubernetes.io/last-applied-configuration&#x27;: {}}}, &#x27;f:spec&#x27;: {&#x27;.&#x27;: {}, &#x27;f:image&#x27;: {}, &#x27;f:port&#x27;: {}, &#x27;f:replicas&#x27;: {}}}, &#x27;manager&#x27;: &#x27;kubectl-client-side-apply&#x27;, &#x27;operation&#x27;: &#x27;Update&#x27;, &#x27;time&#x27;: &#x27;2022-07-10T08:10:10Z&#x27;}], &#x27;name&#x27;: &#x27;nginx&#x27;, &#x27;namespace&#x27;: &#x27;default&#x27;, &#x27;resourceVersion&#x27;: &#x27;9488&#x27;, &#x27;uid&#x27;: &#x27;f66918a2-31d7-4dff-8a77-5c7434ee7d26&#x27;},
  &#x27;name&#x27;: &#x27;nginx&#x27;,
  &#x27;namespace&#x27;: &#x27;default&#x27;,
  &#x27;new&#x27;: {&#x27;spec&#x27;: {&#x27;image&#x27;: &#x27;nginx:latest&#x27;, &#x27;port&#x27;: 80, &#x27;replicas&#x27;: 1}},
  &#x27;old&#x27;: None,
  &#x27;param&#x27;: None,
  &#x27;patch&#x27;: {},
  &#x27;reason&#x27;: &lt;Reason.CREATE: &#x27;create&#x27;&gt;,
  &#x27;resource&#x27;: applications.v1.heumsi.github.io,
  &#x27;retry&#x27;: 0,
  &#x27;runtime&#x27;: datetime.timedelta(microseconds=447),
  &#x27;spec&#x27;: {&#x27;image&#x27;: &#x27;nginx:latest&#x27;, &#x27;port&#x27;: 80, &#x27;replicas&#x27;: 1},
  &#x27;started&#x27;: datetime.datetime(2022, 7, 10, 8, 10, 11, 102275),
  &#x27;status&#x27;: {},
  &#x27;uid&#x27;: &#x27;f66918a2-31d7-4dff-8a77-5c7434ee7d26&#x27;
}</code></pre></div><p>핸들러에서 이 <code class="language-text">kwargs</code> 내 key들을 파라미터로 두고 사용할 수 있다.
우리가 위에서 사용한 <code class="language-text">name</code>, <code class="language-text">logger</code> 등이 바로 이 안에 포함된 key라고 보면 된다.</p></blockquote><p>이제 Operator도 다시 실행하고, CR도 지웠다가 다시 생성해보자.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kopf run main.py --verbose</code></pre></div><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl delete -f application.yaml
        
application.heumsi.github.io <span class="token string">&quot;nginx&quot;</span> deleted

$ kubectl apply -f application.yaml

application.heumsi.github.io/nginx created</code></pre></div><p>이제 정상적으로 CR(Application)와 Deployment, Service가 잘 배포되었는지 확인해보자.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get app

NAME    AGE
nginx   20s

$ kubectl get deployment

NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           24s

$ kubectl get <span class="token function">service</span>                   

NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   3d8h
nginx        ClusterIP   <span class="token number">10.96</span>.249.187   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    27s</code></pre></div><p>잘 배포된 것을 확인했다.</p><p>배포된 Deployment를 확인해보면 다음처럼 <code class="language-text">ownerReferences</code> 에 CR이 설정된 것을 확인할 수 있다.
이는 Deployment의 상위 리소스가 CR이라는 표현으로, <code class="language-text">kopf.adopt(data)</code> 코드에 의해 생성된 것이다.</p><div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get deploy nginx -o yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  <span class="token punctuation">..</span>.
<span class="gatsby-highlight-code-line">  ownerReferences:</span><span class="gatsby-highlight-code-line">  - apiVersion: heumsi.github.io/v1</span><span class="gatsby-highlight-code-line">    blockOwnerDeletion: <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">    controller: <span class="token boolean">true</span></span><span class="gatsby-highlight-code-line">    kind: Application</span><span class="gatsby-highlight-code-line">    name: nginx</span><span class="gatsby-highlight-code-line">    uid: 963a4fd2-effe-4c5e-bdcf-c089a3ea9480</span>  <span class="token punctuation">..</span>.
spec:
  <span class="token punctuation">..</span>.</code></pre></div><p>한편 핸들러에서 반환한 <code class="language-text">Dict</code> 데이터도 CR의 <code class="language-text">status</code> 에 잘 저장되었는지 확인해보자.</p><div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get app nginx -o yaml

apiVersion: heumsi.github.io/v1
kind: Application
metadata:
  annotations:
    kopf.zalando.org/last-handled-configuration: <span class="token operator">|</span>
      <span class="token punctuation">{</span><span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx:latest&quot;</span>,<span class="token string">&quot;port&quot;</span>:8080,<span class="token string">&quot;replicas&quot;</span>:2<span class="token punctuation">}</span><span class="token punctuation">}</span>
    kubectl.kubernetes.io/last-applied-configuration: <span class="token operator">|</span>
      <span class="token punctuation">{</span><span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;heumsi.github.io/v1&quot;</span>,<span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Application&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;annotations&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx&quot;</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx:latest&quot;</span>,<span class="token string">&quot;port&quot;</span>:80,<span class="token string">&quot;replicas&quot;</span>:1<span class="token punctuation">}</span><span class="token punctuation">}</span>
  creationTimestamp: <span class="token string">&quot;2022-07-13T14:55:53Z&quot;</span>
  generation: <span class="token number">4</span>
  name: nginx
  namespace: default
  resourceVersion: <span class="token string">&quot;82893&quot;</span>
  uid: 1b31a0d8-81e6-4671-a8b4-f54ace7f101c
spec:
  image: nginx:latest
  port: <span class="token number">8080</span>
  replicas: <span class="token number">2</span>
<span class="gatsby-highlight-code-line">status:</span><span class="gatsby-highlight-code-line">  create:</span><span class="gatsby-highlight-code-line">    deployment: nginx</span><span class="gatsby-highlight-code-line">    service: nginx</span></code></pre></div><p><code class="language-text">status.create</code> 내에 데이터가 잘 저장된 것을 확인했다.</p><h3 id="cr-수정-이벤트-핸들러-작성하기" style="position:relative"><a href="#cr-%EC%88%98%EC%A0%95-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%ED%95%B8%EB%93%A4%EB%9F%AC-%EC%9E%91%EC%84%B1%ED%95%98%EA%B8%B0" aria-label="cr 수정 이벤트 핸들러 작성하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CR 수정 이벤트 핸들러 작성하기</h3><p>위에서는 CR이 생성되었을 때 동작하는 핸들러를 작성했다.
이번에는 CR이 수정될 때 동작하는 핸들러를 작성해보자.</p><p><code class="language-text">main.py</code> 를 다음처럼 수정한다.</p><div class="gatsby-highlight has-highlighted-lines" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os

<span class="token keyword">import</span> kopf

<span class="token keyword">import</span> kubernetes
<span class="token keyword">import</span> yaml


<span class="token decorator annotation punctuation">@kopf<span class="token punctuation">.</span>on<span class="token punctuation">.</span>create</span><span class="token punctuation">(</span><span class="token string">&#x27;heumsi.github.io&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;v1&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;applications&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> spec<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Application &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is created.&quot;</span></span><span class="token punctuation">)</span>
    kapps_v1 <span class="token operator">=</span> kubernetes<span class="token punctuation">.</span>client<span class="token punctuation">.</span>AppsV1Api<span class="token punctuation">(</span><span class="token punctuation">)</span>
    kcore_v1 <span class="token operator">=</span> kubernetes<span class="token punctuation">.</span>client<span class="token punctuation">.</span>CoreV1Api<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Create Deployment</span>
    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#x27;deployment.yaml&#x27;</span><span class="token punctuation">)</span>
    tmpl <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&#x27;rt&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    text <span class="token operator">=</span> tmpl<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> <span class="token operator">**</span>spec<span class="token punctuation">)</span>
    data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    kopf<span class="token punctuation">.</span>adopt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># Add as child</span>
    deployment <span class="token operator">=</span> kapps_v1<span class="token punctuation">.</span>create_namespaced_deployment<span class="token punctuation">(</span>
        namespace<span class="token operator">=</span>namespace<span class="token punctuation">,</span>
        body<span class="token operator">=</span>data
    <span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Deployment &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is created.&quot;</span></span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>deployment<span class="token punctuation">)</span>

    <span class="token comment"># Create Service</span>
    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#x27;service.yaml&#x27;</span><span class="token punctuation">)</span>
    tmpl <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&#x27;rt&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    text <span class="token operator">=</span> tmpl<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> <span class="token operator">**</span>spec<span class="token punctuation">)</span>
    data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    kopf<span class="token punctuation">.</span>adopt<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># Add as child</span>
    service <span class="token operator">=</span> kcore_v1<span class="token punctuation">.</span>create_namespaced_service<span class="token punctuation">(</span>
        namespace<span class="token operator">=</span>namespace<span class="token punctuation">,</span>
        body<span class="token operator">=</span>data
    <span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Service &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is created.&quot;</span></span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>service<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;deployment&quot;</span><span class="token punctuation">:</span> deployment<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token string">&quot;service&quot;</span><span class="token punctuation">:</span> service<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>


<span class="gatsby-highlight-code-line"><span class="token decorator annotation punctuation">@kopf<span class="token punctuation">.</span>on<span class="token punctuation">.</span>update</span><span class="token punctuation">(</span><span class="token string">&#x27;heumsi.github.io&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;v1&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;applications&#x27;</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"><span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> status<span class="token punctuation">,</span> spec<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span><span class="gatsby-highlight-code-line">    kapps_v1 <span class="token operator">=</span> kubernetes<span class="token punctuation">.</span>client<span class="token punctuation">.</span>AppsV1Api<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    kcore_v1 <span class="token operator">=</span> kubernetes<span class="token punctuation">.</span>client<span class="token punctuation">.</span>CoreV1Api<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    </span><span class="gatsby-highlight-code-line">    <span class="token comment"># Update Deployment</span></span><span class="gatsby-highlight-code-line">    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#x27;deployment.yaml&#x27;</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    tmpl <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&#x27;rt&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    text <span class="token operator">=</span> tmpl<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> <span class="token operator">**</span>spec<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>text<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    deployment <span class="token operator">=</span> kapps_v1<span class="token punctuation">.</span>replace_namespaced_deployment<span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        name<span class="token operator">=</span>status<span class="token punctuation">[</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;deployment&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        namespace<span class="token operator">=</span>namespace<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        body<span class="token operator">=</span>data</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Deployment &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is replaced.&quot;</span></span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>deployment<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    </span><span class="gatsby-highlight-code-line">    <span class="token comment"># Update Service</span></span><span class="gatsby-highlight-code-line">    path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#x27;service.yaml&#x27;</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    tmpl <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&#x27;rt&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    text <span class="token operator">=</span> tmpl<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> <span class="token operator">**</span>spec<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    data <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>text<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    service <span class="token operator">=</span> kcore_v1<span class="token punctuation">.</span>replace_namespaced_service<span class="token punctuation">(</span></span><span class="gatsby-highlight-code-line">        name<span class="token operator">=</span>status<span class="token punctuation">[</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        namespace<span class="token operator">=</span>namespace<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        body<span class="token operator">=</span>data</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Service &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is replaced.&quot;</span></span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>service<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line"></span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">        <span class="token string">&quot;deployment&quot;</span><span class="token punctuation">:</span> deployment<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">        <span class="token string">&quot;service&quot;</span><span class="token punctuation">:</span> service<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>name<span class="token punctuation">,</span></span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span></span></code></pre></div><p>새로 추가한 <code class="language-text">update</code> 함수는 <code class="language-text">create</code> 함수와 별로 다르지 않다.
중간에 <code class="language-text">create_namespaced_deployment</code>, <code class="language-text">create_namespaced_service</code> 대신 <code class="language-text">replace_namespaced_deployment</code>, <code class="language-text">replace_namespaced_service</code> 로 변경되었을 뿐이다.
또 <code class="language-text">kopf.adopt(data)</code> 와 같은 코드는 빠졌다.</p><p>CR을 수정했을 때 잘 반영되는지 확인해보자.</p><p>이제 다시 Operator를 실행한다. </p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kopf run main.py --verbose</code></pre></div><p>CR의 스펙 중, <code class="language-text">port</code> 값은 <code class="language-text">8080</code> 으로, <code class="language-text">replicas</code> 는 <code class="language-text">2</code>로 수정한다.</p><div class="gatsby-highlight has-highlighted-lines" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl edit app nginx

apiVersion: heumsi.github.io/v1
kind: Application
metadata:
  annotations:
    kopf.zalando.org/last-handled-configuration: <span class="token operator">|</span>
      <span class="token punctuation">{</span><span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx:latest&quot;</span>,<span class="token string">&quot;port&quot;</span>:8080,<span class="token string">&quot;replicas&quot;</span>:2<span class="token punctuation">}</span><span class="token punctuation">}</span>
    kubectl.kubernetes.io/last-applied-configuration: <span class="token operator">|</span>
      <span class="token punctuation">{</span><span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;heumsi.github.io/v1&quot;</span>,<span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Application&quot;</span>,<span class="token string">&quot;metadata&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;annotations&quot;</span>:<span class="token punctuation">{</span><span class="token punctuation">}</span>,<span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx&quot;</span>,<span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">}</span>,<span class="token string">&quot;spec&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;image&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;nginx:latest&quot;</span>,<span class="token string">&quot;port&quot;</span>:80,<span class="token string">&quot;replicas&quot;</span>:1<span class="token punctuation">}</span><span class="token punctuation">}</span>
  creationTimestamp: <span class="token string">&quot;2022-07-13T14:55:53Z&quot;</span>
  generation: <span class="token number">4</span>
  name: nginx
  namespace: default
  resourceVersion: <span class="token string">&quot;82893&quot;</span>
  uid: 1b31a0d8-81e6-4671-a8b4-f54ace7f101c
spec:
  image: nginx:latest
<span class="gatsby-highlight-code-line">  port: <span class="token number">8080</span></span><span class="gatsby-highlight-code-line">  replicas: <span class="token number">2</span></span>status:
  create:
    deployment: nginx
    service: nginx
  update:
    deployment: nginx
    service: nginx</code></pre></div><p>잘 반영되었는지 확인해보자.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get deployment nginx

NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           10m

$ kubectl get <span class="token function">service</span> nginx

NAME    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
nginx   ClusterIP   <span class="token number">10.96</span>.249.187   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>/TCP   10m</code></pre></div><p>잘 반영된 것을 확인할 수 있다.</p><blockquote><p>특정 Field만 변경 사항을 감지한다거나, 서브 핸들러를 두는 등의 일들도 할 수 있다.
이에 대한 자세한 내용은 <a href="https://kopf.readthedocs.io/en/stable/handlers/">공식 문서</a>를 확인하자.</p></blockquote><h3 id="cr-삭제하기" style="position:relative"><a href="#cr-%EC%82%AD%EC%A0%9C%ED%95%98%EA%B8%B0" aria-label="cr 삭제하기 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CR 삭제하기</h3><p>이제 생성했던 CR을 삭제해보자.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl delete app nginx  
       
application.heumsi.github.io <span class="token string">&quot;nginx&quot;</span> deleted</code></pre></div><p>그러면 다음처럼 자식 리소스들도 모두 삭제된 것을 확인할 수 있다.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">$ kubectl get svc  
       
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   8h

$ kubectl get deployment

No resources found <span class="token keyword">in</span> default namespace.</code></pre></div><p>위에서도 말했지만, 이는 CR 생성 시 <code class="language-text">kopf.adopt(data)</code> 코드로 자식 리소스에 <code class="language-text">ownerReferences</code> 를 주었기 때문에 가능한 것이다.</p><h2 id="나가며" style="position:relative"><a href="#%EB%82%98%EA%B0%80%EB%A9%B0" aria-label="나가며 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>나가며</h2><p>이번 글에서는 CRD 작성 방법과 kopf로 Operator를 구현하는 방법에 대해 배웠다.
이 글에서는 CRD와 kopf를 같이 이야기했는데 kopf를 쓰기 위해 꼭 CRD를 사용해야하는 것은 아니다.
예를 들면 다음처럼 CR이 아닌 네임스페이스가 생성되었을 때 일련의 로직을 처리하는 것도 kopf를 사용하는 방법 중 하나다.</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> kopf


<span class="token decorator annotation punctuation">@kopf<span class="token punctuation">.</span>on<span class="token punctuation">.</span>create</span><span class="token punctuation">(</span><span class="token string">&#x27;namespace&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&quot;Namespace &#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">&#x27; is created.&quot;</span></span><span class="token punctuation">)</span></code></pre></div><p>Kuberentes를 도입한 초기에는 CRD를 직접 작성하거나 kopf로 Operator를 당장 만들 일은 잘 없을거 같다.
어느정도 우리 팀만의 운영 패턴이 잡히고, 이를 추상화하여 더 편하고 자동화하여 쓰고 싶을 때 kopf를 아주 유용하게 사용할 수 있을거란 생각이 든다.</p><blockquote><p>kopf는 내부적으로 어떻게 동작하는지 궁금해서 알아보려 했지만, 공식 문서에 설명이 별로 없어서 유감스럽지만 패스한다.
이 글을 본 누군가가 이에 대해서도 작성해주셨으면 좋겠다.</p></blockquote><h2 id="참고한-글" style="position:relative"><a href="#%EC%B0%B8%EA%B3%A0%ED%95%9C-%EA%B8%80" aria-label="참고한 글 permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>참고한 글</h2><ul><li><a href="https://blog.naver.com/alice_k106/221579974362">https://blog.naver.com/alice_k106/221579974362</a></li><li><a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/">https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/</a></li><li><a href="https://kopf.readthedocs.io/en/stable/">https://kopf.readthedocs.io/en/stable/</a></li></ul></div><div id="disqus_thread"></div></main><footer><ul class="external-links"><li><a href="https://www.facebook.com/heumsi/"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="facebook" class="svg-inline--fa fa-facebook " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.8 90.69 226.4 209.3 245V327.7h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.3 482.4 504 379.8 504 256z"></path></svg></a></li><li><a href="https://www.linkedin.com/in/siheum-jeon-04222a1b3/"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li><a href="https://github.com/heumsi/"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3 .3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5 .3-6.2 2.3zm44.2-1.7c-2.9 .7-4.9 2.6-4.6 4.9 .3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3 .7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3 .3 2.9 2.3 3.9 1.6 1 3.6 .7 4.3-.7 .7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3 .7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3 .7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li><a href="https://bit.ly/3zAT8Ab"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="file-lines" class="svg-inline--fa fa-file-lines " role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M256 0v128h128L256 0zM224 128L224 0H48C21.49 0 0 21.49 0 48v416C0 490.5 21.49 512 48 512h288c26.51 0 48-21.49 48-48V160h-127.1C238.3 160 224 145.7 224 128zM272 416h-160C103.2 416 96 408.8 96 400C96 391.2 103.2 384 112 384h160c8.836 0 16 7.162 16 16C288 408.8 280.8 416 272 416zM272 352h-160C103.2 352 96 344.8 96 336C96 327.2 103.2 320 112 320h160c8.836 0 16 7.162 16 16C288 344.8 280.8 352 272 352zM288 272C288 280.8 280.8 288 272 288h-160C103.2 288 96 280.8 96 272C96 263.2 103.2 256 112 256h160C280.8 256 288 263.2 288 272z"></path></svg></a></li></ul><p class="copy-right">@ heumsi</p></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/posts/crd-and-kopf-tutorial/";window.___webpackCompilationHash="9023d6fb65f6071942db";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-4aa291e7e6681714b3e8.js"],"app":["/app-c321c5efdf12999a1dd7.js"],"component---src-components-templates-log-js":["/component---src-components-templates-log-js-8be2b192cec9967ef4ea.js"],"component---src-components-templates-post-js":["/component---src-components-templates-post-js-d80014afc9ad124b5ee3.js"],"component---src-pages-404-js":["/component---src-pages-404-js-5ed0d86fb0763a04a4b4.js"],"component---src-pages-index-js":["/component---src-pages-index-js-67136b30be5717c21631.js"],"component---src-pages-logs-index-js":["/component---src-pages-logs-index-js-bf19e8f568991d11bb86.js"],"component---src-pages-posts-index-js":["/component---src-pages-posts-index-js-2779df3cf8aef25ec545.js"]};/*]]>*/</script><script src="/blog/polyfill-4aa291e7e6681714b3e8.js" nomodule=""></script><script src="/blog/app-c321c5efdf12999a1dd7.js" async=""></script><script src="/blog/framework-c9b92197cbae3c33e091.js" async=""></script><script src="/blog/webpack-runtime-d16735df36b4c0712223.js" async=""></script></body></html>